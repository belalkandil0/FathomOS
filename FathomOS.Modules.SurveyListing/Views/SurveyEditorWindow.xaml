<mah:MetroWindow x:Class="FathomOS.Modules.SurveyListing.Views.SurveyEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:oxy="http://oxyplot.org/wpf"
        Title="Survey Editor" Height="950" Width="1500"
        WindowState="Maximized"
        WindowStartupLocation="CenterScreen"
        TitleCharacterCasing="Normal"
        GlowBrush="{DynamicResource MahApps.Brushes.Accent}"
        BorderThickness="1"
        SaveWindowPosition="True"
        Loaded="Window_Loaded"
        Closing="Window_Closing"
        RenderOptions.BitmapScalingMode="HighQuality"
        RenderOptions.CachingHint="Cache"
        RenderOptions.ClearTypeHint="Enabled"
        UseLayoutRounding="True"
        SnapsToDevicePixels="True">
    
    <mah:MetroWindow.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Controls.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Fonts.xaml" />
                <ResourceDictionary Source="pack://application:,,,/MahApps.Metro;component/Styles/Themes/Dark.Blue.xaml" />
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        </ResourceDictionary>
    </mah:MetroWindow.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" Padding="5">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Main Toolbar Row -->
                <WrapPanel Grid.Row="0">
                    <!-- Tool Selection -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,15,0">
                        <TextBlock Text="Tool:" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <RadioButton x:Name="ToolPan" Content="ðŸ–ï¸ Pan" IsChecked="True" Margin="0,0,5,0" 
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                        <RadioButton x:Name="ToolSelect" Content="â¬š Select" Margin="0,0,5,0"
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                        <RadioButton x:Name="ToolDigitize" Content="âœï¸ Digitize" Margin="0,0,5,0"
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                        <Button x:Name="BtnCreatePolyline" Content="ðŸ“ Polyline" ToolTip="Create polyline from selected points" Margin="0,0,5,0"
                                Padding="8,4" Click="CreatePolylineFromSelection_Click"/>
                        <RadioButton x:Name="ToolMeasure" Content="ðŸ“ Measure" Margin="0,0,5,0"
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                        <RadioButton x:Name="ToolInsert" Content="â¬› Insert" Margin="0,0,5,0"
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                        <RadioButton x:Name="ToolMeasureInterval" Content="ðŸ“ MEASURE" ToolTip="Place points at intervals (AutoCAD MEASURE)"
                                     Style="{StaticResource {x:Type ToggleButton}}" Padding="8,4" Click="Tool_Click"/>
                    </StackPanel>
                    
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                    
                    <!-- View Controls -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,15,0">
                        <Button Content="ðŸ”+" ToolTip="Zoom In" Padding="8,4" Margin="0,0,3,0" Click="ZoomIn_Click"/>
                        <Button Content="ðŸ”âˆ’" ToolTip="Zoom Out" Padding="8,4" Margin="0,0,3,0" Click="ZoomOut_Click"/>
                        <Button Content="âŠ¡ Fit" ToolTip="Zoom to Fit" Padding="8,4" Margin="0,0,3,0" Click="ZoomFit_Click"/>
                        <Button Content="1:1" ToolTip="Actual Size" Padding="8,4" Margin="0,0,10,0" Click="ZoomActual_Click"/>
                        <ToggleButton x:Name="BtnToggleProfile" Content="ðŸ“Š Profile" ToolTip="Toggle Profile View (Plan + Section)"
                                      Padding="8,4" Click="ToggleProfileView_Click"/>
                    </StackPanel>
                    
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                    
                    <!-- Point Editing -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,15,0">
                        <Button x:Name="BtnAddPoint" Content="âž• Add Point" ToolTip="Add Point at Cursor" 
                                Padding="8,4" Margin="0,0,3,0" Click="AddPoint_Click"/>
                        <Button x:Name="BtnDeleteSelected" Content="ðŸ—‘ï¸ Delete" ToolTip="Delete Selected" 
                                Padding="8,4" Margin="0,0,3,0" Click="DeleteSelected_Click" IsEnabled="False"/>
                        <Button x:Name="BtnResetSelected" Content="â†©ï¸ Reset" ToolTip="Reset Selected to Original" 
                                Padding="8,4" Margin="0,0,3,0" Click="ResetSelected_Click" IsEnabled="False"/>
                        <Button x:Name="BtnUndo" Content="â†¶ Undo" ToolTip="Undo (Ctrl+Z)" 
                                Padding="8,4" Margin="0,0,3,0" Click="Undo_Click" IsEnabled="False"/>
                        <Button x:Name="BtnRedo" Content="â†· Redo" ToolTip="Redo (Ctrl+Y)" 
                                Padding="8,4" Margin="0,0,3,0" Click="Redo_Click" IsEnabled="False"/>
                    </StackPanel>
                    
                    <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                    
                    <!-- Apply/Export/3D -->
                    <StackPanel Orientation="Horizontal">
                        <Button Content="âœ“ Apply Changes" Padding="10,4" Background="#4CAF50" Foreground="White"
                                Margin="0,0,5,0" Click="ApplyChanges_Click" ToolTip="Apply all changes and sync to Step 6 data"/>
                        <Button Content="ðŸ“Š Charts" Padding="10,4" Background="#673AB7" Foreground="White"
                                Margin="0,0,5,0" Click="ShowCharts_Click"/>
                        <Button Content="ðŸŽ² 3D View" Padding="10,4" Background="#9C27B0" Foreground="White"
                                Margin="0,0,5,0" Click="Show3DView_Click"/>
                        <Button Content="ðŸ“¤ CAD Export" Padding="10,4" Background="#FF5722" Foreground="White"
                                Margin="0,0,5,0" Click="ExportCadScript_Click" ToolTip="Export selected layers to CAD script"/>
                        <Button Content="â“ Help" Padding="10,4" Background="#607D8B" Foreground="White"
                                Click="ShowHelp_Click" ToolTip="Show keyboard shortcuts (H or F1)"/>
                    </StackPanel>
                </WrapPanel>
                
                <!-- Snap Options Row -->
                <Border Grid.Row="1" Background="{DynamicResource PanelBackgroundBrush}" Margin="0,5,0,0" Padding="5">
                    <WrapPanel>
                        <TextBlock Text="Snap:" VerticalAlignment="Center" Margin="0,0,8,0" FontWeight="SemiBold"/>
                        <CheckBox x:Name="ChkSnapEnabled" Content="Enable" IsChecked="True" Margin="0,0,10,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapEndpoint" Content="Endpoint" IsChecked="True" Margin="0,0,8,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapMidpoint" Content="Midpoint" IsChecked="True" Margin="0,0,8,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapNearest" Content="Nearest" IsChecked="True" Margin="0,0,8,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapIntersection" Content="Intersection" IsChecked="False" Margin="0,0,8,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapGrid" Content="Grid" IsChecked="False" Margin="0,0,8,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        <CheckBox x:Name="ChkSnapPerpendicular" Content="Perpendicular" IsChecked="False" Margin="0,0,15,0" 
                                  VerticalAlignment="Center" Click="SnapOption_Changed"/>
                        
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0"/>
                        
                        <TextBlock Text="Grid Size:" VerticalAlignment="Center" Margin="10,0,5,0"/>
                        <TextBox x:Name="TxtGridSnapSize" Text="10" Width="50" VerticalAlignment="Center"/>
                        
                        <TextBlock Text="Snap Radius:" VerticalAlignment="Center" Margin="15,0,5,0"/>
                        <TextBox x:Name="TxtSnapRadius" Text="15" Width="40" VerticalAlignment="Center"/>
                        <TextBlock Text="px" VerticalAlignment="Center" Margin="3,0,0,0" 
                                   Foreground="{DynamicResource SecondaryTextBrush}"/>
                    </WrapPanel>
                </Border>
                
                <!-- Draw Mode Panel (visible when Polyline tool is selected) -->
                <Border x:Name="DrawModePanel" Grid.Row="2" Background="{DynamicResource AccentBrush}" 
                        Margin="0,2,0,0" Padding="8" Visibility="Collapsed">
                    <WrapPanel>
                        <TextBlock Text="Draw Mode:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold" Foreground="White"/>
                        <RadioButton x:Name="RbPolyline2D" Content="Polyline 2D" IsChecked="True" Margin="0,0,15,0" 
                                     Foreground="White" VerticalAlignment="Center" GroupName="DrawMode"/>
                        <RadioButton x:Name="RbPolyline3D" Content="Polyline 3D" Margin="0,0,15,0" 
                                     Foreground="White" VerticalAlignment="Center" GroupName="DrawMode"/>
                        
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0" Background="White"/>
                        
                        <TextBlock Text="Z Value:" VerticalAlignment="Center" Margin="10,0,5,0" Foreground="White"/>
                        <ComboBox x:Name="CboZValueSource" SelectedIndex="0" Width="160" VerticalAlignment="Center"
                                  SelectionChanged="CboZValueSource_SelectionChanged" ToolTip="Select Z value source for 3D polylines">
                            <ComboBoxItem Content="Processed Depth (Step 6)" Tag="ProcessedDepth" ToolTip="Latest depth after DAL, tide, smoothing"/>
                            <ComboBoxItem Content="Processed Altitude" Tag="ProcessedAltitude" ToolTip="Latest altitude after smoothing"/>
                            <ComboBoxItem Content="Pick from Point" Tag="PickFromPoint" ToolTip="Click on a point to sample its Z value"/>
                            <ComboBoxItem Content="Manual Entry" Tag="Manual" ToolTip="Enter a fixed Z value manually"/>
                        </ComboBox>
                        <TextBox x:Name="TxtManualZ" Text="0.00" Width="60" Margin="5,0,0,0" VerticalAlignment="Center"
                                 IsEnabled="False" ToolTip="Manual Z value (enabled when Manual selected)"/>
                        <TextBlock Text="m" VerticalAlignment="Center" Margin="3,0,15,0" Foreground="White"/>
                        
                        <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="5,0" Background="White"/>
                        
                        <TextBlock x:Name="TxtPolylineStatus" Text="Click to start polyline..." VerticalAlignment="Center" 
                                   Foreground="White" Margin="10,0,15,0" FontStyle="Italic"/>
                        
                        <Button x:Name="BtnFinishPolyline" Content="âœ“ Finish" Padding="8,3" Margin="0,0,5,0" 
                                Click="FinishPolyline_Click" IsEnabled="False" ToolTip="Finish polyline (Enter)"/>
                        <Button x:Name="BtnClosePolyline" Content="â­• Close" Padding="8,3" Margin="0,0,5,0"
                                Click="ClosePolyline_Click" IsEnabled="False" ToolTip="Close polyline (C)"/>
                        <Button x:Name="BtnCancelPolyline" Content="âœ• Cancel" Padding="8,3"
                                Click="CancelPolyline_Click" ToolTip="Cancel polyline (Escape)"/>
                    </WrapPanel>
                </Border>
            </Grid>
        </Border>
        
        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition x:Name="LeftPanelColumn" Width="250" MinWidth="0"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition x:Name="RightPanelColumn" Width="300" MinWidth="0"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left Panel - Layers -->
            <Border x:Name="LeftPanel" Grid.Column="0" Background="{DynamicResource PanelBackgroundBrush}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" Padding="10,8">
                        <Grid>
                            <TextBlock Text="ðŸ“‚ Layers" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <Button Content="âž•" ToolTip="Add New Layer" Padding="4,2" 
                                        Click="AddLayer_Click" Margin="0,0,3,0"/>
                                <Button Content="ðŸ“‹" ToolTip="Duplicate Selected Layer" Padding="4,2" 
                                        Click="DuplicateLayer_Click" Margin="0,0,3,0"/>
                                <Button x:Name="BtnDeleteLayer" Content="ðŸ—‘ï¸" ToolTip="Delete Selected Layer" 
                                        Padding="4,2" Click="DeleteLayer_Click" IsEnabled="False"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                    
                    <ListBox x:Name="LayerList" Grid.Row="1" Background="Transparent"
                             ItemsSource="{Binding Layers}" SelectionChanged="LayerList_SelectionChanged">
                        <ListBox.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Duplicate Layer" Click="DuplicateLayer_Click"/>
                                <MenuItem Header="Delete Layer" Click="DeleteLayer_Click"/>
                                <Separator/>
                                <MenuItem Header="Change Color" Click="ChangeLayerColor_Click"/>
                                <MenuItem Header="Rename Layer" Click="RenameLayer_Click"/>
                            </ContextMenu>
                        </ListBox.ContextMenu>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="5" Margin="2" CornerRadius="3"
                                        Background="{DynamicResource PanelBackgroundBrush}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <CheckBox Grid.Column="0" IsChecked="{Binding IsVisible}" 
                                                  Margin="0,0,5,0" VerticalAlignment="Center"/>
                                        
                                        <Border Grid.Column="1" Width="20" Height="20" CornerRadius="3"
                                                Background="{Binding ColorBrush}" Margin="0,0,8,0"
                                                Cursor="Hand" MouseLeftButtonDown="LayerColor_Click"
                                                ToolTip="Click to change color" Tag="{Binding}"/>
                                        
                                        <!-- Layer name - double-click to rename -->
                                        <TextBlock Grid.Column="2" Text="{Binding Name}" 
                                                   VerticalAlignment="Center" TextTrimming="CharacterEllipsis"
                                                   Cursor="Hand" Tag="{Binding}"
                                                   MouseLeftButtonDown="LayerName_MouseDown"
                                                   ToolTip="Double-click to rename"/>
                                        
                                        <TextBlock Grid.Column="3" Text="â˜…" Foreground="#FFD700" 
                                                   VerticalAlignment="Center" Margin="5,0"
                                                   Visibility="{Binding IsUserCreated, Converter={StaticResource BoolToVis}}"
                                                   ToolTip="User-created layer"/>
                                        
                                        <CheckBox Grid.Column="4" IsChecked="{Binding IsLocked}" 
                                                  Content="ðŸ”’" VerticalAlignment="Center" Opacity="0.7"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <Border Grid.Row="2" Background="{DynamicResource PanelBackgroundBrush}" Padding="10,8">
                        <StackPanel>
                            <CheckBox x:Name="ChkShowKpLabels" Content="ðŸ“ Show KP Labels" 
                                      IsChecked="False" Click="ShowKpLabels_Click"/>
                            <StackPanel Orientation="Horizontal" Margin="20,5,0,0">
                                <TextBlock Text="Interval:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <TextBox x:Name="TxtKpInterval" Text="0.1" Width="50" 
                                         IsEnabled="{Binding IsChecked, ElementName=ChkShowKpLabels}"
                                         TextChanged="KpInterval_Changed"/>
                                <TextBlock Text="km" VerticalAlignment="Center" Margin="5,0,0,0"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>
            
            <!-- Left Panel Toggle and Splitter -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <ToggleButton x:Name="BtnToggleLeftPanel" Grid.Row="0" Content="â—€" Width="20" Height="20" 
                              ToolTip="Hide/Show Layers Panel" Click="ToggleLeftPanel_Click" 
                              Background="{DynamicResource BorderBrush}" FontSize="10"/>
                <GridSplitter Grid.Row="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                              Background="{DynamicResource PanelBackgroundBrush}"/>
            </Grid>
            
            <!-- Center - Canvas Area (Split Screen) -->
            <Border Grid.Column="2" Background="#1E1E1E" ClipToBounds="True">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition x:Name="ProfileSplitterRow" Height="Auto"/>
                        <RowDefinition x:Name="ProfileRow" Height="0"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Plan View (Top) -->
                    <Grid Grid.Row="0">
                        <Canvas x:Name="MainCanvas" Background="#1E1E1E" ClipToBounds="True"
                                MouseWheel="Canvas_MouseWheel"
                                MouseLeftButtonDown="Canvas_MouseLeftButtonDown"
                                MouseLeftButtonUp="Canvas_MouseLeftButtonUp"
                                MouseRightButtonDown="Canvas_MouseRightButtonDown"
                                MouseRightButtonUp="Canvas_MouseRightButtonUp"
                                MouseMove="Canvas_MouseMove"
                                MouseLeave="Canvas_MouseLeave"
                                RenderOptions.BitmapScalingMode="HighQuality"
                                RenderOptions.CachingHint="Cache"
                                RenderOptions.ClearTypeHint="Enabled"
                                UseLayoutRounding="True"
                                SnapsToDevicePixels="True">
                            <Canvas.RenderTransform>
                                <TransformGroup>
                                    <ScaleTransform x:Name="CanvasScale" ScaleX="1" ScaleY="1"/>
                                    <TranslateTransform x:Name="CanvasTranslate" X="0" Y="0"/>
                                </TransformGroup>
                            </Canvas.RenderTransform>
                        </Canvas>
                        
                        <Border VerticalAlignment="Top" HorizontalAlignment="Left" Margin="10"
                                Background="#80000000" CornerRadius="4" Padding="10,5">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="PLAN VIEW" Foreground="#888" FontSize="10" Margin="0,0,15,0" FontWeight="Bold"/>
                                <TextBlock x:Name="TxtZoomLevel" Text="Zoom: 100%" Foreground="White" FontSize="11" Margin="0,0,15,0"/>
                                <TextBlock x:Name="TxtCursorPos" Text="X: 0.00  Y: 0.00" Foreground="White" FontSize="11"/>
                            </StackPanel>
                        </Border>
                        
                        <Border x:Name="SelectionInfo" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="10"
                                Background="#80000000" CornerRadius="4" Padding="10,5" Visibility="Collapsed">
                            <TextBlock x:Name="TxtSelectionInfo" Text="0 points selected" Foreground="White" FontSize="11"/>
                        </Border>
                        
                        <Border x:Name="PointTooltip" VerticalAlignment="Top" HorizontalAlignment="Left" 
                                Background="#E0000000" CornerRadius="4" Padding="8,6" Visibility="Collapsed">
                            <TextBlock x:Name="TxtTooltipContent" Foreground="White" FontSize="11"/>
                        </Border>
                        
                        <Border VerticalAlignment="Bottom" HorizontalAlignment="Right" Margin="10"
                                Width="150" Height="100" Background="#40000000" CornerRadius="4"
                                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                            <Canvas x:Name="MiniMapCanvas" ClipToBounds="True"/>
                        </Border>
                    </Grid>
                    
                    <GridSplitter x:Name="ProfileSplitter" Grid.Row="1" Height="5" 
                                  HorizontalAlignment="Stretch" VerticalAlignment="Center"
                                  Background="{DynamicResource AccentBrush}" Visibility="Collapsed"/>
                    
                    <!-- Profile View (Bottom) -->
                    <Grid x:Name="ProfileViewGrid" Grid.Row="2" Visibility="Collapsed">
                        <Canvas x:Name="ProfileCanvas" Background="#252525" ClipToBounds="True"
                                MouseWheel="ProfileCanvas_MouseWheel"
                                MouseLeftButtonDown="ProfileCanvas_MouseLeftButtonDown"
                                MouseLeftButtonUp="ProfileCanvas_MouseLeftButtonUp"
                                MouseRightButtonDown="ProfileCanvas_MouseRightButtonDown"
                                MouseRightButtonUp="ProfileCanvas_MouseRightButtonUp"
                                MouseMove="ProfileCanvas_MouseMove">
                            <Canvas.RenderTransform>
                                <TransformGroup>
                                    <ScaleTransform x:Name="ProfileCanvasScale" ScaleX="1" ScaleY="1"/>
                                    <TranslateTransform x:Name="ProfileCanvasTranslate" X="0" Y="0"/>
                                </TransformGroup>
                            </Canvas.RenderTransform>
                        </Canvas>
                        
                        <Border VerticalAlignment="Top" HorizontalAlignment="Left" Margin="10"
                                Background="#80000000" CornerRadius="4" Padding="10,5">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="PROFILE VIEW" Foreground="#888" FontSize="10" Margin="0,0,15,0" FontWeight="Bold"/>
                                <TextBlock Text="X-Axis:" Foreground="White" FontSize="11" Margin="0,0,5,0"/>
                                <ComboBox x:Name="CboProfileXAxis" Width="80" SelectedIndex="0" SelectionChanged="ProfileXAxis_Changed">
                                    <ComboBoxItem Content="KP"/>
                                    <ComboBoxItem Content="DAL"/>
                                </ComboBox>
                                <TextBlock Text="Exaggeration:" Foreground="White" FontSize="11" Margin="15,0,5,0"/>
                                <TextBox x:Name="TxtProfileExaggeration" Text="10" Width="40" TextChanged="ProfileExaggeration_Changed"/>
                                <TextBlock Text="x" Foreground="White" FontSize="11" Margin="3,0,0,0"/>
                            </StackPanel>
                        </Border>
                        
                        <Border VerticalAlignment="Top" HorizontalAlignment="Right" Margin="10"
                                Background="#80000000" CornerRadius="4" Padding="10,5">
                            <TextBlock x:Name="TxtProfileZoom" Text="Zoom: 100%" Foreground="White" FontSize="11"/>
                        </Border>
                    </Grid>
                </Grid>
            </Border>
            
            <!-- Right Panel Toggle and Splitter -->
            <Grid Grid.Column="3">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <ToggleButton x:Name="BtnToggleRightPanel" Grid.Row="0" Content="â–¶" Width="20" Height="20" 
                              ToolTip="Hide/Show Properties Panel" Click="ToggleRightPanel_Click" 
                              Background="{DynamicResource BorderBrush}" FontSize="10"/>
                <GridSplitter Grid.Row="1" Width="4" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                              Background="{DynamicResource PanelBackgroundBrush}"/>
            </Grid>
            
            <!-- Right Panel - Properties/Tools -->
            <Border x:Name="RightPanel" Grid.Column="4" Background="{DynamicResource PanelBackgroundBrush}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Layer Properties -->
                        <Border x:Name="LayerPropertiesHeader" Background="{DynamicResource AccentBrush}" Padding="10,8">
                            <TextBlock Text="ðŸŽ¨ Layer Properties" FontWeight="SemiBold" FontSize="14" Foreground="White"/>
                        </Border>
                        
                        <StackPanel x:Name="LayerPropertiesPanel" Margin="10">
                            <TextBlock x:Name="TxtSelectedLayerName" Text="No layer selected" FontWeight="SemiBold" Margin="0,0,0,10"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Text="Color:" Grid.Row="0" VerticalAlignment="Center" Margin="0,0,0,8"/>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,8">
                                    <Border x:Name="LayerColorPreview" Width="30" Height="22" Background="Cyan" 
                                            BorderBrush="{DynamicResource SecondaryTextBrush}" BorderThickness="1"
                                            CornerRadius="2" Margin="0,0,5,0"/>
                                    <Button Content="Choose..." Padding="8,2" Click="ChooseLayerColor_Click"/>
                                </StackPanel>
                                
                                <TextBlock Text="Thickness:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,0,8"/>
                                <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,8">
                                    <Slider x:Name="SliderLayerThickness" Minimum="0.5" Maximum="10" Value="1.5" 
                                            Width="120" ValueChanged="LayerThickness_Changed" TickFrequency="0.5"/>
                                    <TextBlock x:Name="TxtLayerThickness" Text="1.5" Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="25"/>
                                </StackPanel>
                                
                                <TextBlock Text="Point Size:" Grid.Row="2" VerticalAlignment="Center" Margin="0,0,0,8"/>
                                <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,8">
                                    <Slider x:Name="SliderLayerPointSize" Minimum="1" Maximum="20" Value="6" 
                                            Width="120" ValueChanged="LayerPointSize_Changed" TickFrequency="1"/>
                                    <TextBlock x:Name="TxtLayerPointSize" Text="6" Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="25"/>
                                </StackPanel>
                                
                                <TextBlock Text="Opacity:" Grid.Row="3" VerticalAlignment="Center"/>
                                <StackPanel Grid.Row="3" Grid.Column="1" Orientation="Horizontal">
                                    <Slider x:Name="SliderLayerOpacity" Minimum="0.1" Maximum="1" Value="1" 
                                            Width="120" ValueChanged="LayerOpacity_Changed" TickFrequency="0.1"/>
                                    <TextBlock x:Name="TxtLayerOpacity" Text="100%" Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="35"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Measure Tool Panel -->
                        <Border x:Name="MeasureToolHeader" Background="{DynamicResource PanelBackgroundBrush}" 
                                Padding="10,8" Margin="0,10,0,0" Visibility="Collapsed">
                            <TextBlock Text="ðŸ“ Measure Tool" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="MeasureToolPanel" Margin="10" Visibility="Collapsed">
                            <TextBlock Text="Click points on canvas to measure." TextWrapping="Wrap"
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,10"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Text="Point 1:" Grid.Row="0" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeasurePoint1" Text="-" Grid.Row="0" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Point 2:" Grid.Row="1" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeasurePoint2" Text="-" Grid.Row="1" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Distance:" Grid.Row="2" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeasureDistance" Text="-" Grid.Row="2" Grid.Column="1" 
                                           FontWeight="SemiBold" Foreground="{DynamicResource AccentBrush}"/>
                                
                                <TextBlock Text="Cumulative:" Grid.Row="3" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeasureCumulative" Text="-" Grid.Row="3" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Area:" Grid.Row="4" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeasureArea" Text="-" Grid.Row="4" Grid.Column="1" FontWeight="SemiBold"/>
                            </Grid>
                            <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                                <Button Content="Clear" Padding="8,4" Margin="0,0,5,0" Click="ClearMeasure_Click"/>
                                <Button Content="Close Polygon" Padding="8,4" Click="CloseMeasurePolygon_Click"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- MEASURE Interval Tool Panel (UPDATED - Dual Mode) -->
                        <Border x:Name="MeasureIntervalHeader" Background="{DynamicResource PanelBackgroundBrush}" 
                                Padding="10,8" Margin="0,10,0,0" Visibility="Collapsed">
                            <TextBlock Text="ðŸ“ MEASURE Interval Tool" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="MeasureIntervalPanel" Margin="10" Visibility="Collapsed">
                            <TextBlock Text="Places points at intervals along a track. Creates a new layer." 
                                       TextWrapping="Wrap" Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,10"/>
                            
                            <TextBlock Text="Mode:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <RadioButton x:Name="RdoMeasureDistance" Content="Distance Along Track" 
                                             IsChecked="True" Margin="0,0,15,0" Checked="MeasureMode_Changed"/>
                                <RadioButton x:Name="RdoMeasureKP" Content="KP Interval" Checked="MeasureMode_Changed"/>
                            </StackPanel>
                            
                            <TextBlock Text="Source Layer:" Margin="0,0,0,5"/>
                            <ComboBox x:Name="CboMeasureSourceLayer" Margin="0,0,0,10"/>
                            
                            <!-- Distance Mode Options -->
                            <StackPanel x:Name="DistanceModePanel">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Text="Interval:" Grid.Row="0" VerticalAlignment="Center" Margin="0,0,10,5"/>
                                    <StackPanel Orientation="Horizontal" Grid.Row="0" Grid.Column="1" Margin="0,0,0,5">
                                        <TextBox x:Name="TxtDistanceInterval" Width="80" Text="1.0"/>
                                        <TextBlock Text="meters" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    </StackPanel>
                                    
                                    <TextBlock Text="Start:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,10,5"/>
                                    <StackPanel Orientation="Horizontal" Grid.Row="1" Grid.Column="1" Margin="0,0,0,5">
                                        <TextBox x:Name="TxtDistanceStart" Width="80" Text="0"/>
                                        <TextBlock Text="m" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    </StackPanel>
                                    
                                    <TextBlock Text="End:" Grid.Row="2" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <StackPanel Orientation="Horizontal" Grid.Row="2" Grid.Column="1">
                                        <TextBox x:Name="TxtDistanceEnd" Width="80" Text="" ToolTip="Leave empty for full length"/>
                                        <TextBlock Text="m (empty=all)" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                            
                            <!-- KP Mode Options -->
                            <StackPanel x:Name="KpModePanel" Visibility="Collapsed">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Text="Interval:" Grid.Row="0" VerticalAlignment="Center" Margin="0,0,10,5"/>
                                    <StackPanel Orientation="Horizontal" Grid.Row="0" Grid.Column="1" Margin="0,0,0,5">
                                        <TextBox x:Name="TxtMeasureIntervalDistance" Width="80" Text="0.001"/>
                                        <TextBlock Text="(KP units)" Foreground="{DynamicResource SecondaryTextBrush}" 
                                                   VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    </StackPanel>
                                    
                                    <TextBlock Text="Start KP:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,10,5"/>
                                    <TextBox x:Name="TxtMeasureStartKp" Width="80" Grid.Row="1" Grid.Column="1" Text="0" Margin="0,0,0,5"/>
                                    
                                    <TextBlock Text="End KP:" Grid.Row="2" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                    <TextBox x:Name="TxtMeasureEndKp" Width="80" Grid.Row="2" Grid.Column="1" Text=""/>
                                </Grid>
                            </StackPanel>
                            
                            <TextBlock x:Name="TxtMeasureIntervalStatus" Text="Select source layer and click 'Generate Points'" 
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,10,0,5" TextWrapping="Wrap"/>
                            
                            <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                                <Button Content="Generate Points" Padding="8,4" Margin="0,0,5,0" Click="GenerateMeasureIntervalPoints_Click"/>
                                <Button Content="Clear" Padding="8,4" Margin="0,0,5,0" Click="ClearMeasureIntervalPoints_Click"/>
                                <Button Content="Add to Layer" Padding="8,4" Click="AddMeasureIntervalToLayer_Click"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- Spline Fitting Panel - NEW -->
                        <Border x:Name="SplineFittingHeader" Background="{DynamicResource PanelBackgroundBrush}" Padding="10,8" Margin="0,10,0,0">
                            <Grid>
                                <TextBlock Text="ã€°ï¸ Spline Fitting" FontWeight="SemiBold" FontSize="14"/>
                                <ToggleButton x:Name="BtnExpandSpline" Content="â–¼" HorizontalAlignment="Right" Padding="5,2" Click="ExpandSpline_Click"/>
                            </Grid>
                        </Border>
                        
                        <StackPanel x:Name="SplineFittingPanel" Margin="10" Visibility="Collapsed">
                            <TextBlock Text="Fit smooth spline through survey points." TextWrapping="Wrap"
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,10"/>
                            
                            <TextBlock Text="Source Layer:" Margin="0,0,0,5"/>
                            <ComboBox x:Name="CboSplineSourceLayer" Margin="0,0,0,10"/>
                            
                            <TextBlock Text="Algorithm:" Margin="0,0,0,5"/>
                            <ComboBox x:Name="CboSplineAlgorithm" SelectedIndex="0" Margin="0,0,0,10">
                                <ComboBoxItem Content="Catmull-Rom (Subsea7 Recommended)" Tag="CatmullRom"/>
                                <ComboBoxItem Content="Cubic Spline (Standard)" Tag="CubicSpline"/>
                                <ComboBoxItem Content="B-Spline (Smooth)" Tag="BSpline"/>
                                <ComboBoxItem Content="AutoCAD PEDIT Compatible" Tag="AutoCadPedit"/>
                            </ComboBox>
                            
                            <TextBlock Text="Mode:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <RadioButton x:Name="RdoSplineAutoFit" Content="Auto-fit all points" IsChecked="True" Margin="0,0,15,0"/>
                                <RadioButton x:Name="RdoSplineManual" Content="Manual control points"/>
                            </StackPanel>
                            
                            <TextBlock Text="Tension:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Slider x:Name="SliderSplineTension"   Value="0.5" Width="150"
                                        ValueChanged="SplineTensionSlider_ValueChanged"/>
                                <TextBox x:Name="TxtSplineTension" Text="0.50" Width="50" Margin="10,0,0,0" VerticalAlignment="Center"
                                         TextChanged="SplineTensionText_Changed"/>
                            </StackPanel>
                            
                            <TextBlock Text="Output Multiplier:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Slider x:Name="SliderSplineOutputMultiplier"   Value="2" Width="150"
                                        ValueChanged="SplineOutputMultiplierSlider_ValueChanged"/>
                                <TextBox x:Name="TxtSplineOutputMultiplier" Text="2" Width="50" Margin="10,0,0,0" VerticalAlignment="Center"
                                         TextChanged="SplineOutputMultiplierText_Changed"/>
                            </StackPanel>
                            
                            <StackPanel Orientation="Horizontal">
                                <Button Content="Preview" Padding="8,4" Margin="0,0,5,0" Click="PreviewSpline_Click"/>
                                <Button Content="Apply" Padding="8,4" Margin="0,0,5,0" Click="ApplySpline_Click" 
                                        Background="{DynamicResource AccentBrush}" Foreground="White"/>
                                <Button Content="Clear" Padding="8,4" Click="ClearSpline_Click"/>
                            </StackPanel>
                        </StackPanel>
                        
                        <!-- Insert Block Panel -->
                        <Border x:Name="InsertBlockHeader" Background="{DynamicResource PanelBackgroundBrush}" 
                                Padding="10,8" Margin="0,10,0,0" Visibility="Collapsed">
                            <TextBlock Text="â¬› Insert Block" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="InsertBlockPanel" Margin="10" Visibility="Collapsed">
                            <TextBlock Text="Click on canvas to place symbol." TextWrapping="Wrap"
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,10"/>
                            <TextBlock Text="Symbol Type:" Margin="0,0,0,5"/>
                            <WrapPanel Margin="0,0,0,10">
                                <RadioButton x:Name="BlockCircle" Content="â— Circle" GroupName="BlockType" IsChecked="True" Margin="0,0,10,5"/>
                                <RadioButton x:Name="BlockSquare" Content="â–  Square" GroupName="BlockType" Margin="0,0,10,5"/>
                                <RadioButton x:Name="BlockCross" Content="âœš Cross" GroupName="BlockType" Margin="0,0,10,5"/>
                                <RadioButton x:Name="BlockTriangle" Content="â–² Triangle" GroupName="BlockType" Margin="0,0,10,5"/>
                                <RadioButton x:Name="BlockText" Content="A Text" GroupName="BlockType" 
                                             Checked="BlockText_Checked" Unchecked="BlockText_Unchecked"/>
                            </WrapPanel>
                            
                            <TextBlock Text="Size:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Slider x:Name="SliderBlockSize"   Value="15" Width="150" ValueChanged="BlockSize_Changed"/>
                                <TextBlock x:Name="TxtBlockSize" Text="15" Margin="8,0,0,0" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <TextBlock Text="Color:" Margin="0,0,0,5"/>
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                <Border x:Name="BlockColorPreview" Width="30" Height="22" Background="Yellow" 
                                        BorderBrush="{DynamicResource SecondaryTextBrush}" BorderThickness="1"
                                        CornerRadius="2" Margin="0,0,5,0"/>
                                <Button Content="Choose..." Padding="8,2" Click="ChooseBlockColor_Click"/>
                            </StackPanel>
                            
                            <StackPanel x:Name="TextLabelOptions" Visibility="Collapsed">
                                <TextBlock Text="Label Text:" Margin="0,0,0,5"/>
                                <TextBox x:Name="TxtBlockLabel" Text="Label" Margin="0,0,0,10"/>
                            </StackPanel>
                            
                            <TextBlock x:Name="TxtBlocksPlaced" Text="Blocks Placed: 0"/>
                            <Button Content="Clear All Blocks" Margin="0,10,0,0" Click="ClearBlocks_Click"/>
                        </StackPanel>
                        
                        <!-- Smoothing Section -->
                        <Border Background="{DynamicResource PanelBackgroundBrush}" Padding="10,8" Margin="0,10,0,0">
                            <TextBlock Text="ðŸ”„ Real-time Smoothing" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel Margin="10">
                            <!-- Source Layer Selection - Dynamic from all available layers -->
                            <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,10">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Source Layer:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                    <ComboBox x:Name="CboSmoothingSource" Grid.Column="1" 
                                              DisplayMemberPath="Name"
                                              SelectionChanged="SmoothingSource_Changed"/>
                                </Grid>
                            </Border>
                            
                            <!-- Position Smoothing -->
                            <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,10">
                                <StackPanel>
                                    <CheckBox x:Name="ChkSmoothPosition" Content="Position (Easting/Northing)" IsChecked="False" 
                                              FontWeight="SemiBold" Margin="0,0,0,8" Click="Smoothing_Changed"/>
                                    <Grid Margin="20,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Algorithm:" VerticalAlignment="Center" Margin="0,0,8,5"/>
                                        <ComboBox x:Name="CboPositionMethod" Grid.Column="1" SelectedIndex="1" Margin="0,0,0,5"
                                                  SelectionChanged="Smoothing_Changed" IsEnabled="{Binding IsChecked, ElementName=ChkSmoothPosition}">
                                            <ComboBoxItem Content="Moving Average" Tag="MovingAverage"/>
                                            <ComboBoxItem Content="Median Filter" Tag="MedianFilter"/>
                                            <ComboBoxItem Content="Threshold-Based" Tag="ThresholdBased"/>
                                            <ComboBoxItem Content="Kalman Filter" Tag="KalmanFilter"/>
                                        </ComboBox>
                                        <TextBlock Text="Window:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                        <Grid Grid.Row="1" Grid.Column="1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="55"/>
                                            </Grid.ColumnDefinitions>
                                            <Slider x:Name="SliderPositionWindow" Minimum="3" Maximum="101" Value="5" 
                                                    TickFrequency="2" IsSnapToTickEnabled="True" ValueChanged="Smoothing_Changed"
                                                    IsEnabled="{Binding IsChecked, ElementName=ChkSmoothPosition}"/>
                                            <TextBox x:Name="TxtPositionWindow" Grid.Column="1" Text="5" Margin="5,0,0,0" 
                                                     VerticalAlignment="Center" TextChanged="PositionWindowText_Changed"
                                                     IsEnabled="{Binding IsChecked, ElementName=ChkSmoothPosition}"
                                                     ToolTip="Window size: 3-999 (odd numbers recommended)"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <!-- Depth Smoothing -->
                            <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,10">
                                <StackPanel>
                                    <CheckBox x:Name="ChkSmoothDepth" Content="Depth" IsChecked="False" 
                                              FontWeight="SemiBold" Margin="0,0,0,8" Click="Smoothing_Changed"/>
                                    <Grid Margin="20,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Algorithm:" VerticalAlignment="Center" Margin="0,0,8,5"/>
                                        <ComboBox x:Name="CboDepthMethod" Grid.Column="1" SelectedIndex="1" Margin="0,0,0,5"
                                                  SelectionChanged="Smoothing_Changed" IsEnabled="{Binding IsChecked, ElementName=ChkSmoothDepth}">
                                            <ComboBoxItem Content="Moving Average" Tag="MovingAverage"/>
                                            <ComboBoxItem Content="Median Filter" Tag="MedianFilter"/>
                                            <ComboBoxItem Content="Threshold-Based" Tag="ThresholdBased"/>
                                            <ComboBoxItem Content="Kalman Filter" Tag="KalmanFilter"/>
                                        </ComboBox>
                                        <TextBlock Text="Window:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                        <Grid Grid.Row="1" Grid.Column="1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="55"/>
                                            </Grid.ColumnDefinitions>
                                            <Slider x:Name="SliderDepthWindow" Minimum="3" Maximum="101" Value="5" 
                                                    TickFrequency="2" IsSnapToTickEnabled="True" ValueChanged="Smoothing_Changed"
                                                    IsEnabled="{Binding IsChecked, ElementName=ChkSmoothDepth}"/>
                                            <TextBox x:Name="TxtDepthWindow" Grid.Column="1" Text="5" Margin="5,0,0,0" 
                                                     VerticalAlignment="Center" TextChanged="DepthWindowText_Changed"
                                                     IsEnabled="{Binding IsChecked, ElementName=ChkSmoothDepth}"
                                                     ToolTip="Window size: 3-999 (odd numbers recommended)"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <!-- Altitude Smoothing -->
                            <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Padding="8" Margin="0,0,0,10">
                                <StackPanel>
                                    <CheckBox x:Name="ChkSmoothAltitude" Content="Altitude" IsChecked="False" 
                                              FontWeight="SemiBold" Margin="0,0,0,8" Click="Smoothing_Changed"/>
                                    <Grid Margin="20,0,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Algorithm:" VerticalAlignment="Center" Margin="0,0,8,5"/>
                                        <ComboBox x:Name="CboAltitudeMethod" Grid.Column="1" SelectedIndex="1" Margin="0,0,0,5"
                                                  SelectionChanged="Smoothing_Changed" IsEnabled="{Binding IsChecked, ElementName=ChkSmoothAltitude}">
                                            <ComboBoxItem Content="Moving Average" Tag="MovingAverage"/>
                                            <ComboBoxItem Content="Median Filter" Tag="MedianFilter"/>
                                            <ComboBoxItem Content="Threshold-Based" Tag="ThresholdBased"/>
                                            <ComboBoxItem Content="Kalman Filter" Tag="KalmanFilter"/>
                                        </ComboBox>
                                        <TextBlock Text="Window:" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                        <Grid Grid.Row="1" Grid.Column="1">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="55"/>
                                            </Grid.ColumnDefinitions>
                                            <Slider x:Name="SliderAltitudeWindow" Minimum="3" Maximum="101" Value="5" 
                                                    TickFrequency="2" IsSnapToTickEnabled="True" ValueChanged="Smoothing_Changed"
                                                    IsEnabled="{Binding IsChecked, ElementName=ChkSmoothAltitude}"/>
                                            <TextBox x:Name="TxtAltitudeWindow" Grid.Column="1" Text="5" Margin="5,0,0,0" 
                                                     VerticalAlignment="Center" TextChanged="AltitudeWindowText_Changed"
                                                     IsEnabled="{Binding IsChecked, ElementName=ChkSmoothAltitude}"
                                                     ToolTip="Window size: 3-999 (odd numbers recommended)"/>
                                        </Grid>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <!-- Global Settings -->
                            <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Padding="8">
                                <StackPanel>
                                    <TextBlock Text="Global Settings" FontWeight="SemiBold" Margin="0,0,0,8"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="55"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Threshold:" VerticalAlignment="Center" Margin="0,0,8,0"
                                                   ToolTip="Spike threshold for threshold-based smoothing (meters)"/>
                                        <Slider x:Name="SliderThreshold" Grid.Column="1" Minimum="0.01" Maximum="10.0" Value="1.0" 
                                                ValueChanged="Smoothing_Changed" ToolTip="Spike detection threshold"/>
                                        <TextBox x:Name="TxtThreshold" Grid.Column="2" Text="1.00" Margin="5,0,0,0" 
                                                 VerticalAlignment="Center" TextChanged="ThresholdText_Changed"
                                                 ToolTip="Enter value: 0.01 - 100"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <CheckBox x:Name="ChkShowComparison" Content="Show Before/After Comparison" IsChecked="True" 
                                      Margin="0,15,0,0" FontWeight="SemiBold" Click="Smoothing_Changed"/>
                            
                            <Button Content="âœ” Apply Smoothing" Margin="0,10,0,0" Padding="10,5"
                                    Background="#4CAF50" Foreground="White" FontWeight="SemiBold"
                                    Click="ApplySmoothing_Click" ToolTip="Apply smoothing to current points (updates preview)"/>
                            
                            <Button Content="ðŸ“¥ Create Smoothed Layer" Margin="0,10,0,0" Padding="10,5"
                                    Click="CreateSmoothedLayer_Click" ToolTip="Create a new layer with smoothed data"/>
                        </StackPanel>
                        
                        <!-- Smoothing Statistics -->
                        <Border Background="{DynamicResource PanelBackgroundBrush}" Padding="10,8" Margin="0,10,0,0">
                            <TextBlock Text="ðŸ“ˆ Smoothing Statistics" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="StatsPanel" Margin="10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Text="RMS Displacement:" Grid.Row="0" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtRmsDisplacement" Text="-" Grid.Row="0" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Max Displacement:" Grid.Row="1" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMaxDisplacement" Text="-" Grid.Row="1" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Mean Displacement:" Grid.Row="2" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtMeanDisplacement" Text="-" Grid.Row="2" Grid.Column="1" FontWeight="SemiBold"/>
                                
                                <TextBlock Text="Points Modified:" Grid.Row="3" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                <TextBlock x:Name="TxtPointsModified" Text="-" Grid.Row="3" Grid.Column="1" FontWeight="SemiBold"/>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Point Properties -->
                        <Border x:Name="PointPropertiesPanel" Background="{DynamicResource PanelBackgroundBrush}" 
                                Padding="10,8" Margin="0,10,0,0" Visibility="Collapsed">
                            <TextBlock Text="ðŸ“ Selected Point" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="PointPropertiesContent" Margin="10" Visibility="Collapsed">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="60"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Text="Index:" Grid.Row="0" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointIndex" Grid.Row="0" Grid.Column="1" IsReadOnly="True" Margin="0,0,0,5"/>
                                
                                <TextBlock Text="Easting:" Grid.Row="1" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointEasting" Grid.Row="1" Grid.Column="1" Margin="0,0,0,5" TextChanged="PointProperty_Changed"/>
                                
                                <TextBlock Text="Northing:" Grid.Row="2" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointNorthing" Grid.Row="2" Grid.Column="1" Margin="0,0,0,5" TextChanged="PointProperty_Changed"/>
                                
                                <TextBlock Text="Depth:" Grid.Row="3" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointDepth" Grid.Row="3" Grid.Column="1" Margin="0,0,0,5" TextChanged="PointProperty_Changed"/>
                                
                                <TextBlock Text="KP:" Grid.Row="4" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointKp" Grid.Row="4" Grid.Column="1" IsReadOnly="True" Margin="0,0,0,5"/>
                                
                                <TextBlock Text="DCC:" Grid.Row="5" VerticalAlignment="Center"/>
                                <TextBox x:Name="TxtPointDcc" Grid.Row="5" Grid.Column="1" IsReadOnly="True" Margin="0,0,0,5"/>
                                
                                <TextBlock Text="DAL:" Grid.Row="6" VerticalAlignment="Center" ToolTip="Distance Along Line"/>
                                <TextBox x:Name="TxtPointDal" Grid.Row="6" Grid.Column="1" IsReadOnly="True"/>
                            </Grid>
                        </StackPanel>
                        
                        <!-- Digitization Info -->
                        <Border x:Name="DigitizePanel" Background="{DynamicResource PanelBackgroundBrush}" 
                                Padding="10,8" Margin="0,10,0,0" Visibility="Collapsed">
                            <TextBlock Text="âœï¸ Digitization Mode" FontWeight="SemiBold" FontSize="14"/>
                        </Border>
                        
                        <StackPanel x:Name="DigitizeContent" Margin="10" Visibility="Collapsed">
                            <TextBlock Text="Click on the canvas to add new points." TextWrapping="Wrap"
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,0,0,10"/>
                            <TextBlock x:Name="TxtDigitizedCount" Text="Digitized Points: 0"/>
                            <Button Content="Clear Digitized" Margin="0,10,0,0" Click="ClearDigitized_Click"/>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Status Bar -->
        <Border Grid.Row="2" Background="{DynamicResource PanelBackgroundBrush}" Padding="10,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock x:Name="TxtStatus" Text="Ready" VerticalAlignment="Center"/>
                
                <TextBlock Grid.Column="1" Margin="20,0">
                    <Run Text="Points: " Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <Run x:Name="TxtTotalPoints" Text="0"/>
                </TextBlock>
                
                <TextBlock Grid.Column="2" Margin="20,0">
                    <Run Text="Modified: " Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <Run x:Name="TxtModifiedCount" Text="0"/>
                </TextBlock>
                
                <TextBlock Grid.Column="3" Margin="20,0">
                    <Run Text="Selected: " Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <Run x:Name="TxtSelectedCount" Text="0"/>
                </TextBlock>
                
                <TextBlock Grid.Column="4">
                    <Run Text="Track Length: " Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <Run x:Name="TxtTrackLength" Text="-"/>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</mah:MetroWindow>
