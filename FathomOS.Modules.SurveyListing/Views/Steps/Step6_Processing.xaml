<UserControl x:Class="FathomOS.Modules.SurveyListing.Views.Steps.Step6_Processing"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:FathomOS.Modules.SurveyListing.Converters"
             >
    
    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="380"/>
        </Grid.ColumnDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Grid.ColumnSpan="2" Margin="20,20,20,10">
            <TextBlock Text="Processing &amp; Preview" FontSize="24" FontWeight="Light"/>
            <TextBlock Text="Configure processing options, run calculations, and review results." 
                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,5,0,0"/>
        </StackPanel>

        <!-- Main Content Area with TabControl -->
        <Border Grid.Row="1" Grid.Column="0" Margin="20,10,10,10" 
                BorderBrush="{DynamicResource PanelBackgroundBrush}" BorderThickness="1" CornerRadius="4">
            <Grid>
                <!-- Placeholder when not processed -->
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"
                            Visibility="{Binding IsProcessed, Converter={StaticResource InverseBoolToVisibility}}">
                    <TextBlock Text="ðŸ“Š" Width="64" Height="64" 
                                                 Foreground="{DynamicResource BorderBrush}"/>
                    <TextBlock Text="Processing Results" HorizontalAlignment="Center" Margin="0,15,0,0"
                               FontSize="16" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <TextBlock Text="Click 'Process' to generate results" HorizontalAlignment="Center" FontSize="12"
                               Foreground="{DynamicResource BorderBrush}" Margin="0,5,0,0"/>
                </StackPanel>

                <!-- Tab Control for Results -->
                <TabControl Visibility="{Binding IsProcessed, Converter={StaticResource BoolToVisibility}}"
                            >
                    
                    <!-- Tab 1: Comparison (Input vs Output) -->
                    <TabItem Header="Comparison">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Pagination Controls Top -->
                            <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" Padding="5">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding PageInfo}" VerticalAlignment="Center" Margin="0,0,15,0"/>
                                    <Button Content="â®" Click="FirstPage_Click" Width="30" Margin="0,0,2,0" 
                                            IsEnabled="{Binding CanGoToPreviousPage}" ToolTip="First Page"/>
                                    <Button Content="â—€" Click="PreviousPage_Click" Width="30" Margin="0,0,2,0"
                                            IsEnabled="{Binding CanGoToPreviousPage}" ToolTip="Previous Page"/>
                                    <Button Content="â–¶" Click="NextPage_Click" Width="30" Margin="0,0,2,0"
                                            IsEnabled="{Binding CanGoToNextPage}" ToolTip="Next Page"/>
                                    <Button Content="â­" Click="LastPage_Click" Width="30"
                                            IsEnabled="{Binding CanGoToNextPage}" ToolTip="Last Page"/>
                                    <Separator Width="1" Margin="10,2"/>
                                    <TextBlock Text="Page Size:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                    <ComboBox SelectedValue="{Binding PageSize}" Width="70" SelectedValuePath="Content">
                                        <ComboBoxItem Content="100"/>
                                        <ComboBoxItem Content="250"/>
                                        <ComboBoxItem Content="500"/>
                                        <ComboBoxItem Content="1000"/>
                                        <ComboBoxItem Content="2000"/>
                                    </ComboBox>
                                    <Separator Width="1" Margin="10,2"/>
                                    <CheckBox Content="Show Deleted" IsChecked="{Binding ShowDeletedPoints}" 
                                              VerticalAlignment="Center" Margin="5,0"/>
                                    <CheckBox Content="Show Added" IsChecked="{Binding ShowAddedPoints}" 
                                              VerticalAlignment="Center" Margin="5,0"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Data Grid -->
                            <DataGrid Grid.Row="1" ItemsSource="{Binding ComparisonItems}" AutoGenerateColumns="False"
                                  IsReadOnly="True" CanUserAddRows="False" FontSize="11"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling"
                                  ScrollViewer.IsDeferredScrollingEnabled="True">
                            <DataGrid.RowStyle>
                                <Style TargetType="DataGridRow">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                            <Setter Property="Background" Value="#30FF0000"/>
                                            <Setter Property="Foreground" Value="Gray"/>
                                            <Setter Property="TextBlock.TextDecorations" Value="Strikethrough"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsAdded}" Value="True">
                                            <Setter Property="Background" Value="#3000FF00"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="#" Binding="{Binding RecordNumber}" Width="45"/>
                                <DataGridTextColumn Header="Time" Binding="{Binding DateTimeFormatted}" Width="70"/>
                                <DataGridTextColumn Header="Raw E" Binding="{Binding RawEasting, StringFormat=F2}" Width="85">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Gray"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Raw N" Binding="{Binding RawNorthing, StringFormat=F2}" Width="85">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Gray"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Raw D" Binding="{Binding RawDepth, StringFormat=F2}" Width="65">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Gray"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="â†’" Width="25"/>
                                <DataGridTextColumn Header="X" Binding="{Binding X, StringFormat=F2}" Width="85">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontWeight" Value="SemiBold"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Y" Binding="{Binding Y, StringFormat=F2}" Width="85">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontWeight" Value="SemiBold"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Z" Binding="{Binding ZFormatted}" Width="70">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock"><Setter Property="FontWeight" Value="SemiBold"/><Setter Property="Foreground" Value="DarkGreen"/></Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="KP" Binding="{Binding KpFormatted}" Width="80"/>
                                <DataGridTextColumn Header="DCC" Binding="{Binding DccFormatted}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                        </Grid>
                    </TabItem>
                    
                    <!-- Tab 2: Final Listing (KP, DCC, X, Y, Z) -->
                    <TabItem Header="Final Listing">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Listing Source Selection -->
                            <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" Padding="10" Margin="0,0,0,5">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Listing Source:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                    <ComboBox ItemsSource="{Binding ListingSourceLayers}" 
                                              SelectedItem="{Binding ListingSourceLayer}" 
                                              Width="200" Height="26"/>
                                    <Button Content="â†» Refresh" Padding="10,4" Margin="10,0,0,0"
                                            Command="{Binding RefreshListingCommand}"
                                            ToolTip="Regenerate listing from selected source"/>
                                    <TextBlock Text="{Binding ListingSourceDescription}" VerticalAlignment="Center" 
                                               Margin="15,0,0,0" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                                </StackPanel>
                            </Border>
                            
                            <DataGrid Grid.Row="1" ItemsSource="{Binding FinalListingItems}" AutoGenerateColumns="False"
                                      IsReadOnly="True" CanUserAddRows="False"
                                      EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling"
                                      ScrollViewer.IsDeferredScrollingEnabled="True">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="KP" Binding="{Binding KpFormatted}" Width="120">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock"><Setter Property="FontWeight" Value="SemiBold"/></Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="DCC" Binding="{Binding DccFormatted}" Width="100"/>
                                    <DataGridTextColumn Header="X" Binding="{Binding XFormatted}" Width="120"/>
                                    <DataGridTextColumn Header="Y" Binding="{Binding YFormatted}" Width="120"/>
                                    <DataGridTextColumn Header="Z" Binding="{Binding ZFormatted}" Width="*">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock"><Setter Property="Foreground" Value="DarkGreen"/></Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                    
                    <!-- Tab 3: Raw Data -->
                    <TabItem Header="Raw Data">
                        <DataGrid ItemsSource="{Binding RawDataItems}" AutoGenerateColumns="False"
                                  IsReadOnly="True" CanUserAddRows="False"
                                  EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                  VirtualizingPanel.IsVirtualizing="True"
                                  VirtualizingPanel.VirtualizationMode="Recycling"
                                  ScrollViewer.IsDeferredScrollingEnabled="True">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="#" Binding="{Binding RecordNumber}" Width="50"/>
                                <DataGridTextColumn Header="DateTime" Binding="{Binding DateTimeFormatted}" Width="140"/>
                                <DataGridTextColumn Header="Easting" Binding="{Binding Easting, StringFormat=F4}" Width="110"/>
                                <DataGridTextColumn Header="Northing" Binding="{Binding Northing, StringFormat=F4}" Width="110"/>
                                <DataGridTextColumn Header="Depth" Binding="{Binding DepthFormatted}" Width="80"/>
                                <DataGridTextColumn Header="Altitude" Binding="{Binding AltitudeFormatted}" Width="80"/>
                                <DataGridTextColumn Header="Heading" Binding="{Binding HeadingFormatted}" Width="*"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </TabItem>
                    
                    <!-- Tab 4: Spline Fitted Points (NEW) -->
                    <TabItem Header="Spline Fitted">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Summary -->
                            <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" 
                                    Padding="15" Margin="0,0,0,5">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Spline Points: " FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding SplineFittedPointCount}"/>
                                    <TextBlock Text="  |  Algorithm: " Margin="20,0,0,0"/>
                                    <TextBlock Text="{Binding SplineAlgorithmDisplay}"/>
                                    <TextBlock Text="  |  Tension: " Margin="20,0,0,0"/>
                                    <TextBlock Text="{Binding SplineTension, StringFormat=F2}"/>
                                </StackPanel>
                            </Border>
                            
                            <DataGrid Grid.Row="1" ItemsSource="{Binding SplineFittedItems}" 
                                      AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                                      EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="60"/>
                                    <DataGridTextColumn Header="X (Easting)" Binding="{Binding X, StringFormat=F4}" Width="140"/>
                                    <DataGridTextColumn Header="Y (Northing)" Binding="{Binding Y, StringFormat=F4}" Width="140"/>
                                    <DataGridTextColumn Header="Z (Depth)" Binding="{Binding Z, StringFormat=F3}" Width="100">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Purple"/></Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Distance" Binding="{Binding DistanceFromStart, StringFormat=F2}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                    
                    <!-- Tab 5: Interval Points (NEW) -->
                    <TabItem Header="Interval Points">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Summary -->
                            <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" 
                                    Padding="15" Margin="0,0,0,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Interval Points: " FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding IntervalPointCount}"/>
                                        <TextBlock Text="  |  Interval: " Margin="20,0,0,0"/>
                                        <TextBlock Text="{Binding MeasureInterval, StringFormat=F1}"/>
                                        <TextBlock Text="m  |  Source: " Margin="0,0,0,0"/>
                                        <TextBlock Text="{Binding IntervalSourceLayer}"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="ðŸ“¤ Export" Padding="10,4"
                                            Click="ExportIntervalPoints_Click"
                                            IsEnabled="{Binding HasIntervalPoints}"
                                            ToolTip="Export interval points to CSV"/>
                                </Grid>
                            </Border>
                            
                            <DataGrid Grid.Row="1" ItemsSource="{Binding IntervalPointItems}" 
                                      AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                                      EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="60"/>
                                    <DataGridTextColumn Header="Distance (m)" Binding="{Binding Distance, StringFormat=F2}" Width="100">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock"><Setter Property="FontWeight" Value="SemiBold"/></Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="X (Easting)" Binding="{Binding X, StringFormat=F4}" Width="140"/>
                                    <DataGridTextColumn Header="Y (Northing)" Binding="{Binding Y, StringFormat=F4}" Width="140"/>
                                    <DataGridTextColumn Header="Z (Depth)" Binding="{Binding Z, StringFormat=F3}" Width="*">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock"><Setter Property="Foreground" Value="Teal"/></Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                    
                    <!-- Tab 6: Smoothing Changes -->
                    <TabItem Header="Smoothing">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Smoothing Summary -->
                            <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" 
                                    Padding="15" Margin="0,0,0,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Grid.Column="0" Text="{Binding SmoothingSummary}" 
                                               FontFamily="Consolas" FontSize="11" TextWrapping="Wrap"/>
                                    
                                    <Button Grid.Column="1" Content="Export Report" Width="100" Height="28"
                                            Click="ExportSmoothingReport_Click"
                                            IsEnabled="{Binding HasSmoothingResults}"
                                            VerticalAlignment="Top"/>
                                </Grid>
                            </Border>
                            
                            <!-- Comparison Grid -->
                            <DataGrid Grid.Row="1" ItemsSource="{Binding SmoothingComparisonItems}" 
                                      AutoGenerateColumns="False" IsReadOnly="True" CanUserAddRows="False"
                                      FontSize="11"
                                      EnableRowVirtualization="True" EnableColumnVirtualization="True"
                                      VirtualizingPanel.IsVirtualizing="True"
                                      VirtualizingPanel.VirtualizationMode="Recycling">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Rec#" Binding="{Binding RecordNumber}" Width="50"/>
                                    <DataGridTextColumn Header="Orig E" Binding="{Binding OriginalEasting, StringFormat=F2}" Width="80"/>
                                    <DataGridTextColumn Header="Orig N" Binding="{Binding OriginalNorthing, StringFormat=F2}" Width="80"/>
                                    <DataGridTextColumn Header="Orig D" Binding="{Binding OriginalDepth, StringFormat=F2}" Width="60"/>
                                    <DataGridTextColumn Header="Orig A" Binding="{Binding OriginalAltitude, StringFormat=F2}" Width="60"/>
                                    <DataGridTextColumn Header="New E" Binding="{Binding SmoothedEasting, StringFormat=F2}" Width="80"/>
                                    <DataGridTextColumn Header="New N" Binding="{Binding SmoothedNorthing, StringFormat=F2}" Width="80"/>
                                    <DataGridTextColumn Header="New D" Binding="{Binding SmoothedDepth, StringFormat=F2}" Width="60"/>
                                    <DataGridTextColumn Header="New A" Binding="{Binding SmoothedAltitude, StringFormat=F2}" Width="60"/>
                                    <DataGridTextColumn Header="Pos Î”" Binding="{Binding PositionDiffFormatted}" Width="55">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="Orange"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="D Î”" Binding="{Binding DepthDiffFormatted}" Width="*">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="CornflowerBlue"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Grid>
        </Border>

        <!-- Options Panel -->
        <Border Grid.Row="1" Grid.Column="1" Background="{DynamicResource PanelBackgroundBrush}" 
                CornerRadius="4" Padding="15" Margin="0,10,20,10">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <TextBlock Text="Processing Options" FontWeight="SemiBold" Margin="0,0,0,15"/>

                    <!-- KP/DCC Mode -->
                    <TextBlock Text="KP/DCC Calculation" FontSize="12" Margin="0,0,0,3"/>
                    <ComboBox ItemsSource="{Binding KpDccModes}" SelectedItem="{Binding KpDccMode}" 
                              Height="28" Margin="0,0,0,15"/>

                    <Separator Margin="0,0,0,15"/>
                    
                    <!-- SPLINE FITTING OPTIONS (NEW) -->
                    <TextBlock Text="Spline Fitting" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <CheckBox Content="Enable spline fitting" IsChecked="{Binding FitSplineToTrack}" Margin="0,0,0,10"/>
                    
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            IsEnabled="{Binding FitSplineToTrack}">
                        <StackPanel>
                            <TextBlock Text="Source Layer:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding AvailableSourceLayers}" 
                                      SelectedItem="{Binding SplineSourceLayer}" 
                                      Height="28" Margin="0,0,0,8"/>
                            
                            <TextBlock Text="Algorithm:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding SplineAlgorithms}" 
                                      SelectedItem="{Binding SelectedSplineAlgorithm}" 
                                      Height="28" Margin="0,0,0,8"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Tension:" FontSize="11"/>
                                    <Slider Value="{Binding SplineTension}"   
                                            TickFrequency="0.1" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                </StackPanel>
                                <TextBox Grid.Column="1" Text="{Binding SplineTension, StringFormat=F2, UpdateSourceTrigger=PropertyChanged}" 
                                         Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                            </Grid>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Output Points:" FontSize="11"/>
                                    <Slider Value="{Binding SplineOutputMultiplier}"   
                                            TickFrequency="1" IsSnapToTickEnabled="True" Margin="0,3,0,0"/>
                                </StackPanel>
                                <TextBox Grid.Column="1" Text="{Binding SplineOutputMultiplier, StringFormat=F0, UpdateSourceTrigger=PropertyChanged}" 
                                         Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                            </Grid>
                            <TextBlock Text="{Binding SplineOutputDescription}" FontSize="10" 
                                       Foreground="{DynamicResource SecondaryTextBrush}" Margin="0,3,0,0"/>
                        </StackPanel>
                    </Border>

                    <Separator Margin="0,5,0,15"/>

                    <!-- INTERVAL MEASURE OPTIONS (NEW) -->
                    <TextBlock Text="Interval Measure" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <CheckBox Content="Generate interval points" IsChecked="{Binding EnableIntervalMeasure}" Margin="0,0,0,10"/>
                    
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            IsEnabled="{Binding EnableIntervalMeasure}">
                        <StackPanel>
                            <TextBlock Text="Source Layer:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding IntervalSourceLayers}" 
                                      SelectedItem="{Binding IntervalSourceLayer}" 
                                      Height="28" Margin="0,0,0,8"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Interval (m):" FontSize="11"/>
                                    <Slider Value="{Binding MeasureInterval}"   
                                            TickFrequency="0.5" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                </StackPanel>
                                <TextBox Grid.Column="1" Text="{Binding MeasureInterval, StringFormat=F1, UpdateSourceTrigger=PropertyChanged}" 
                                         Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                            </Grid>
                            
                            <TextBlock Text="â„¹ï¸ Select source layer to measure intervals along. Route Line option available when route is loaded." 
                                       FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}" TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>

                    <Separator Margin="0,5,0,15"/>

                    <!-- Smoothing Options -->
                    <TextBlock Text="Track Smoothing" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <CheckBox Content="Enable smoothing" IsChecked="{Binding EnableSmoothing}" Margin="0,0,0,10"/>
                    
                    <!-- Smoothing Source Selection -->
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            IsEnabled="{Binding EnableSmoothing}">
                        <StackPanel>
                            <TextBlock Text="Source Layer:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding SmoothingSourceLayers}" 
                                      SelectedItem="{Binding SmoothingSourceLayer}" 
                                      Height="28" Margin="0,0,0,5"/>
                            <TextBlock Text="â„¹ï¸ Select which data to apply smoothing to" 
                                       FontSize="10" Foreground="{DynamicResource SecondaryTextBrush}"/>
                        </StackPanel>
                    </Border>

                    <!-- Position Smoothing -->
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            IsEnabled="{Binding EnableSmoothing}">
                        <StackPanel>
                            <CheckBox Content="Smooth Position (E/N)" IsChecked="{Binding SmoothPosition}" Margin="0,0,0,8"/>
                            
                            <TextBlock Text="Method:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding SmoothingMethods}" 
                                      SelectedItem="{Binding PositionSmoothingMethod}" 
                                      Margin="0,0,0,8" Height="28"/>

                            <StackPanel Visibility="{Binding ShowPositionWindowSize, Converter={StaticResource BoolToVisibility}}">
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="60"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Window Size:" FontSize="11"/>
                                        <Slider Value="{Binding PositionWindowSize}"   
                                                TickFrequency="2" IsSnapToTickEnabled="True" Margin="0,3,0,0"/>
                                    </StackPanel>
                                    <TextBox Grid.Column="1" Text="{Binding PositionWindowSize, UpdateSourceTrigger=PropertyChanged}" 
                                             Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                </Grid>
                            </StackPanel>

                            <StackPanel Visibility="{Binding ShowPositionThreshold, Converter={StaticResource BoolToVisibility}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="60"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Threshold (m):" FontSize="11"/>
                                        <Slider Value="{Binding PositionThreshold}"   
                                                TickFrequency="0.5" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                    </StackPanel>
                                    <TextBox Grid.Column="1" Text="{Binding PositionThreshold, StringFormat=F1, UpdateSourceTrigger=PropertyChanged}" 
                                             Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Depth Smoothing -->
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            IsEnabled="{Binding EnableSmoothing}">
                        <StackPanel>
                            <CheckBox Content="Smooth Depth" IsChecked="{Binding SmoothDepth}" Margin="0,0,0,8"/>
                            <CheckBox Content="Smooth Altitude" IsChecked="{Binding SmoothAltitude}" Margin="0,0,0,8"
                                      ToolTip="Uses same method and settings as Depth smoothing"/>
                            
                            <TextBlock Text="Method:" FontSize="11" Margin="0,0,0,3"/>
                            <ComboBox ItemsSource="{Binding SmoothingMethods}" 
                                      SelectedItem="{Binding DepthSmoothingMethod}" 
                                      Margin="0,0,0,8" Height="28"/>

                            <StackPanel Visibility="{Binding ShowDepthWindowSize, Converter={StaticResource BoolToVisibility}}">
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="60"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Window Size:" FontSize="11"/>
                                        <Slider Value="{Binding DepthWindowSize}"  
                                                TickFrequency="2" IsSnapToTickEnabled="True" Margin="0,3,0,0"/>
                                    </StackPanel>
                                    <TextBox Grid.Column="1" Text="{Binding DepthWindowSize, UpdateSourceTrigger=PropertyChanged}" 
                                             Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                </Grid>
                            </StackPanel>

                            <StackPanel Visibility="{Binding ShowDepthThreshold, Converter={StaticResource BoolToVisibility}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="60"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Threshold:" FontSize="11"/>
                                        <Slider Value="{Binding DepthThreshold}"   
                                                TickFrequency="0.1" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                    </StackPanel>
                                    <TextBox Grid.Column="1" Text="{Binding DepthThreshold, StringFormat=F2, UpdateSourceTrigger=PropertyChanged}" 
                                             Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                                </Grid>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Kalman Filter Options (shown when either uses Kalman) -->
                    <Border Padding="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="4" Margin="0,0,0,10"
                            Visibility="{Binding ShowKalmanOptions, Converter={StaticResource BoolToVisibility}}"
                            IsEnabled="{Binding EnableSmoothing}">
                        <StackPanel>
                            <TextBlock Text="Kalman Filter Settings" FontWeight="SemiBold" FontSize="11" Margin="0,0,0,8"/>
                            
                            <Grid Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Process Noise:" FontSize="11"/>
                                    <Slider Value="{Binding KalmanProcessNoise}"   
                                            TickFrequency="0.01" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                </StackPanel>
                                <TextBox Grid.Column="1" Text="{Binding KalmanProcessNoise, StringFormat=F3, UpdateSourceTrigger=PropertyChanged}" 
                                         Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                            </Grid>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="60"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Measurement Noise:" FontSize="11"/>
                                    <Slider Value="{Binding KalmanMeasurementNoise}"   
                                            TickFrequency="0.1" IsSnapToTickEnabled="False" Margin="0,3,0,0"/>
                                </StackPanel>
                                <TextBox Grid.Column="1" Text="{Binding KalmanMeasurementNoise, StringFormat=F2, UpdateSourceTrigger=PropertyChanged}" 
                                         Height="24" VerticalAlignment="Bottom" Margin="5,0,0,0"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <Separator Margin="0,5,0,15"/>

                    <!-- Progress - Made More Prominent -->
                    <Border Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                        <StackPanel>
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="ðŸ“Š Processing Progress" FontWeight="Bold" FontSize="14"/>
                                <TextBlock Grid.Column="1" Text="{Binding Progress, StringFormat={}{0:F0}%}" FontWeight="Bold" FontSize="14"
                                           Foreground="{DynamicResource AccentBrush}"/>
                            </Grid>
                            <ProgressBar Value="{Binding Progress, Mode=OneWay}" Height="30" Margin="0,0,0,10"
                                         Foreground="{DynamicResource AccentBrush}"/>
                            <TextBlock Text="{Binding StatusMessage}" FontSize="12" TextWrapping="Wrap"
                                       Foreground="{DynamicResource SecondaryTextBrush}"/>
                        </StackPanel>
                    </Border>

                    <!-- Processing Log -->
                    <Grid Margin="0,20,0,5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Log" FontWeight="SemiBold"/>
                        <Button Grid.Column="1" Content="Copy" Width="50" Height="22" FontSize="10"
                                Click="CopyLog_Click" Margin="0,0,5,0" ToolTip="Copy log to clipboard"/>
                        <Button Grid.Column="2" Content="Save" Width="50" Height="22" FontSize="10"
                                Click="SaveLog_Click" ToolTip="Save log to file"/>
                    </Grid>
                    <ListBox ItemsSource="{Binding ProcessingLog}" Height="80" FontSize="10"
                             Background="{DynamicResource PanelBackgroundBrush}"/>
                </StackPanel>
            </ScrollViewer>
        </Border>

        <!-- Bottom Stats -->
        <Border Grid.Row="2" Grid.ColumnSpan="2" Background="{DynamicResource PanelBackgroundBrush}" 
                Padding="20,10" Margin="20,0,20,20">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0">
                    <TextBlock Text="Total Points" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <TextBlock Text="{Binding TotalPoints}" FontSize="18" FontWeight="SemiBold"/>
                </StackPanel>

                <StackPanel Grid.Column="1">
                    <TextBlock Text="KP Range" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <TextBlock Text="{Binding KpRange}" FontSize="14"/>
                </StackPanel>

                <StackPanel Grid.Column="2">
                    <TextBlock Text="Generated Layers" FontSize="11" Foreground="{DynamicResource SecondaryTextBrush}"/>
                    <TextBlock Text="{Binding GeneratedLayersInfo}" FontSize="14"/>
                </StackPanel>

                <Button Grid.Column="3" Content="ðŸ“Š Charts" Width="90" Height="35"
                        Click="OpenCharts_Click" IsEnabled="{Binding IsProcessed}"
                        ToolTip="Open survey data charts" Margin="0,0,10,0"
                        Background="#4CAF50" Foreground="White"/>
                
                <Button Grid.Column="4" Content="âœï¸ Editor" Width="90" Height="35"
                        Click="OpenEditor_Click" IsEnabled="{Binding IsProcessed}"
                        ToolTip="Open survey editor to view all generated layers" Margin="0,0,10,0"
                        Background="#FF9800" Foreground="White"/>

                <Button Grid.Column="5" Content="Process Data" Width="120" Height="35"
                        Style="{DynamicResource AccentButtonStyle}"
                        Click="Process_Click" IsEnabled="{Binding CanProcess}"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
