<UserControl x:Class="FathomOS.Modules.SurveyLogbook.Views.DvrRecordingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:FathomOS.Modules.SurveyLogbook.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="Transparent">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:NullToDefaultConverter x:Key="NullToDefault"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Toolbar -->
            <RowDefinition Height="*"/>     <!-- Content -->
            <RowDefinition Height="Auto"/>  <!-- Statistics -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- TOOLBAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" 
                Style="{DynamicResource CardBorder}"
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search Box -->
                <Grid Grid.Column="0">
                    <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                             Style="{DynamicResource ModernTextBox}"
                             Padding="35,8,10,8"
                             mah:TextBoxHelper.Watermark="Search recordings..."/>
                    <iconPacks:PackIconMaterial Kind="Magnify" 
                                                Width="16" Height="16"
                                                Foreground="{DynamicResource TextSecondaryBrush}"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Left"
                                                Margin="10,0,0,0"
                                                IsHitTestVisible="False"/>
                </Grid>

                <!-- Date Range -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="15,0">
                    <TextBlock Text="From:" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <DatePicker SelectedDate="{Binding FilterStartDate}"
                                Width="120"
                                Margin="0,0,15,0"/>
                    
                    <TextBlock Text="To:" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <DatePicker SelectedDate="{Binding FilterEndDate}"
                                Width="120"/>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Command="{Binding RefreshDvrCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            ToolTip="Refresh from DVR folder"
                            Margin="0,0,10,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Refresh" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Refresh"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Command="{Binding BrowseDvrFolderCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            ToolTip="Select DVR folder">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="FolderOpen" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Browse"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- DVR RECORDINGS GRID -->
        <!-- ============================================================ -->
        <Border Grid.Row="1" 
                Style="{DynamicResource CardBorder}"
                Padding="0">
            <DataGrid ItemsSource="{Binding DvrRecordingsView}"
                      SelectedItem="{Binding SelectedDvrRecording}"
                      Style="{DynamicResource ModernDataGrid}"
                      ColumnHeaderStyle="{DynamicResource ModernDataGridColumnHeader}"
                      CellStyle="{DynamicResource ModernDataGridCell}"
                      RowStyle="{DynamicResource ModernDataGridRow}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      VirtualizingPanel.IsVirtualizing="True">
                
                <DataGrid.Columns>
                    <!-- Icon -->
                    <DataGridTemplateColumn Header="" Width="40" CanUserResize="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <iconPacks:PackIconMaterial Kind="Video" 
                                                            Foreground="#E74C3C"
                                                            Width="16" Height="16"
                                                            HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Date -->
                    <DataGridTextColumn Header="Date" 
                                        Binding="{Binding Date, StringFormat='dd/MM/yyyy'}"
                                        Width="100"/>
                    
                    <!-- Start Time -->
                    <DataGridTextColumn Header="Start Time" 
                                        Binding="{Binding StartDateTime, StringFormat='HH:mm:ss'}"
                                        Width="90"/>
                    
                    <!-- Duration -->
                    <DataGridTextColumn Header="Duration" 
                                        Binding="{Binding Duration, StringFormat='hh\\:mm\\:ss'}"
                                        Width="80"/>
                    
                    <!-- Channel -->
                    <DataGridTextColumn Header="Channel" 
                                        Binding="{Binding Channel}"
                                        Width="80"/>
                    
                    <!-- File Name -->
                    <DataGridTextColumn Header="File Name" 
                                        Binding="{Binding FileName}"
                                        Width="200"/>
                    
                    <!-- Description -->
                    <DataGridTextColumn Header="Description" 
                                        Binding="{Binding Description}"
                                        Width="*"/>
                    
                    <!-- File Size -->
                    <DataGridTextColumn Header="Size" 
                                        Binding="{Binding FileSizeMB, StringFormat='{}{0:F1} MB'}"
                                        Width="80"/>
                    
                    <!-- Actions -->
                    <DataGridTemplateColumn Header="Actions" Width="100" CanUserResize="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Command="{Binding DataContext.OpenDvrFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Style="{DynamicResource IconButton}"
                                            ToolTip="Open in default player"
                                            Width="28" Height="28"
                                            Margin="0,0,5,0">
                                        <iconPacks:PackIconMaterial Kind="Play" Width="12" Height="12"/>
                                    </Button>
                                    <Button Command="{Binding DataContext.OpenDvrFolderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}"
                                            Style="{DynamicResource IconButton}"
                                            ToolTip="Open containing folder"
                                            Width="28" Height="28">
                                        <iconPacks:PackIconMaterial Kind="FolderOpen" Width="12" Height="12"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- ============================================================ -->
        <!-- STATISTICS & SELECTED DETAILS -->
        <!-- ============================================================ -->
        <Border Grid.Row="2" 
                Style="{DynamicResource CardBorder}"
                Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Statistics -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Total Recordings -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Video" 
                                                        Width="14" Height="14"
                                                        Foreground="#E74C3C"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Total: "/>
                                <Run Text="{Binding TotalRecordings, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Total Duration -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="ClockOutline" 
                                                        Width="14" Height="14"
                                                        Foreground="{DynamicResource AccentBrush}"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Duration: "/>
                                <Run Text="{Binding TotalDuration, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Total Size -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Harddisk" 
                                                        Width="14" Height="14"
                                                        Foreground="{DynamicResource InfoBrush}"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Size: "/>
                                <Run Text="{Binding TotalSize, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Export Button -->
                <Button Grid.Column="1" 
                        Command="{Binding ExportDvrListCommand}"
                        Style="{DynamicResource SecondaryButton}">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="Export" Width="14" Height="14" Margin="0,0,8,0"/>
                        <TextBlock Text="Export DVR List"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>
