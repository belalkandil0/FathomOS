<mah:MetroWindow x:Class="FathomOS.Modules.SurveyLogbook.Views.FieldConfigurationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:converters="clr-namespace:FathomOS.Modules.SurveyLogbook.Converters"
        xmlns:vm="clr-namespace:FathomOS.Modules.SurveyLogbook.ViewModels"
        mc:Ignorable="d"
        Title="Field Configuration - NaviPac UDO Mapping"
        Height="700" Width="1000"
        MinHeight="550" MinWidth="850"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}"
        BorderBrush="{DynamicResource AccentBrush}"
        BorderThickness="1"
        GlowBrush="{DynamicResource AccentBrush}"
        TitleCharacterCasing="Normal"
        ShowIconOnTitleBar="True"
        Icon="/FathomOS.Modules.SurveyLogbook;component/Assets/icon.png">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        
        <!-- DataType display converter -->
        <Style x:Key="FieldListItemStyle" TargetType="ListBoxItem">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="8,6"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Header -->
            <RowDefinition Height="*"/>     <!-- Content -->
            <RowDefinition Height="Auto"/>  <!-- Buttons -->
            <RowDefinition Height="Auto"/>  <!-- Status -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- HEADER -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="15,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0">
                    <TextBlock Text="NaviPac Field Configuration" 
                               FontSize="18" FontWeight="SemiBold"
                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBlock Text="Define how incoming NaviPac UDO data fields are mapped and displayed"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               Margin="0,4,0,0"/>
                </StackPanel>
                
                <!-- Separator Selection -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Field Separator:" 
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"
                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                    <ComboBox Width="120"
                              SelectedItem="{Binding CurrentSeparator}"
                              ItemsSource="{Binding Separators}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- MAIN CONTENT -->
        <!-- ============================================================ -->
        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350"/>  <!-- Field List -->
                <ColumnDefinition Width="15"/>   <!-- Spacer -->
                <ColumnDefinition Width="*"/>    <!-- Field Details -->
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Field List -->
            <Border Grid.Column="0" 
                    Style="{DynamicResource CardBorder}"
                    Padding="0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Field List Header -->
                    <Border Grid.Row="0" 
                            Background="{DynamicResource SurfaceBrush}"
                            Padding="12,10"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="Fields" 
                                       FontWeight="SemiBold"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                            
                            <TextBlock Grid.Column="1"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="{Binding Fields.Count, Mode=OneWay}"/>
                                <Run Text=" fields"/>
                            </TextBlock>
                        </Grid>
                    </Border>

                    <!-- Field List -->
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding Fields}"
                             SelectedItem="{Binding SelectedField}"
                             ItemContainerStyle="{StaticResource FieldListItemStyle}"
                             Background="Transparent"
                             BorderThickness="0"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="35"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Position Badge -->
                                    <Border Grid.Column="0"
                                            Background="{DynamicResource AccentBrush}"
                                            CornerRadius="3"
                                            Padding="6,2"
                                            HorizontalAlignment="Left"
                                            VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Position}" 
                                                   FontSize="11" FontWeight="Bold"
                                                   Foreground="White"
                                                   HorizontalAlignment="Center"/>
                                    </Border>
                                    
                                    <!-- Field Name -->
                                    <StackPanel Grid.Column="1" Margin="8,0,0,0" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding FieldName}" 
                                                   FontWeight="Medium"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <TextBlock Text="{Binding DataType}" 
                                                   FontSize="11"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    </StackPanel>
                                    
                                    <!-- Show in Log Indicator -->
                                    <iconPacks:PackIconMaterial Grid.Column="2"
                                                                Kind="Eye"
                                                                Width="14" Height="14"
                                                                VerticalAlignment="Center"
                                                                Foreground="{DynamicResource SuccessBrush}"
                                                                Visibility="{Binding ShowInLog, Converter={StaticResource BoolToVisibility}}"
                                                                ToolTip="Shown in Survey Log"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Field List Toolbar -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource SurfaceBrush}"
                            Padding="8"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0">
                        <StackPanel Orientation="Horizontal">
                            <Button Command="{Binding AddFieldCommand}" 
                                    ToolTip="Add Field"
                                    Style="{DynamicResource SecondaryButton}"
                                    Padding="8,4" Margin="0,0,4,0">
                                <iconPacks:PackIconMaterial Kind="Plus" Width="14" Height="14"/>
                            </Button>
                            <Button Command="{Binding RemoveFieldCommand}" 
                                    ToolTip="Remove Field"
                                    Style="{DynamicResource SecondaryButton}"
                                    Padding="8,4" Margin="0,0,4,0">
                                <iconPacks:PackIconMaterial Kind="Minus" Width="14" Height="14"/>
                            </Button>
                            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" 
                                       Margin="4,0" Width="1" Background="{DynamicResource BorderBrush}"/>
                            <Button Command="{Binding MoveUpCommand}" 
                                    ToolTip="Move Up"
                                    Style="{DynamicResource SecondaryButton}"
                                    Padding="8,4" Margin="0,0,4,0">
                                <iconPacks:PackIconMaterial Kind="ArrowUp" Width="14" Height="14"/>
                            </Button>
                            <Button Command="{Binding MoveDownCommand}" 
                                    ToolTip="Move Down"
                                    Style="{DynamicResource SecondaryButton}"
                                    Padding="8,4" Margin="0,0,4,0">
                                <iconPacks:PackIconMaterial Kind="ArrowDown" Width="14" Height="14"/>
                            </Button>
                            <Separator Style="{StaticResource {x:Static ToolBar.SeparatorStyleKey}}" 
                                       Margin="4,0" Width="1" Background="{DynamicResource BorderBrush}"/>
                            <Button Command="{Binding DuplicateFieldCommand}" 
                                    ToolTip="Duplicate Field"
                                    Style="{DynamicResource SecondaryButton}"
                                    Padding="8,4">
                                <iconPacks:PackIconMaterial Kind="ContentCopy" Width="14" Height="14"/>
                            </Button>
                        </StackPanel>
                    </Border>
                </Grid>
            </Border>

            <!-- Right Panel: Field Details -->
            <Border Grid.Column="2" 
                    Style="{DynamicResource CardBorder}"
                    Padding="0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Details Header -->
                    <Border Grid.Row="0" 
                            Background="{DynamicResource SurfaceBrush}"
                            Padding="12,10"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,0,0,1">
                        <TextBlock Text="Field Properties" 
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                    </Border>

                    <!-- Field Details Form -->
                    <ScrollViewer Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto"
                                  Padding="15">
                        <Grid>
                            <!-- No Selection Message -->
                            <StackPanel Visibility="{Binding HasSelectedField, Converter={StaticResource InverseBoolToVisibility}}"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Center">
                                <iconPacks:PackIconMaterial Kind="GestureTapButton"
                                                            Width="48" Height="48"
                                                            Foreground="{DynamicResource TextSecondaryBrush}"
                                                            HorizontalAlignment="Center"/>
                                <TextBlock Text="Select a field to edit its properties"
                                           FontSize="14"
                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                           Margin="0,15,0,0"
                                           HorizontalAlignment="Center"/>
                            </StackPanel>

                            <!-- Field Properties Form -->
                            <Grid Visibility="{Binding HasSelectedField, Converter={StaticResource BoolToVisibility}}"
                                  DataContext="{Binding SelectedField}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="130"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Position -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Position:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <mah:NumericUpDown Grid.Row="0" Grid.Column="1"
                                               Value="{Binding Position}"
                                               Minimum="0" Maximum="100"
                                               Margin="0,0,0,12"/>

                            <!-- Field Name -->
                            <TextBlock Grid.Row="1" Grid.Column="0"
                                       Text="Field Name:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Grid.Row="1" Grid.Column="1"
                                     Text="{Binding FieldName, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,0,12"/>

                            <!-- Data Type -->
                            <TextBlock Grid.Row="2" Grid.Column="0"
                                       Text="Data Type:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <ComboBox Grid.Row="2" Grid.Column="1"
                                      ItemsSource="{Binding DataContext.DataTypes, RelativeSource={RelativeSource AncestorType=Window}}"
                                      SelectedItem="{Binding DataType}"
                                      Margin="0,0,0,12"/>

                            <!-- Show in Log -->
                            <TextBlock Grid.Row="3" Grid.Column="0"
                                       Text="Show in Log:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <CheckBox Grid.Row="3" Grid.Column="1"
                                      IsChecked="{Binding ShowInLog}"
                                      Content="Display this field in Survey Log table"
                                      VerticalAlignment="Center"
                                      Margin="0,0,0,12"/>

                            <!-- Decimal Places -->
                            <TextBlock Grid.Row="4" Grid.Column="0"
                                       Text="Decimal Places:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <mah:NumericUpDown Grid.Row="4" Grid.Column="1"
                                               Value="{Binding DecimalPlaces}"
                                               Minimum="0" Maximum="10"
                                               Margin="0,0,0,12"/>

                            <!-- Unit -->
                            <TextBlock Grid.Row="5" Grid.Column="0"
                                       Text="Unit:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Grid.Row="5" Grid.Column="1"
                                     Text="{Binding Unit, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,0,12"/>

                            <!-- Scale Factor -->
                            <TextBlock Grid.Row="6" Grid.Column="0"
                                       Text="Scale Factor:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Grid.Row="6" Grid.Column="1"
                                     Text="{Binding ScaleFactor, UpdateSourceTrigger=PropertyChanged}"
                                     mah:TextBoxHelper.Watermark="Optional (e.g., 0.001)"
                                     Margin="0,0,0,12"/>

                            <!-- Offset -->
                            <TextBlock Grid.Row="7" Grid.Column="0"
                                       Text="Offset:"
                                       VerticalAlignment="Center"
                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <TextBox Grid.Row="7" Grid.Column="1"
                                     Text="{Binding Offset, UpdateSourceTrigger=PropertyChanged}"
                                     mah:TextBoxHelper.Watermark="Optional (added after scale)"/>
                            </Grid>
                        </Grid>
                    </ScrollViewer>

                    <!-- Templates Panel -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource SurfaceBrush}"
                            Padding="12"
                            BorderBrush="{DynamicResource BorderBrush}"
                            BorderThickness="0,1,0,0">
                        <Expander Header="Templates &amp; Quick Actions" IsExpanded="False">
                            <StackPanel Margin="0,10,0,0">
                                
                                <!-- Template Selection -->
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <ComboBox Grid.Column="0"
                                              ItemsSource="{Binding Templates}"
                                              SelectedItem="{Binding SelectedTemplate}"
                                              DisplayMemberPath="Name"
                                              Margin="0,0,8,0"/>
                                    
                                    <Button Grid.Column="1"
                                            Command="{Binding ApplyTemplateCommand}"
                                            Content="Apply"
                                            Style="{DynamicResource SecondaryButton}"
                                            Padding="15,5"/>
                                </Grid>
                                
                                <!-- Quick Action Buttons -->
                                <WrapPanel>
                                    <Button Command="{Binding SaveTemplateCommand}" 
                                            Content="Save as Template"
                                            Style="{DynamicResource SecondaryButton}"
                                            Margin="0,0,8,8"/>
                                    <Button Command="{Binding ResetToDefaultCommand}" 
                                            Content="Reset to Default"
                                            Style="{DynamicResource SecondaryButton}"
                                            Margin="0,0,8,8"/>
                                    <Button Command="{Binding ImportFromFileCommand}" 
                                            Content="Import..."
                                            Style="{DynamicResource SecondaryButton}"
                                            Margin="0,0,8,8"/>
                                    <Button Command="{Binding ExportToFileCommand}" 
                                            Content="Export..."
                                            Style="{DynamicResource SecondaryButton}"
                                            Margin="0,0,8,8"/>
                                    <Button Command="{Binding ClearAllCommand}" 
                                            Content="Clear All"
                                            Style="{DynamicResource SecondaryButton}"
                                            Margin="0,0,0,8"/>
                                </WrapPanel>
                            </StackPanel>
                        </Expander>
                    </Border>
                </Grid>
            </Border>
        </Grid>

        <!-- ============================================================ -->
        <!-- BUTTON BAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="15,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Changes Indicator -->
                <StackPanel Grid.Column="0" 
                            Orientation="Horizontal"
                            Visibility="{Binding HasChanges, Converter={StaticResource BoolToVisibility}}">
                    <iconPacks:PackIconMaterial Kind="AlertCircle" 
                                                Width="16" Height="16"
                                                Foreground="{DynamicResource WarningBrush}"
                                                VerticalAlignment="Center"/>
                    <TextBlock Text="You have unsaved changes"
                               Foreground="{DynamicResource WarningBrush}"
                               VerticalAlignment="Center"
                               Margin="8,0,0,0"/>
                </StackPanel>

                <!-- Action Buttons -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Command="{Binding CancelCommand}"
                            Content="Cancel"
                            Style="{DynamicResource SecondaryButton}"
                            Width="100"
                            Margin="0,0,10,0"/>
                    <Button Command="{Binding SaveCommand}"
                            Content="Save"
                            Style="{DynamicResource PrimaryButton}"
                            Width="100"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- STATUS BAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="3" 
                Background="{DynamicResource CardBrush}"
                Padding="15,8">
            <TextBlock Text="{Binding StatusMessage}"
                       Foreground="{DynamicResource TextSecondaryBrush}"
                       FontSize="12"/>
        </Border>
    </Grid>
</mah:MetroWindow>
