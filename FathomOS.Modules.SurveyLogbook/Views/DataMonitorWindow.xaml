<mah:MetroWindow x:Class="FathomOS.Modules.SurveyLogbook.Views.DataMonitorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:converters="clr-namespace:FathomOS.Modules.SurveyLogbook.Converters"
        xmlns:vm="clr-namespace:FathomOS.Modules.SurveyLogbook.ViewModels"
        mc:Ignorable="d"
        Title="NaviPac Data Monitor - Survey Electronic Logbook"
        Height="750" Width="1100"
        MinHeight="500" MinWidth="800"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}"
        BorderBrush="{DynamicResource AccentBrush}"
        BorderThickness="1"
        GlowBrush="{DynamicResource AccentBrush}"
        TitleCharacterCasing="Normal"
        Closing="Window_Closing">

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        
        <!-- Status indicator color converter -->
        <SolidColorBrush x:Key="GreenBrush" Color="#2ECC71"/>
        <SolidColorBrush x:Key="OrangeBrush" Color="#F39C12"/>
        <SolidColorBrush x:Key="RedBrush" Color="#E74C3C"/>
        <SolidColorBrush x:Key="GrayBrush" Color="#95A5A6"/>
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Status bar -->
            <RowDefinition Height="*"/>      <!-- Main content -->
            <RowDefinition Height="Auto"/>  <!-- Toolbar -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- STATUS BAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SurfaceBrush}" 
                CornerRadius="6" 
                Padding="15,12" 
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Connection Status -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,30,0">
                    <Ellipse Width="12" Height="12" Margin="0,0,10,0" VerticalAlignment="Center">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{StaticResource GrayBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ConnectionStatusColor}" Value="Green">
                                        <Setter Property="Fill" Value="{StaticResource GreenBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ConnectionStatusColor}" Value="Orange">
                                        <Setter Property="Fill" Value="{StaticResource OrangeBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding ConnectionStatusColor}" Value="Red">
                                        <Setter Property="Fill" Value="{StaticResource RedBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <StackPanel>
                        <TextBlock Text="{Binding ConnectionStatus}" 
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBlock Text="{Binding ProtocolInfo}" 
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Messages Count -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="0,0,30,0">
                    <iconPacks:PackIconMaterial Kind="Email" Width="16" Height="16" 
                                                Foreground="{DynamicResource AccentBrush}"
                                                Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <StackPanel>
                        <TextBlock Text="{Binding TotalMessages, StringFormat='{}{0:N0} messages'}" 
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBlock Text="{Binding TotalBytesFormatted}" 
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Rate -->
                <StackPanel Grid.Column="3" Orientation="Horizontal" Margin="0,0,30,0">
                    <iconPacks:PackIconMaterial Kind="Speedometer" Width="16" Height="16" 
                                                Foreground="{DynamicResource AccentBrush}"
                                                Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <StackPanel>
                        <TextBlock Text="{Binding RateDisplay}" 
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBlock Text="Current rate" 
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Last Data -->
                <StackPanel Grid.Column="4" Orientation="Horizontal" Margin="0,0,30,0">
                    <iconPacks:PackIconMaterial Kind="ClockOutline" Width="16" Height="16" 
                                                Foreground="{DynamicResource AccentBrush}"
                                                Margin="0,0,8,0" VerticalAlignment="Center"/>
                    <StackPanel>
                        <TextBlock Text="{Binding LastDataTimeDisplay}" 
                                   FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        <TextBlock Text="{Binding TimeSinceLastData}" 
                                   FontSize="11"
                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Pause Indicator -->
                <Border Grid.Column="5" 
                        Background="#E74C3C" 
                        CornerRadius="4" 
                        Padding="10,5"
                        Visibility="{Binding IsPaused, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="Pause" Width="14" Height="14" 
                                                    Foreground="White"
                                                    Margin="0,0,6,0"/>
                        <TextBlock Text="PAUSED" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- MAIN CONTENT - Split View -->
        <!-- ============================================================ -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MinWidth="300"/>
                <ColumnDefinition Width="5"/>
                <ColumnDefinition Width="350" MinWidth="250"/>
            </Grid.ColumnDefinitions>

            <!-- RAW DATA MESSAGES -->
            <Border Grid.Column="0" Style="{DynamicResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <iconPacks:PackIconMaterial Kind="FormatListBulletedSquare" Width="18" Height="18" 
                                                    Foreground="{DynamicResource AccentBrush}"
                                                    Margin="0,0,10,0" VerticalAlignment="Center"/>
                        <TextBlock Text="Raw Data Messages" 
                                   FontSize="15" FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding RawMessages.Count, StringFormat=' ({0})'}" 
                                   FontSize="13"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Messages List -->
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding RawMessages}"
                             SelectedItem="{Binding SelectedMessage}"
                             Background="{DynamicResource SurfaceBrush}"
                             BorderThickness="1"
                             BorderBrush="{DynamicResource BorderBrush}"
                             ScrollViewer.HorizontalScrollBarVisibility="Auto"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             FontFamily="Consolas"
                             FontSize="12"
                             x:Name="MessagesListBox">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Display}" 
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           TextTrimming="CharacterEllipsis"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                                <Setter Property="Padding" Value="8,4"/>
                                <Setter Property="Margin" Value="0"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Grid Splitter -->
            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center" 
                          Background="Transparent"/>

            <!-- PARSED FIELDS PANEL -->
            <Border Grid.Column="2" Style="{DynamicResource CardBorder}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Header -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <iconPacks:PackIconMaterial Kind="CodeBraces" Width="18" Height="18" 
                                                    Foreground="{DynamicResource AccentBrush}"
                                                    Margin="0,0,10,0" VerticalAlignment="Center"/>
                        <TextBlock Text="Parsed Fields" 
                                   FontSize="15" FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Separator Selection -->
                    <Grid Grid.Row="1" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="Separator:" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <ComboBox Grid.Column="1" 
                                  SelectedValue="{Binding SelectedSeparator}"
                                  SelectedValuePath="Tag">
                            <ComboBoxItem Content="Comma (,)" Tag=","/>
                            <ComboBoxItem Content="Space" Tag="Space"/>
                            <ComboBoxItem Content="Semicolon (;)" Tag=";"/>
                            <ComboBoxItem Content="Colon (:)" Tag=":"/>
                            <ComboBoxItem Content="Tab" Tag="Tab"/>
                        </ComboBox>
                    </Grid>

                    <!-- Selected Message Preview -->
                    <Border Grid.Row="2" 
                            Background="{DynamicResource SurfaceBrush}"
                            CornerRadius="4" 
                            Padding="10" 
                            Margin="0,0,0,10">
                        <TextBox Text="{Binding SelectedMessageText, Mode=OneWay}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 MaxHeight="80"
                                 FontFamily="Consolas"
                                 FontSize="11"
                                 Background="Transparent"
                                 BorderThickness="0"
                                 Foreground="{DynamicResource TextPrimaryBrush}"
                                 VerticalScrollBarVisibility="Auto"/>
                    </Border>

                    <!-- Fields Grid -->
                    <DataGrid Grid.Row="3"
                              ItemsSource="{Binding ParsedFields}"
                              AutoGenerateColumns="False"
                              IsReadOnly="True"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal"
                              CanUserReorderColumns="False"
                              CanUserResizeRows="False"
                              SelectionMode="Single"
                              Background="{DynamicResource SurfaceBrush}"
                              BorderThickness="1"
                              BorderBrush="{DynamicResource BorderBrush}"
                              FontSize="12">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="35"/>
                            <DataGridTextColumn Header="Value" Binding="{Binding RawValue}" Width="*">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontFamily" Value="Consolas"/>
                                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Detected" Binding="{Binding DetectedType}" Width="100"/>
                            <DataGridTextColumn Header="Guess" Binding="{Binding AssignedName}" Width="120"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>

        <!-- ============================================================ -->
        <!-- BOTTOM TOOLBAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SurfaceBrush}" 
                CornerRadius="6" 
                Padding="10" 
                Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Left buttons -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Command="{Binding ClearCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            Margin="0,0,10,0"
                            ToolTip="Clear all messages">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Delete" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Clear"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding PauseCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            Margin="0,0,10,0"
                            ToolTip="Pause/Resume message collection">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Width="14" Height="14" Margin="0,0,6,0">
                                <iconPacks:PackIconMaterial.Style>
                                    <Style TargetType="iconPacks:PackIconMaterial">
                                        <Setter Property="Kind" Value="Pause"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                                <Setter Property="Kind" Value="Play"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </iconPacks:PackIconMaterial.Style>
                            </iconPacks:PackIconMaterial>
                            <TextBlock Text="{Binding PauseButtonText}"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding ExportLogCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            Margin="0,0,10,0"
                            ToolTip="Export log to file">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Export" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Export Log"/>
                        </StackPanel>
                    </Button>

                    <Button Command="{Binding CopySelectedMessageCommand}"
                            Style="{DynamicResource SecondaryButton}"
                            Margin="0,0,10,0"
                            ToolTip="Copy selected message to clipboard">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="ContentCopy" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Copy Message"/>
                        </StackPanel>
                    </Button>

                    <Separator Style="{DynamicResource {x:Static ToolBar.SeparatorStyleKey}}" Margin="10,0"/>

                    <CheckBox Content="Auto-scroll to latest" 
                              IsChecked="{Binding AutoScroll}"
                              Foreground="{DynamicResource TextPrimaryBrush}"
                              VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Right - Test button (for development) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Click="TestButton_Click"
                            Style="{DynamicResource SecondaryButton}"
                            ToolTip="Send test message (for debugging)">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="TestTube" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Test"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</mah:MetroWindow>
