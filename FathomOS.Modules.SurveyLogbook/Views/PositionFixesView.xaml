<UserControl x:Class="FathomOS.Modules.SurveyLogbook.Views.PositionFixesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:FathomOS.Modules.SurveyLogbook.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="Transparent">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:NullToDefaultConverter x:Key="NullToDefault"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Toolbar -->
            <RowDefinition Height="*"/>     <!-- Content -->
            <RowDefinition Height="Auto"/>  <!-- Statistics -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- TOOLBAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" 
                Style="{DynamicResource CardBorder}"
                Margin="0,0,0,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Search Box -->
                <Grid Grid.Column="0" Margin="0,0,15,0">
                    <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                             Style="{DynamicResource ModernTextBox}"
                             Padding="35,8,10,8"
                             mah:TextBoxHelper.Watermark="Search fixes..."/>
                    <iconPacks:PackIconMaterial Kind="Magnify" 
                                                Width="16" Height="16"
                                                Foreground="{DynamicResource TextSecondaryBrush}"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Left"
                                                Margin="10,0,0,0"
                                                IsHitTestVisible="False"/>
                </Grid>

                <!-- Fix Type Filter -->
                <ComboBox Grid.Column="1" 
                          ItemsSource="{Binding FixTypes}"
                          SelectedItem="{Binding SelectedFixType}"
                          Margin="0,0,15,0"
                          Padding="10,8"/>

                <!-- Date Range -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="From:" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <DatePicker SelectedDate="{Binding FilterStartDate}"
                                Width="120"
                                Margin="0,0,15,0"/>
                    
                    <TextBlock Text="To:" 
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"/>
                    <DatePicker SelectedDate="{Binding FilterEndDate}"
                                Width="120"/>
                </StackPanel>

                <!-- Clear Filter -->
                <Button Grid.Column="3" 
                        Command="{Binding ClearFilterCommand}"
                        Style="{DynamicResource IconButton}"
                        ToolTip="Clear all filters">
                    <iconPacks:PackIconMaterial Kind="FilterRemove" Width="16" Height="16"/>
                </Button>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- POSITION FIXES GRID -->
        <!-- ============================================================ -->
        <Border Grid.Row="1" 
                Style="{DynamicResource CardBorder}"
                Padding="0">
            <DataGrid ItemsSource="{Binding PositionFixesView}"
                      SelectedItem="{Binding SelectedPositionFix}"
                      Style="{DynamicResource ModernDataGrid}"
                      ColumnHeaderStyle="{DynamicResource ModernDataGridColumnHeader}"
                      CellStyle="{DynamicResource ModernDataGridCell}"
                      RowStyle="{DynamicResource ModernDataGridRow}"
                      AutoGenerateColumns="False"
                      CanUserAddRows="False"
                      CanUserDeleteRows="False"
                      IsReadOnly="True"
                      SelectionMode="Single"
                      VirtualizingPanel.IsVirtualizing="True">
                
                <DataGrid.Columns>
                    <!-- Icon -->
                    <DataGridTemplateColumn Header="" Width="40" CanUserResize="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <iconPacks:PackIconMaterial Kind="MapMarker" 
                                                            Foreground="#2ECC71"
                                                            Width="16" Height="16"
                                                            HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Date -->
                    <DataGridTextColumn Header="Date" 
                                        Binding="{Binding Date, StringFormat='dd/MM/yyyy'}"
                                        Width="100"/>
                    
                    <!-- Time -->
                    <DataGridTextColumn Header="Time" 
                                        Binding="{Binding Time, StringFormat='HH:mm:ss'}"
                                        Width="90"/>
                    
                    <!-- Fix Type -->
                    <DataGridTextColumn Header="Fix Type" 
                                        Binding="{Binding FixType}"
                                        Width="120"/>
                    
                    <!-- Object Name -->
                    <DataGridTextColumn Header="Object" 
                                        Binding="{Binding ObjectName}"
                                        Width="120"/>
                    
                    <!-- Easting -->
                    <DataGridTextColumn Header="Easting" 
                                        Binding="{Binding ComputedEasting, StringFormat='F3'}"
                                        Width="120"/>
                    
                    <!-- Northing -->
                    <DataGridTextColumn Header="Northing" 
                                        Binding="{Binding ComputedNorthing, StringFormat='F3'}"
                                        Width="120"/>
                    
                    <!-- Required Easting -->
                    <DataGridTextColumn Header="Req. Easting" 
                                        Binding="{Binding RequiredEasting, StringFormat='F3'}"
                                        Width="120"/>
                    
                    <!-- Required Northing -->
                    <DataGridTextColumn Header="Req. Northing" 
                                        Binding="{Binding RequiredNorthing, StringFormat='F3'}"
                                        Width="120"/>
                    
                    <!-- Error Easting -->
                    <DataGridTextColumn Header="Error E" 
                                        Binding="{Binding ErrorEasting, StringFormat='F3'}"
                                        Width="80"/>
                    
                    <!-- Error Northing -->
                    <DataGridTextColumn Header="Error N" 
                                        Binding="{Binding ErrorNorthing, StringFormat='F3'}"
                                        Width="80"/>
                    
                    <!-- Description -->
                    <DataGridTextColumn Header="Description" 
                                        Binding="{Binding Description}"
                                        Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
        </Border>

        <!-- ============================================================ -->
        <!-- STATISTICS & ACTIONS -->
        <!-- ============================================================ -->
        <Border Grid.Row="2" 
                Style="{DynamicResource CardBorder}"
                Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Statistics -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Total Fixes -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="MapMarker" 
                                                        Width="14" Height="14"
                                                        Foreground="#2ECC71"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Total Fixes: "/>
                                <Run Text="{Binding TotalFixes, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Set Easting/Northing Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Crosshairs" 
                                                        Width="14" Height="14"
                                                        Foreground="{DynamicResource AccentBrush}"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Set E/N: "/>
                                <Run Text="{Binding SetEastingNorthingCount, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Waypoint Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="MapMarkerPath" 
                                                        Width="14" Height="14"
                                                        Foreground="#3498DB"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Waypoints: "/>
                                <Run Text="{Binding WaypointCount, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Calibration Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Tune" 
                                                        Width="14" Height="14"
                                                        Foreground="#9B59B6"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Calibrations: "/>
                                <Run Text="{Binding CalibrationCount, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Command="{Binding AddPositionFixCommand}"
                            Style="{DynamicResource PrimaryButton}"
                            Margin="0,0,10,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Plus" Width="14" Height="14" Margin="0,0,8,0"/>
                            <TextBlock Text="Add Position Fix"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Command="{Binding ExportFixesCommand}"
                            Style="{DynamicResource SecondaryButton}">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Export" Width="14" Height="14" Margin="0,0,8,0"/>
                            <TextBlock Text="Export"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
