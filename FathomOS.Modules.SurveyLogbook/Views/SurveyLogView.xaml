<UserControl x:Class="FathomOS.Modules.SurveyLogbook.Views.SurveyLogView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
             xmlns:converters="clr-namespace:FathomOS.Modules.SurveyLogbook.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             Background="Transparent">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:LogEntryTypeToColorConverter x:Key="EntryTypeToColor"/>
        <converters:LogEntryTypeToIconConverter x:Key="EntryTypeToIcon"/>
        <converters:DateTimeToTimeConverter x:Key="DateTimeToTime"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Filter Bar -->
            <RowDefinition Height="*"/>     <!-- Data Grid -->
            <RowDefinition Height="Auto"/>  <!-- Statistics -->
        </Grid.RowDefinitions>

        <!-- ============================================================ -->
        <!-- FILTER BAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="0" 
                Style="{DynamicResource CardBorder}"
                Margin="0,0,0,15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Row 1: Search and Category -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="200"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Search Box -->
                    <Grid Grid.Column="0" Margin="0,0,15,0">
                        <TextBox Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{DynamicResource ModernTextBox}"
                                 Padding="35,8,10,8"/>
                        <iconPacks:PackIconMaterial Kind="Magnify" 
                                                    Width="16" Height="16"
                                                    Foreground="{DynamicResource TextSecondaryBrush}"
                                                    VerticalAlignment="Center"
                                                    HorizontalAlignment="Left"
                                                    Margin="10,0,0,0"
                                                    IsHitTestVisible="False"/>
                    </Grid>

                    <!-- Category Filter -->
                    <ComboBox Grid.Column="1" 
                              ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding SelectedCategory}"
                              Margin="0,0,15,0"
                              Padding="10,8"/>

                    <!-- Date Range -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="From:" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <DatePicker SelectedDate="{Binding FilterStartDate}"
                                    Width="120"
                                    Margin="0,0,15,0"/>
                        
                        <TextBlock Text="To:" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   Margin="0,0,8,0"/>
                        <DatePicker SelectedDate="{Binding FilterEndDate}"
                                    Width="120"/>
                    </StackPanel>

                    <!-- Clear Filter Button -->
                    <Button Grid.Column="3" 
                            Command="{Binding ClearFilterCommand}"
                            Style="{DynamicResource IconButton}"
                            ToolTip="Clear all filters">
                        <iconPacks:PackIconMaterial Kind="FilterRemove" Width="16" Height="16"/>
                    </Button>
                </Grid>

                <!-- Row 2: Toggle Filters -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,10,0,0">
                    <CheckBox Content="DVR Recordings" 
                              IsChecked="{Binding ShowDvrEntries}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <CheckBox Content="Position Fixes" 
                              IsChecked="{Binding ShowPositionFixes}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <CheckBox Content="NaviPac Events" 
                              IsChecked="{Binding ShowNaviPacEvents}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <CheckBox Content="Manual Entries" 
                              IsChecked="{Binding ShowManualEntries}"
                              Margin="0,0,20,0"
                              Foreground="{DynamicResource TextPrimaryBrush}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ============================================================ -->
        <!-- DATA GRID -->
        <!-- ============================================================ -->
        <Border Grid.Row="1" 
                Style="{DynamicResource CardBorder}"
                Padding="0">
            <DataGrid x:Name="SurveyLogDataGrid"
                      ItemsSource="{Binding EntriesView}"
                      SelectedItem="{Binding SelectedEntry}"
                      Style="{DynamicResource ModernDataGrid}"
                      ColumnHeaderStyle="{DynamicResource ModernDataGridColumnHeader}"
                      CellStyle="{DynamicResource ModernDataGridCell}"
                      RowStyle="{DynamicResource ModernDataGridRow}"
                      VirtualizingPanel.IsVirtualizing="True"
                      VirtualizingPanel.VirtualizationMode="Recycling"
                      EnableRowVirtualization="True"
                      ScrollViewer.CanContentScroll="True"
                      AutoGenerateColumns="False">
                
                <DataGrid.Columns>
                    <!-- Type Icon Column -->
                    <DataGridTemplateColumn Header="" Width="40" CanUserResize="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <iconPacks:PackIconMaterial 
                                    Kind="{Binding EntryType, Converter={StaticResource EntryTypeToIcon}}"
                                    Foreground="{Binding EntryType, Converter={StaticResource EntryTypeToColor}}"
                                    Width="16" Height="16"
                                    HorizontalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Timestamp Column -->
                    <DataGridTextColumn Header="Time" 
                                        Binding="{Binding Timestamp, StringFormat='HH:mm:ss'}"
                                        Width="80"/>
                    
                    <!-- Date Column -->
                    <DataGridTextColumn Header="Date" 
                                        Binding="{Binding Timestamp, StringFormat='dd/MM/yyyy'}"
                                        Width="90"/>
                    
                    <!-- Entry Type Column -->
                    <DataGridTemplateColumn Header="Type" Width="150">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding EntryType}"
                                           Foreground="{Binding EntryType, Converter={StaticResource EntryTypeToColor}}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- Description Column -->
                    <DataGridTextColumn Header="Description" 
                                        Binding="{Binding Description}"
                                        Width="*"/>
                    
                    <!-- Easting Column -->
                    <DataGridTextColumn Header="Easting" 
                                        Binding="{Binding Easting, StringFormat='N3'}"
                                        Width="110"/>
                    
                    <!-- Northing Column -->
                    <DataGridTextColumn Header="Northing" 
                                        Binding="{Binding Northing, StringFormat='N3'}"
                                        Width="120"/>
                    
                    <!-- KP Column -->
                    <DataGridTextColumn Header="KP" 
                                        Binding="{Binding Kp, StringFormat='N3'}"
                                        Width="80"/>
                    
                    <!-- DCC Column -->
                    <DataGridTextColumn Header="DCC" 
                                        Binding="{Binding Dcc, StringFormat='N2'}"
                                        Width="70"/>
                    
                    <!-- Source Column -->
                    <DataGridTextColumn Header="Source" 
                                        Binding="{Binding Source}"
                                        Width="100"/>
                    
                    <!-- Actions Column -->
                    <DataGridTemplateColumn Header="" Width="80" CanUserResize="False">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <Button Command="{Binding DataContext.ViewDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            Style="{DynamicResource IconButton}"
                                            ToolTip="View Details"
                                            Width="28" Height="28">
                                        <iconPacks:PackIconMaterial Kind="Eye" Width="12" Height="12"/>
                                    </Button>
                                    <Button Command="{Binding DataContext.DeleteEntryCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                            CommandParameter="{Binding}"
                                            Style="{DynamicResource IconButton}"
                                            ToolTip="Delete Entry"
                                            Width="28" Height="28">
                                        <iconPacks:PackIconMaterial Kind="Delete" Width="12" Height="12"/>
                                    </Button>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                
                <!-- Context Menu -->
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="View Details" 
                                  Command="{Binding ViewDetailsCommand}"
                                  CommandParameter="{Binding SelectedEntry}">
                            <MenuItem.Icon>
                                <iconPacks:PackIconMaterial Kind="Eye" Width="14" Height="14"/>
                            </MenuItem.Icon>
                        </MenuItem>
                        <MenuItem Header="Copy to Clipboard" 
                                  Command="{Binding CopyToClipboardCommand}"
                                  CommandParameter="{Binding SelectedEntry}">
                            <MenuItem.Icon>
                                <iconPacks:PackIconMaterial Kind="ContentCopy" Width="14" Height="14"/>
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator/>
                        <MenuItem Header="Export Selection" 
                                  Command="{Binding ExportSelectionCommand}">
                            <MenuItem.Icon>
                                <iconPacks:PackIconMaterial Kind="Export" Width="14" Height="14"/>
                            </MenuItem.Icon>
                        </MenuItem>
                        <Separator/>
                        <MenuItem Header="Delete Entry" 
                                  Command="{Binding DeleteEntryCommand}"
                                  CommandParameter="{Binding SelectedEntry}">
                            <MenuItem.Icon>
                                <iconPacks:PackIconMaterial Kind="Delete" Width="14" Height="14"/>
                            </MenuItem.Icon>
                        </MenuItem>
                    </ContextMenu>
                </DataGrid.ContextMenu>
            </DataGrid>
        </Border>

        <!-- ============================================================ -->
        <!-- STATISTICS & ACTIONS BAR -->
        <!-- ============================================================ -->
        <Border Grid.Row="2" 
                Style="{DynamicResource CardBorder}"
                Margin="0,15,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Statistics -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Total Entries -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Counter" 
                                                        Width="14" Height="14"
                                                        Foreground="{DynamicResource AccentBrush}"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Total: "/>
                                <Run Text="{Binding TotalEntries, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Filtered Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Filter" 
                                                        Width="14" Height="14"
                                                        Foreground="{DynamicResource InfoBrush}"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Filtered: "/>
                                <Run Text="{Binding FilteredEntries, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- DVR Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6"
                            Margin="0,0,15,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="Video" 
                                                        Width="14" Height="14"
                                                        Foreground="#3498DB"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="DVR: "/>
                                <Run Text="{Binding DvrCount, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                    
                    <!-- Position Fix Count -->
                    <Border Background="{DynamicResource SurfaceBrush}" 
                            CornerRadius="4" 
                            Padding="12,6">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="MapMarker" 
                                                        Width="14" Height="14"
                                                        Foreground="#2ECC71"
                                                        Margin="0,0,8,0"/>
                            <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                <Run Text="Fixes: "/>
                                <Run Text="{Binding PositionFixCount, Mode=OneWay}" FontWeight="SemiBold" 
                                     Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </StackPanel>

                <!-- Add Manual Entry Button -->
                <Button Grid.Column="1" 
                        Command="{Binding AddManualEntryCommand}"
                        Style="{DynamicResource PrimaryButton}">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="Plus" Width="14" Height="14" Margin="0,0,8,0"/>
                        <TextBlock Text="Add Manual Entry"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>
