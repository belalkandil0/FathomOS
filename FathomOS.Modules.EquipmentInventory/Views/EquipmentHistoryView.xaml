<mah:MetroWindow x:Class="FathomOS.Modules.EquipmentInventory.Views.EquipmentHistoryView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:converters="clr-namespace:FathomOS.Modules.EquipmentInventory.Converters"
        Title="Equipment History - Fathom OS"
        Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">
    
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource HeaderBrush}" Padding="20,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel>
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="History" Width="28" Height="28" 
                                                     VerticalAlignment="Center" Margin="0,0,12,0"
                                                     Foreground="{DynamicResource AccentBrush}"/>
                        <TextBlock Text="Equipment History" FontSize="22" FontWeight="SemiBold"
                                   Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Margin="40,5,0,0" Foreground="{DynamicResource TextSecondaryBrush}">
                        <Run Text="{Binding AssetNumber}"/> - <Run Text="{Binding EquipmentName}"/>
                    </TextBlock>
                </StackPanel>
                
                <Button Grid.Column="1" Command="{Binding ExportCommand}" Style="{DynamicResource SecondaryButton}">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="Export" Width="16" Height="16" Margin="0,0,6,0"/>
                        <TextBlock Text="Export"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
        
        <!-- Filter Bar -->
        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" Padding="20,10">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Filter:" VerticalAlignment="Center" Margin="0,0,10,0"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                <ComboBox ItemsSource="{Binding ActionFilters}" SelectedItem="{Binding SelectedActionFilter}"
                          Width="150" Margin="0,0,20,0"/>
                <TextBlock Text="Date Range:" VerticalAlignment="Center" Margin="0,0,10,0"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                <DatePicker SelectedDate="{Binding StartDate}" Width="120" Margin="0,0,10,0"/>
                <TextBlock Text="to" VerticalAlignment="Center" Margin="0,0,10,0"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                <DatePicker SelectedDate="{Binding EndDate}" Width="120"/>
            </StackPanel>
        </Border>
        
        <!-- History Timeline -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Padding="20">
            <ItemsControl ItemsSource="{Binding HistoryItems}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="0,0,0,5">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Timeline indicator -->
                            <StackPanel Width="40">
                                <Border Background="{DynamicResource AccentBrush}" CornerRadius="15" 
                                        Width="30" Height="30" HorizontalAlignment="Center">
                                    <iconPacks:PackIconMaterial Kind="{Binding ActionIcon}" Width="14" Height="14"
                                                                 Foreground="White" HorizontalAlignment="Center" 
                                                                 VerticalAlignment="Center"/>
                                </Border>
                                <Border Width="2" Height="40" Background="{DynamicResource BorderBrush}"
                                        HorizontalAlignment="Center" Margin="0,5,0,0"/>
                            </StackPanel>
                            
                            <!-- Content -->
                            <Border Grid.Column="1" Style="{DynamicResource CardBorder}" Margin="10,0,0,0" Padding="15">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="3" 
                                                Padding="8,3" Margin="0,0,10,0">
                                            <TextBlock Text="{Binding ActionDisplay}" FontWeight="SemiBold" FontSize="11"
                                                       Foreground="{DynamicResource AccentBrush}"/>
                                        </Border>
                                        <TextBlock Text="{Binding PerformedAt, StringFormat='MMM dd, yyyy HH:mm'}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"
                                                   VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding TimeAgo, StringFormat=' ({0})'}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"
                                                   VerticalAlignment="Center"/>
                                    </StackPanel>
                                    
                                    <TextBlock Grid.Row="1" Text="{Binding Description}" Margin="0,8,0,0"
                                               Foreground="{DynamicResource TextPrimaryBrush}" TextWrapping="Wrap"/>
                                    
                                    <!-- Value Changes -->
                                    <StackPanel Grid.Row="2" Margin="0,8,0,0"
                                                Visibility="{Binding HasValueChange, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="Old: " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                            <TextBlock Text="{Binding OldValue}" Foreground="{DynamicResource ErrorBrush}" FontSize="12"
                                                       TextDecorations="Strikethrough"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="New: " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                            <TextBlock Text="{Binding NewValue}" Foreground="{DynamicResource SuccessBrush}" FontSize="12"/>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <TextBlock Grid.Row="2" Margin="0,5,0,0"
                                               Visibility="{Binding HasPerformedBy, Converter={StaticResource BoolToVisibility}}">
                                        <Run Text="By: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <Run Text="{Binding PerformedByName}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </TextBlock>
                                </Grid>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
        
        <!-- Empty State -->
        <StackPanel Grid.Row="2" HorizontalAlignment="Center" VerticalAlignment="Center"
                    Visibility="{Binding IsEmpty, Converter={StaticResource BoolToVisibility}}">
            <iconPacks:PackIconMaterial Kind="HistoryOff" Width="64" Height="64" 
                                         Foreground="{DynamicResource TextSecondaryBrush}" Opacity="0.5"/>
            <TextBlock Text="No history records found" FontSize="16" Margin="0,15,0,0"
                       Foreground="{DynamicResource TextSecondaryBrush}"/>
        </StackPanel>
    </Grid>
</mah:MetroWindow>
