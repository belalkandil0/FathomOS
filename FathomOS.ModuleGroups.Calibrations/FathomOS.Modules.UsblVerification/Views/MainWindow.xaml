<mah:MetroWindow x:Class="FathomOS.Modules.UsblVerification.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:converters="clr-namespace:FathomOS.Modules.UsblVerification.Converters"
        xmlns:oxy="http://oxyplot.org/wpf"
        xmlns:services="clr-namespace:FathomOS.Modules.UsblVerification.Services"
        Title="USBL Verification - Fathom OS"
        Height="950" Width="1500"
        MinHeight="750" MinWidth="1200"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        BorderBrush="{DynamicResource AccentBrush}"
        BorderThickness="1"
        GlowBrush="{DynamicResource AccentBrush}"
        ResizeMode="CanResizeWithGrip"
        TitleCharacterCasing="Normal"
        ShowTitleBar="True"
        TitleBarHeight="40"
        TitleForeground="{DynamicResource TextPrimaryBrush}"
        WindowTitleBrush="{DynamicResource HeaderBrush}"
        NonActiveWindowTitleBrush="{DynamicResource SurfaceBrush}"
        NonActiveGlowBrush="{DynamicResource BorderBrush}"
        NonActiveBorderBrush="{DynamicResource BorderBrush}"
        SaveWindowPosition="True"
        AllowDrop="True"
        Drop="MainWindow_Drop"
        DragOver="MainWindow_DragOver">

    <mah:MetroWindow.RightWindowCommands>
        <mah:WindowCommands>
            <!-- Theme Toggle -->
            <Button x:Name="ThemeToggleButton" Click="ThemeToggleButton_Click" ToolTip="Toggle Dark/Light Theme">
                <StackPanel Orientation="Horizontal">
                    <iconPacks:PackIconMaterial x:Name="ThemeIcon" Kind="WeatherNight" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock x:Name="ThemeText" Text="Dark"/>
                </StackPanel>
            </Button>
            <Separator Style="{DynamicResource MahApps.Styles.Separator.WindowCommands}"/>
            <!-- Help -->
            <Button Command="{Binding ShowHelpCommand}" ToolTip="Help Guide">
                <StackPanel Orientation="Horizontal">
                    <iconPacks:PackIconMaterial Kind="HelpCircle" Width="16" Height="16" Margin="0,0,5,0"/>
                    <TextBlock Text="Help"/>
                </StackPanel>
            </Button>
        </mah:WindowCommands>
    </mah:MetroWindow.RightWindowCommands>

    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:BoolToColorConverter x:Key="BoolToColor"/>
        <converters:PassFailToTextConverter x:Key="PassFailToText"/>
        <converters:NullToDefaultConverter x:Key="NullToDefault"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:StepToBackgroundConverter x:Key="StepToBackground"/>
        <converters:BoolToSuccessBackgroundConverter x:Key="BoolToSuccessBackground"/>
        <converters:BoolToIconConverter x:Key="BoolToIcon"/>
        <converters:BoolToResultBackgroundConverter x:Key="BoolToResultBackground"/>
        <converters:StepToIndexConverter x:Key="StepToIndex"/>
        <converters:QualityScoreToColorConverter x:Key="QualityScoreToColor"/>
        <converters:QualityScoreToGradeConverter x:Key="QualityScoreToGrade"/>
        <converters:PercentToWidthConverter x:Key="PercentToWidth" MaxWidth="300"/>
        <converters:BoolToStatusConverter x:Key="BoolToStatus"/>
        <converters:BoolToAccentBackgroundConverter x:Key="BoolToAccentBackground"/>
        <converters:BoolToTextColorConverter x:Key="BoolToTextColor"/>
        <converters:ProcessingStatusConverter x:Key="ProcessingStatus"/>
        <converters:ProcessingStatusColorConverter x:Key="ProcessingStatusColor"/>
        
        <Style x:Key="StepIndicator" TargetType="Border">
            <Setter Property="Width" Value="32"/>
            <Setter Property="Height" Value="32"/>
            <Setter Property="CornerRadius" Value="16"/>
            <Setter Property="BorderThickness" Value="2"/>
        </Style>
        
        <Style x:Key="ModernCard" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.15"/>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    
    <mah:MetroWindow.Flyouts>
        <mah:FlyoutsControl>
            <mah:Flyout x:Name="HelpFlyout" Header="USBL Verification Guide" Position="Right" Width="480"
                        IsOpen="{Binding IsHelpOpen}" Theme="Adapt">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
                    <StackPanel>
                        <!-- Header -->
                        <Border Background="{DynamicResource AccentBrush}" CornerRadius="10" Padding="20" Margin="0,0,0,20">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <iconPacks:PackIconMaterial Kind="HelpCircle" Width="32" Height="32" 
                                                                Foreground="White" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                    <StackPanel>
                                        <TextBlock Text="USBL Verification Module" FontSize="18" FontWeight="Bold" Foreground="White"/>
                                        <TextBlock Text="Version 1.6.0" FontSize="12" Foreground="#CCFFFFFF"/>
                                    </StackPanel>
                                </StackPanel>
                                <TextBlock Text="Automated verification of USBL acoustic positioning systems through spin and transit tests per IMCA S 017 guidelines." 
                                           TextWrapping="Wrap" Foreground="#EEFFFFFF" FontSize="12"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Quick Start Section -->
                        <TextBlock Text="ðŸš€ QUICK START" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="1. Load NPD files for 4 spin headings (0Â°, 90Â°, 180Â°, 270Â°)" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="2. Optionally load 2 transit lines for dynamic testing" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="3. Click 'Process' to calculate results" 
                                           Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="4. Export certificate if PASS, or review data if FAIL" 
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- 7-Step Workflow -->
                        <TextBlock Text="ðŸ“‹ 7-STEP WORKFLOW" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <!-- Step 1 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="{DynamicResource AccentBrush}" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="1" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Project Setup" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Configure project details:</Run><LineBreak/>
                                        â€¢ Project name, client, vessel, surveyor<LineBreak/>
                                        â€¢ Transponder info (name, serial, depth)<LineBreak/>
                                        â€¢ Input units (Meters, Feet, US Survey Feet)<LineBreak/>
                                        â€¢ Tolerance threshold (default: 0.5m)
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 2 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="{DynamicResource AccentBrush}" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="2" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Load Spin Data" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Import NPD files for 4 headings:</Run><LineBreak/>
                                        â€¢ Use Batch Import to load all at once<LineBreak/>
                                        â€¢ Or load each heading individually<LineBreak/>
                                        â€¢ Column mapping dialog auto-detects format<LineBreak/>
                                        â€¢ Supports NaviPac HD11 Sprint format
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 3 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="{DynamicResource AccentBrush}" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="3" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Preview &amp; Clean Data" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Review and validate data:</Run><LineBreak/>
                                        â€¢ View scatter plot with all headings<LineBreak/>
                                        â€¢ IQR outlier detection auto-flags bad points<LineBreak/>
                                        â€¢ Click points to exclude manually<LineBreak/>
                                        â€¢ Apply smoothing if needed (0-100%)
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 4 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="#666666" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="4" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Load Transit Data" FontWeight="SemiBold" FontSize="14" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <Border Background="#555555" CornerRadius="4" Padding="5,2" Margin="8,0,0,0">
                                            <TextBlock Text="OPTIONAL" FontSize="9" Foreground="White" FontWeight="Bold"/>
                                        </Border>
                                    </StackPanel>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Dynamic positioning test:</Run><LineBreak/>
                                        â€¢ Import 2 reciprocal transit lines<LineBreak/>
                                        â€¢ Tests USBL tracking during vessel movement<LineBreak/>
                                        â€¢ Skip if not required by client
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 5 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="{DynamicResource AccentBrush}" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="5" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Process Results" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Calculate verification:</Run><LineBreak/>
                                        â€¢ Computes mean position per heading<LineBreak/>
                                        â€¢ Calculates offset from overall mean<LineBreak/>
                                        â€¢ Compares against tolerance threshold<LineBreak/>
                                        â€¢ Determines PASS or FAIL status
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 6 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="{DynamicResource AccentBrush}" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="6" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Review Analytics" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Advanced analysis tools:</Run><LineBreak/>
                                        â€¢ Quality Dashboard with scoring<LineBreak/>
                                        â€¢ Statistical charts (histogram, polar, time series)<LineBreak/>
                                        â€¢ 3D scatter plot visualization<LineBreak/>
                                        â€¢ Monte Carlo simulation
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Step 7 -->
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Width="36" Height="36" CornerRadius="18" Background="#2ECC71" 
                                        Margin="0,0,12,0" VerticalAlignment="Top">
                                    <TextBlock Text="7" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                               Foreground="White" FontWeight="Bold" FontSize="16"/>
                                </Border>
                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Export &amp; Certificate" FontWeight="SemiBold" FontSize="14" 
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock TextWrapping="Wrap" Margin="0,5,0,0" FontSize="12"
                                               Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run FontWeight="SemiBold">Generate deliverables:</Run><LineBreak/>
                                        â€¢ PDF Verification Certificate (if PASS)<LineBreak/>
                                        â€¢ Excel report with all data<LineBreak/>
                                        â€¢ DXF plan view for CAD<LineBreak/>
                                        â€¢ Save to history database
                                    </TextBlock>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- File Formats Section -->
                        <TextBlock Text="ðŸ“ SUPPORTED FILE FORMATS" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text=".NPD" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="NaviPac HD11 Sprint export format" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Grid>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text=".CSV" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Comma-separated values" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text=".TXT" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Tab-delimited text files" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                        
                        <!-- Required Columns Section -->
                        <TextBlock Text="ðŸ“Š REQUIRED DATA COLUMNS" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="Minimum required columns for processing:" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ Date/Time" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Observation timestamp" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ Vessel Gyro" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Heading in degrees" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ Vessel Easting" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Vessel X coordinate" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ Vessel Northing" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Vessel Y coordinate" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ TP Easting" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Transponder X (USBL fix)" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ TP Northing" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Transponder Y (USBL fix)" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="130"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="â€¢ TP Depth" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Transponder depth" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontStyle="Italic"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                        
                        <!-- Tips Section -->
                        <TextBlock Text="ðŸ’¡ TIPS &amp; BEST PRACTICES" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                                Foreground="#2ECC71" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                    <TextBlock Text="Use batch import for faster loading - it auto-detects headings from filenames or gyro values." 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                                Foreground="#2ECC71" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                    <TextBlock Text="Check unit selection carefully - large coordinates (>1M) are usually US Survey Feet." 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                                Foreground="#2ECC71" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                    <TextBlock Text="Aim for at least 30 observations per heading for reliable statistics." 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                                Foreground="#2ECC71" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                    <TextBlock Text="Use the 3D scatter plot to visualize depth variations and identify systematic errors." 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </StackPanel>
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                                Foreground="#2ECC71" Margin="0,0,8,0" VerticalAlignment="Top"/>
                                    <TextBlock Text="Save projects regularly - auto-backup creates timestamped copies." 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                        
                        <!-- Troubleshooting Section -->
                        <TextBlock Text="ðŸ”§ TROUBLESHOOTING" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="Data not loading?" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="â€¢ Check file encoding (UTF-8 recommended)&#x0a;â€¢ Verify column delimiter (Tab vs Comma)&#x0a;â€¢ Use column mapping dialog to set correct columns" 
                                           TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,15"/>
                                
                                <TextBlock Text="Results showing FAIL?" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="â€¢ Check for outliers in the scatter plot&#x0a;â€¢ Verify correct input units selected&#x0a;â€¢ Review tolerance threshold setting&#x0a;â€¢ Try applying smoothing to reduce noise" 
                                           TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,15"/>
                                
                                <TextBlock Text="Certificate not generating?" FontWeight="SemiBold" 
                                           Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,5"/>
                                <TextBlock Text="â€¢ Certificates only generate for PASS results&#x0a;â€¢ Ensure all required fields are filled&#x0a;â€¢ Check output folder permissions" 
                                           TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                            </StackPanel>
                        </Border>
                        
                        <!-- Statistics Reference -->
                        <TextBlock Text="ðŸ“ˆ STATISTICS REFERENCE" FontSize="16" FontWeight="Bold" Margin="0,0,0,12"
                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                        
                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,20">
                            <StackPanel>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="CEP" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Circular Error Probable - 50% of points within this radius" 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </Grid>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="R95" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="95% of points within this radius" 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </Grid>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="2DRMS" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Twice the Distance Root Mean Square (~95% for 2D normal)" 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </Grid>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Ïƒ (Sigma)" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Standard deviation - measure of spread/precision" 
                                               TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                </Grid>
                            </StackPanel>
                        </Border>
                        
                        <!-- Contact/Support -->
                        <Border Background="{DynamicResource AccentBrush}" CornerRadius="8" Padding="15" Opacity="0.9">
                            <StackPanel HorizontalAlignment="Center">
                                <TextBlock Text="S7 Survey Solutions" FontWeight="Bold" FontSize="14" 
                                           Foreground="White" HorizontalAlignment="Center"/>
                                <TextBlock Text="USBL Verification Module v1.6.0" FontSize="11" 
                                           Foreground="#CCFFFFFF" HorizontalAlignment="Center" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Border>
                        
                    </StackPanel>
                </ScrollViewer>
            </mah:Flyout>
        </mah:FlyoutsControl>
    </mah:MetroWindow.Flyouts>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Step Progress Indicator -->
        <Border Grid.Row="0" Background="{DynamicResource HeaderBrush}" Padding="25,18">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Step indicators -->
                <ItemsControl ItemsSource="{Binding Steps}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <UniformGrid Rows="1"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <Border Style="{StaticResource StepIndicator}"
                                        Background="{Binding IsCompleted, Converter={StaticResource BoolToSuccessBackground}}"
                                        BorderBrush="{Binding IsCurrent, Converter={StaticResource BoolToColor}}">
                                    <TextBlock Text="{Binding Number}" 
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               FontWeight="Bold" FontSize="13"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </Border>
                                <StackPanel Margin="10,0,0,0" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="13"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock Text="{Binding Subtitle}" FontSize="10" Opacity="0.7"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Border>
        
        <!-- Main Content Area -->
        <Grid Grid.Row="1" Margin="20">
            <!-- Step 1: Project Setup & Data Loading -->
            <Grid Visibility="{Binding IsStep1, Converter={StaticResource BoolToVisibility}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left Column: Project Info -->
                <Border Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,10,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="PROJECT INFORMATION" FontWeight="Bold" FontSize="14"
                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                            
                            <!-- Project Details -->
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="130"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Text="Project Name:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ProjectName, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                                
                                <TextBlock Grid.Row="1" Text="Client:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding ClientName, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                                
                                <TextBlock Grid.Row="2" Text="Vessel:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding VesselName, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                                
                                <TextBlock Grid.Row="3" Text="Survey Date:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <DatePicker Grid.Row="3" Grid.Column="1" SelectedDate="{Binding SurveyDate}"
                                            Margin="0,0,0,10"/>
                                
                                <TextBlock Grid.Row="4" Text="Surveyor:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding SurveyorName, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                            </Grid>
                            
                            <Separator Margin="0,15" Background="{DynamicResource BorderBrush}"/>
                            
                            <!-- Transponder Info -->
                            <TextBlock Text="TRANSPONDER DETAILS" FontWeight="Bold" FontSize="14"
                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="130"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Text="Serial Number:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding TransponderSerial, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                                
                                <TextBlock Grid.Row="1" Text="Model:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding TransponderModel, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                                
                                <TextBlock Grid.Row="2" Text="Frequency:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding TransponderFrequency, UpdateSourceTrigger=PropertyChanged}"
                                         Margin="0,0,0,10" Padding="10,8"/>
                            </Grid>
                            
                            <Separator Margin="0,15" Background="{DynamicResource BorderBrush}"/>
                            
                            <!-- Units Selection -->
                            <TextBlock Text="UNITS CONFIGURATION" FontWeight="Bold" FontSize="14"
                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="130"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Text="Input Unit:" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox Grid.Row="0" Grid.Column="1" SelectedItem="{Binding SelectedInputUnit}"
                                          ItemsSource="{Binding AvailableUnits}" Margin="0,0,0,10"/>
                                
                                <TextBlock Grid.Row="1" Text="Tolerance (m):" VerticalAlignment="Center" Margin="0,0,0,10"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <mah:NumericUpDown Grid.Row="1" Grid.Column="1" 
                                                   Value="{Binding ToleranceMeters}" 
                                                   Minimum="0.1" Maximum="50" Interval="0.5"
                                                   StringFormat="F2" Margin="0,0,0,10"/>
                            </Grid>
                            
                            <Separator Margin="0,15" Background="{DynamicResource BorderBrush}"/>
                            
                            <!-- Recent Projects -->
                            <Expander Header="RECENT PROJECTS" IsExpanded="False"
                                      Margin="0,0,0,10">
                                <Expander.HeaderTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding}" FontWeight="Bold" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </DataTemplate>
                                </Expander.HeaderTemplate>
                                <StackPanel>
                                    <ItemsControl ItemsSource="{Binding RecentProjects}" MaxHeight="200">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{DynamicResource SurfaceBrush}" 
                                                        CornerRadius="6" Padding="10" Margin="0,0,0,8"
                                                        Cursor="Hand" MouseLeftButtonUp="RecentProject_Click">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <iconPacks:PackIconMaterial Kind="FolderOpen" Width="20" Height="20"
                                                                                    Foreground="{DynamicResource AccentBrush}"
                                                                                    Margin="0,0,10,0" VerticalAlignment="Center"/>
                                                        
                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"
                                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                            <TextBlock Text="{Binding VesselName}" FontSize="11"
                                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                        </StackPanel>
                                                        
                                                        <TextBlock Grid.Column="2" Text="{Binding LastOpenedDisplay}"
                                                                   FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"
                                                                   VerticalAlignment="Center"/>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    
                                    <Button Content="Clear Recent" Margin="0,5,0,0"
                                            Command="{Binding ClearRecentProjectsCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            HorizontalAlignment="Left" Padding="10,5"
                                            FontSize="11"/>
                                </StackPanel>
                            </Expander>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
                
                <!-- Right Column: Data Files - Streamlined Batch Import -->
                <Border Grid.Column="1" Style="{StaticResource ModernCard}" Margin="10,0,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Spin Data Section - Import Button with Summary -->
                        <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" CornerRadius="12" Padding="20" Margin="0,0,0,15">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Border Width="48" Height="48" CornerRadius="12" 
                                            Background="{DynamicResource AccentGradientBrush}" Margin="0,0,15,0">
                                        <iconPacks:PackIconMaterial Kind="Rotate3DVariant" Width="24" Height="24" 
                                                                     Foreground="White" HorizontalAlignment="Center" 
                                                                     VerticalAlignment="Center"/>
                                    </Border>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="SPIN TEST DATA" FontWeight="Bold" FontSize="16"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <TextBlock Text="Import NPD files for multiple headings" 
                                                   FontSize="12" Opacity="0.7"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    </StackPanel>
                                    
                                    <Button Grid.Column="2" Command="{Binding BatchImportSpinCommand}"
                                            Style="{DynamicResource PrimaryButton}"
                                            Padding="20,12">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="FolderUpload" Width="18" Height="18" Margin="0,0,10,0"/>
                                            <TextBlock Text="Import Files" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </Button>
                                </Grid>
                                
                                <!-- Status Summary -->
                                <Border Grid.Row="1" Margin="0,15,0,0" Padding="12,8" CornerRadius="8"
                                        Background="{Binding HasAllSpinData, Converter={StaticResource BoolToSuccessBackground}}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding SpinFileCount, Mode=OneWay}" FontSize="24" FontWeight="Bold" 
                                                       HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource AccentBrush}"/>
                                            <TextBlock Text="Files" FontSize="10" HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding HeadingCount}" FontSize="24" FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource AccentBrush}"/>
                                            <TextBlock Text="Headings" FontSize="10" HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                            <TextBlock Text="{Binding SpinTotalPoints}" FontSize="24" FontWeight="Bold"
                                                       HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource AccentBrush}"/>
                                            <TextBlock Text="Points" FontSize="10" HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="{Binding HasAllSpinData, Converter={StaticResource BoolToIcon}}"
                                                                         Width="24" Height="24" HorizontalAlignment="Center"
                                                                         Foreground="{Binding HasAllSpinData, Converter={StaticResource BoolToColor}}"/>
                                            <TextBlock Text="{Binding HasAllSpinData, Converter={StaticResource BoolToStatus}}" 
                                                       FontSize="10" HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                                
                                <!-- Heading Labels -->
                                <ItemsControl Grid.Row="2" ItemsSource="{Binding SpinDataSummaries}" Margin="0,10,0,0">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Rows="1"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="6" Padding="8,4" Margin="2,0"
                                                    Background="{Binding HasData, Converter={StaticResource BoolToAccentBackground}}">
                                                <TextBlock Text="{Binding HeadingLabel}" 
                                                           FontWeight="SemiBold" FontSize="11"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{Binding HasData, Converter={StaticResource BoolToTextColor}}"/>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>
                        </Border>
                        
                        <!-- Spin Files List -->
                        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="10">
                            <Grid>
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding SpinFiles}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" 
                                                        Padding="12,10" Margin="0,0,0,6">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <Border Width="36" Height="36" CornerRadius="8"
                                                                Background="{DynamicResource AccentBrush}" Margin="0,0,12,0">
                                                            <TextBlock Text="{Binding HeadingLabel}" 
                                                                       FontWeight="Bold" FontSize="10"
                                                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                       Foreground="White"/>
                                                        </Border>
                                                        
                                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding FileName}" FontWeight="SemiBold" FontSize="13"
                                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                            <TextBlock FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}">
                                                                <Run Text="{Binding RecordCount, Mode=OneWay}"/> points â€¢ <Run Text="{Binding ActualHeading, StringFormat='Avg: {0:F1}Â°', Mode=OneWay}"/>
                                                            </TextBlock>
                                                        </StackPanel>
                                                        
                                                        <iconPacks:PackIconMaterial Grid.Column="2" Kind="CheckCircle" 
                                                                                     Width="18" Height="18" Margin="10,0"
                                                                                     Foreground="{DynamicResource SuccessBrush}"
                                                                                     VerticalAlignment="Center"/>
                                                        
                                                        <Button Grid.Column="3" 
                                                                Command="{Binding DataContext.RemoveSpinFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{DynamicResource IconButton}"
                                                                ToolTip="Remove file" Padding="6">
                                                            <iconPacks:PackIconMaterial Kind="Close" Width="14" Height="14"/>
                                                        </Button>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                                
                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center"
                                            Visibility="{Binding HasNoSpinFiles, Converter={StaticResource BoolToVisibility}}">
                                    <iconPacks:PackIconMaterial Kind="FileUploadOutline" Width="48" Height="48" 
                                                                 Foreground="{DynamicResource TextSecondaryBrush}"
                                                                 HorizontalAlignment="Center" Opacity="0.3" Margin="0,0,0,10"/>
                                    <TextBlock Text="Click 'Import Files' to load spin test data"
                                               HorizontalAlignment="Center" FontSize="13"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Transit Data Section -->
                        <Border Grid.Row="2" Background="{DynamicResource SurfaceBrush}" CornerRadius="12" Padding="20" Margin="0,15,0,15">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <Border Width="48" Height="48" CornerRadius="12" 
                                        Background="{DynamicResource AccentSecondaryBrush}" Margin="0,0,15,0">
                                    <iconPacks:PackIconMaterial Kind="TransitTransfer" Width="24" Height="24" 
                                                                 Foreground="White" HorizontalAlignment="Center" 
                                                                 VerticalAlignment="Center"/>
                                </Border>
                                
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="TRANSIT TEST" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="{Binding TransitFileCount, Mode=OneWay}"/> files loaded (Optional)
                                    </TextBlock>
                                </StackPanel>
                                
                                <Border Grid.Column="2" CornerRadius="6" Padding="10,4" Margin="0,0,10,0"
                                        Background="{Binding HasAllTransitData, Converter={StaticResource BoolToSuccessBackground}}">
                                    <TextBlock Text="{Binding TransitPointCount, Mode=OneWay}" FontWeight="Bold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </Border>
                                
                                <Button Grid.Column="3" Command="{Binding BatchImportTransitCommand}"
                                        Style="{DynamicResource SecondaryButton}"
                                        Padding="16,10">
                                    <StackPanel Orientation="Horizontal">
                                        <iconPacks:PackIconMaterial Kind="FolderUpload" Width="16" Height="16" Margin="0,0,8,0"/>
                                        <TextBlock Text="Import"/>
                                    </StackPanel>
                                </Button>
                            </Grid>
                        </Border>
                        
                        <!-- Transit Files List (compact) -->
                        <Border Grid.Row="3" Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="10">
                            <Grid>
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <ItemsControl ItemsSource="{Binding TransitFiles}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{DynamicResource CardBrush}" CornerRadius="8" 
                                                        Padding="12,8" Margin="0,0,0,4">
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <iconPacks:PackIconMaterial Kind="FileDocument" Width="18" Height="18" 
                                                                                     VerticalAlignment="Center" Margin="0,0,10,0"
                                                                                     Foreground="{DynamicResource AccentSecondaryBrush}"/>
                                                        <TextBlock Grid.Column="1" Text="{Binding FileName}" 
                                                                   FontWeight="Medium" VerticalAlignment="Center"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                        <Button Grid.Column="2" 
                                                                Command="{Binding DataContext.RemoveTransitFileCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{DynamicResource IconButton}"
                                                                Padding="4">
                                                            <iconPacks:PackIconMaterial Kind="Close" Width="12" Height="12"/>
                                                        </Button>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                                
                                <TextBlock Text="Transit test is optional"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                           FontStyle="Italic" FontSize="12"
                                           Visibility="{Binding HasNoTransitFiles, Converter={StaticResource BoolToVisibility}}"
                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>
            
            <!-- Step 2: Data Preview with Statistics -->
            <Grid Visibility="{Binding IsStep2, Converter={StaticResource BoolToVisibility}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="350"/>
                </Grid.ColumnDefinitions>
                
                <!-- Left: Data Grid with Tabs -->
                <Border Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,15,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header with tabs -->
                        <Grid Grid.Row="0" Margin="0,0,0,15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Orientation="Horizontal">
                                <iconPacks:PackIconMaterial Kind="DatabaseSearch" Width="20" Height="20" 
                                                             Foreground="{DynamicResource AccentBrush}" 
                                                             VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <TextBlock Text="DATA PREVIEW" FontWeight="Bold" FontSize="16"
                                           Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                                <RadioButton Content="Spin Data" IsChecked="{Binding ShowSpinPreview}" 
                                             Style="{DynamicResource MahApps.Styles.RadioButton}" Margin="0,0,20,0"
                                             FontWeight="Medium"/>
                                <RadioButton Content="Transit Data" IsChecked="{Binding ShowTransitPreview}"
                                             Style="{DynamicResource MahApps.Styles.RadioButton}"
                                             FontWeight="Medium"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2" Orientation="Horizontal">
                                <Border Background="{DynamicResource AccentBrush}" CornerRadius="12" Padding="12,4" Margin="0,0,15,0">
                                    <TextBlock Text="{Binding PreviewRecordCount, StringFormat='{}{0} records'}" 
                                               FontWeight="SemiBold" FontSize="12" Foreground="White"/>
                                </Border>
                                <Button Command="{Binding RefreshPreviewCommand}" 
                                        Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                        ToolTip="Refresh Preview" Padding="8">
                                    <iconPacks:PackIconMaterial Kind="Refresh" Width="18" Height="18"/>
                                </Button>
                            </StackPanel>
                        </Grid>
                        
                        <!-- Data Grid with Premium Styling -->
                        <DataGrid Grid.Row="1" ItemsSource="{Binding PreviewData}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="Horizontal"
                                  AlternatingRowBackground="#08FFFFFF"
                                  Background="Transparent"
                                  RowBackground="Transparent"
                                  BorderThickness="0"
                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                  FontSize="12">
                            <DataGrid.ColumnHeaderStyle>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
                                    <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                    <Setter Property="Padding" Value="12,10"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="FontSize" Value="11"/>
                                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                </Style>
                            </DataGrid.ColumnHeaderStyle>
                            <DataGrid.CellStyle>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="Padding" Value="12,8"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#2000D4FF"/>
                                            <Setter Property="BorderBrush" Value="Transparent"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.CellStyle>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="50"/>
                                <DataGridTextColumn Header="DATE/TIME" Binding="{Binding DateTime, StringFormat='yyyy-MM-dd HH:mm:ss'}" Width="145"/>
                                <DataGridTextColumn Header="GYRO (Â°)" Binding="{Binding VesselGyro, StringFormat='F1'}" Width="70"/>
                                <DataGridTextColumn Header="VESSEL E" Binding="{Binding VesselEasting, StringFormat='F3'}" Width="105"/>
                                <DataGridTextColumn Header="VESSEL N" Binding="{Binding VesselNorthing, StringFormat='F3'}" Width="105"/>
                                <DataGridTextColumn Header="TP EAST" Binding="{Binding TransponderEasting, StringFormat='F3'}" Width="105"/>
                                <DataGridTextColumn Header="TP NORTH" Binding="{Binding TransponderNorthing, StringFormat='F3'}" Width="105"/>
                                <DataGridTextColumn Header="DEPTH" Binding="{Binding TransponderDepth, StringFormat='F2'}" Width="75"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>
                
                <!-- Right: Statistics Panel -->
                <Border Grid.Column="1" Style="{StaticResource ModernCard}">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <!-- Statistics Header -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,20">
                                <iconPacks:PackIconMaterial Kind="ChartBar" Width="20" Height="20" 
                                                             Foreground="{DynamicResource AccentBrush}" 
                                                             VerticalAlignment="Center" Margin="0,0,10,0"/>
                                <TextBlock Text="QUICK STATISTICS" FontWeight="Bold" FontSize="16"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </StackPanel>
                            
                            <!-- Data Summary Cards -->
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="15" Margin="0,0,0,15">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <StackPanel Grid.Column="0" Margin="0,0,10,15">
                                        <TextBlock Text="SPIN FILES" FontSize="10" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding SpinFileCount, Mode=OneWay}" FontSize="28" FontWeight="Bold"
                                                   Foreground="{DynamicResource AccentBrush}"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" Margin="10,0,0,15">
                                        <TextBlock Text="TRANSIT FILES" FontSize="10" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding TransitFileCount, Mode=OneWay}" FontSize="28" FontWeight="Bold"
                                                   Foreground="{DynamicResource AccentSecondaryBrush}"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="1" Grid.Column="0" Margin="0,0,10,0">
                                        <TextBlock Text="TOTAL POINTS" FontSize="10" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding TotalPointCount, Mode=OneWay}" FontSize="28" FontWeight="Bold"
                                                   Foreground="{DynamicResource SuccessBrush}"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="1" Grid.Column="1" Margin="10,0,0,0">
                                        <TextBlock Text="HEADINGS" FontSize="10" FontWeight="Medium"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Text="{Binding HeadingCount}" FontSize="28" FontWeight="Bold"
                                                   Foreground="{DynamicResource InfoBrush}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            
                            <!-- Per-Heading Summary -->
                            <TextBlock Text="HEADING BREAKDOWN" FontWeight="SemiBold" FontSize="12"
                                       Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,10"/>
                            
                            <ItemsControl ItemsSource="{Binding SpinDataSummaries}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" 
                                                Padding="12,10" Margin="0,0,0,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <Border Width="36" Height="36" CornerRadius="8" 
                                                        Background="{DynamicResource AccentBrush}" Margin="0,0,12,0">
                                                    <TextBlock Text="{Binding HeadingLabel}" 
                                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                                               FontWeight="Bold" FontSize="10" Foreground="White"/>
                                                </Border>
                                                
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                    <TextBlock Text="{Binding PointCount, StringFormat='{}{0} points'}" 
                                                               FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </StackPanel>
                                                
                                                <iconPacks:PackIconMaterial Grid.Column="2" 
                                                    Kind="{Binding HasData, Converter={StaticResource BoolToIcon}}"
                                                    Foreground="{Binding HasData, Converter={StaticResource BoolToColor}}"
                                                    Width="18" Height="18" VerticalAlignment="Center"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            
                            <Separator Margin="0,15" Background="{DynamicResource BorderBrush}"/>
                            
                            <!-- Data Quality Indicator -->
                            <TextBlock Text="DATA QUALITY" FontWeight="SemiBold" FontSize="12"
                                       Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,10"/>
                            
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="10" Padding="15">
                                <StackPanel>
                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Coverage" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Column="1" Text="{Binding DataCoveragePercent, StringFormat='{}{0}%'}"
                                                   FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                    </Grid>
                                    <Border Height="8" CornerRadius="4" Background="{DynamicResource BorderBrush}">
                                        <Border CornerRadius="4" HorizontalAlignment="Left"
                                                Width="{Binding DataCoveragePercent, Converter={StaticResource PercentToWidth}}"
                                                Background="{DynamicResource AccentGradientBrush}"/>
                                    </Border>
                                    
                                    <Grid Margin="0,15,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Heading Spread" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Column="1" Text="{Binding HeadingSpreadStatus}"
                                                   FontWeight="Bold" Foreground="{DynamicResource SuccessBrush}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
            
            <!-- Step 3: Spin Analysis -->
            <Grid Visibility="{Binding IsStep3, Converter={StaticResource BoolToVisibility}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="400"/>
                </Grid.ColumnDefinitions>
                
                <!-- Chart Area -->
                <Border Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,10,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="SPIN TEST VISUALIZATION" FontWeight="Bold" FontSize="14"
                                   Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,15"/>
                        
                        <oxy:PlotView Grid.Row="1" Model="{Binding SpinPlotModel}" 
                                      Background="Transparent"/>
                    </Grid>
                </Border>
                
                <!-- Results Panel -->
                <Border Grid.Column="1" Style="{StaticResource ModernCard}" Margin="10,0,0,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="SPIN ANALYSIS RESULTS" FontWeight="Bold" FontSize="14"
                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                            
                            <!-- Real-Time Data Smoothing Panel -->
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="ChartBellCurve" Width="18" Height="18" 
                                                                        Foreground="{DynamicResource AccentBrush}" Margin="0,0,8,0"/>
                                            <TextBlock Text="Real-Time Smoothing" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </StackPanel>
                                        
                                        <ToggleButton Grid.Column="2" IsChecked="{Binding IsSmoothingEnabled}"
                                                      Style="{DynamicResource MahApps.Styles.ToggleButton.Flat}"
                                                      ToolTip="Enable/Disable Smoothing"
                                                      Padding="8,4">
                                            <TextBlock Text="{Binding IsSmoothingEnabled, Converter={StaticResource BoolToStatus}}"/>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <!-- Method Selection -->
                                    <TextBlock Text="Method:" FontSize="11" Margin="0,0,0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <ComboBox ItemsSource="{Binding AvailableSmoothingMethods}"
                                              SelectedItem="{Binding SelectedSmoothingMethod}"
                                              Margin="0,0,0,12"/>
                                    
                                    <!-- Real-Time Strength Slider -->
                                    <TextBlock Text="Smoothing Strength:" FontSize="11" Margin="0,0,0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Slider Value="{Binding SmoothingStrength}" 
                                                Minimum="0" Maximum="100" 
                                                TickFrequency="10" IsSnapToTickEnabled="False"
                                                ToolTip="Drag to adjust smoothing in real-time"
                                                Margin="0,0,10,0"/>
                                        <TextBlock Grid.Column="1" 
                                                   Text="{Binding SmoothingStrength, StringFormat='{}{0:F0}%'}"
                                                   FontWeight="SemiBold" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource AccentBrush}"/>
                                    </Grid>
                                    
                                    <!-- Window Size Slider -->
                                    <TextBlock Text="Window Size:" FontSize="11" Margin="0,12,0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Slider Value="{Binding SmoothingWindowSize}" 
                                                Minimum="3" Maximum="21" 
                                                TickFrequency="2" IsSnapToTickEnabled="True"
                                                ToolTip="Window size for smoothing algorithm"
                                                Margin="0,0,10,0"/>
                                        <TextBlock Grid.Column="1" 
                                                   Text="{Binding SmoothingWindowSize, StringFormat='{}{0} pts'}"
                                                   FontWeight="SemiBold" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource AccentBrush}"/>
                                    </Grid>
                                    
                                    <!-- Smoothing Statistics -->
                                    <Border Background="{DynamicResource CardBrush}" CornerRadius="6" 
                                            Padding="10" Margin="0,12,0,0"
                                            Visibility="{Binding IsSmoothingEnabled, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel>
                                                    <TextBlock Text="RMS Residual" FontSize="10" 
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock Text="{Binding SmoothingRmsResidual, StringFormat='{}{0:F4} m'}" 
                                                               FontWeight="SemiBold" FontSize="13"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                </StackPanel>
                                                
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Points Affected" FontSize="10" 
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock Text="{Binding SmoothingPointsAffected}" 
                                                               FontWeight="SemiBold" FontSize="13"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                </StackPanel>
                                            </Grid>
                                            
                                            <!-- Show Smoothed Difference Toggle -->
                                            <CheckBox Content="Show Original vs Smoothed" Margin="0,10,0,0"
                                                      IsChecked="{Binding ShowSmoothedDifference}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      ToolTip="Display original points (faded) and smoothed points (solid) in different styles"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Reset Button -->
                                    <Button Content="Reset to Original" Margin="0,10,0,0"
                                            Command="{Binding ResetSmoothingCommand}"
                                            Style="{DynamicResource SecondaryButton}"
                                            Padding="10,6" FontSize="11"
                                            HorizontalAlignment="Left"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Outlier/Spike Filtering Panel -->
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <Grid Margin="0,0,0,10">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="FilterRemove" Width="18" Height="18" 
                                                                        Foreground="{DynamicResource WarningBrush}" Margin="0,0,8,0"/>
                                            <TextBlock Text="Outlier Detection" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </StackPanel>
                                        
                                        <ToggleButton Grid.Column="2" IsChecked="{Binding IsOutlierFilterEnabled}"
                                                      Style="{DynamicResource MahApps.Styles.ToggleButton.Flat}"
                                                      ToolTip="Enable/Disable Outlier Detection"
                                                      Padding="8,4">
                                            <TextBlock Text="{Binding IsOutlierFilterEnabled, Converter={StaticResource BoolToStatus}}"/>
                                        </ToggleButton>
                                    </Grid>
                                    
                                    <TextBlock Text="Detect and filter statistical outliers (spikes) that deviate significantly from the cluster."
                                               FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"
                                               TextWrapping="Wrap" Margin="0,0,0,12"/>
                                    
                                    <!-- Threshold Slider -->
                                    <TextBlock Text="Threshold (Ïƒ):" FontSize="11" Margin="0,0,0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="60"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Slider Value="{Binding OutlierThresholdSigma}" 
                                                Minimum="1.5" Maximum="4.0" 
                                                TickFrequency="0.5" IsSnapToTickEnabled="True"
                                                ToolTip="Points beyond this many standard deviations are flagged"
                                                Margin="0,0,10,0"/>
                                        <TextBlock Grid.Column="1" 
                                                   Text="{Binding OutlierThresholdSigma, StringFormat='{}{0:F1} Ïƒ'}"
                                                   FontWeight="SemiBold" VerticalAlignment="Center"
                                                   Foreground="{DynamicResource WarningBrush}"/>
                                    </Grid>
                                    
                                    <!-- Detected Outliers Summary -->
                                    <Border Background="{DynamicResource CardBrush}" CornerRadius="6" 
                                            Padding="10" Margin="0,12,0,0"
                                            Visibility="{Binding IsOutlierFilterEnabled, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel>
                                                    <TextBlock Text="Detected Outliers" FontSize="10" 
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock FontWeight="SemiBold" FontSize="18">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Text" Value="{Binding OutlierCount}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding OutlierCount}" Value="0">
                                                                        <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </StackPanel>
                                                
                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <Button Content="Exclude All" 
                                                            Command="{Binding ExcludeAllOutliersCommand}"
                                                            Style="{DynamicResource SecondaryButton}"
                                                            Padding="10,6" FontSize="11" Margin="0,0,8,0"
                                                            ToolTip="Exclude all detected outliers from analysis"
                                                            Visibility="{Binding OutlierCount, Converter={StaticResource NullToVisibility}}"/>
                                                    <Button Content="Restore" 
                                                            Command="{Binding RestoreExcludedCommand}"
                                                            Style="{DynamicResource SecondaryButton}"
                                                            Padding="10,6" FontSize="11"
                                                            ToolTip="Restore all excluded points"/>
                                                </StackPanel>
                                            </Grid>
                                            
                                            <!-- Outliers List (if any) -->
                                            <ItemsControl ItemsSource="{Binding DetectedOutliers}" 
                                                          MaxHeight="120" Margin="0,8,0,0"
                                                          Visibility="{Binding OutlierCount, Converter={StaticResource NullToVisibility}}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="4" 
                                                                Padding="8,4" Margin="0,0,0,4">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                </Grid.ColumnDefinitions>
                                                                
                                                                <TextBlock FontSize="11" VerticalAlignment="Center">
                                                                    <Run Text="Point #" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                                    <Run Text="{Binding Index}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                                    <Run Text=" - " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                                    <Run Text="{Binding RadialFromMean, StringFormat='{}{0:F3}m from mean'}" Foreground="{DynamicResource WarningBrush}"/>
                                                                </TextBlock>
                                                                
                                                                <Button Grid.Column="1" Content="Exclude"
                                                                        Command="{Binding DataContext.ExcludeOutlierCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                                        CommandParameter="{Binding}"
                                                                        Style="{DynamicResource IconButton}"
                                                                        FontSize="10" Padding="6,2"
                                                                        Foreground="{DynamicResource ErrorBrush}"/>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            
                                            <!-- Highlight Option -->
                                            <CheckBox Content="Highlight outliers in chart" Margin="0,8,0,0"
                                                      IsChecked="{Binding ShowOutliersHighlighted}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      FontSize="11"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Process Button -->
                            <Button Command="{Binding ProcessSpinDataCommand}"
                                    Style="{DynamicResource MahApps.Styles.Button.Flat.Accent}"
                                    Padding="15,12" Margin="0,0,0,20">
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="Calculator" Width="18" Height="18" Margin="0,0,10,0"/>
                                    <TextBlock Text="Process Spin Data" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Button>
                            
                            <!-- Mean Position -->
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="Mean Transponder Position" FontWeight="SemiBold" Margin="0,0,0,10"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock Grid.Row="0" Text="Easting:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding SpinMeanEasting, StringFormat='F3'}" 
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        
                                        <TextBlock Grid.Row="1" Text="Northing:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding SpinMeanNorthing, StringFormat='F3'}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        
                                        <TextBlock Grid.Row="2" Text="Depth:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding SpinMeanDepth, StringFormat='F2 m'}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <!-- Statistics by Heading -->
                            <TextBlock Text="Results by Heading" FontWeight="SemiBold" Margin="0,0,0,10"
                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                            
                            <ItemsControl ItemsSource="{Binding SpinHeadingResults}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="6" 
                                                Padding="12" Margin="0,0,0,8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="60"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <TextBlock Text="{Binding HeadingLabel}" FontWeight="Bold" FontSize="16"
                                                           Foreground="{DynamicResource AccentBrush}"/>
                                                
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="{Binding MeanOffset, StringFormat='Mean Offset: {0:F3} m'}"
                                                               FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock Text="{Binding StdDev, StringFormat='Std Dev: {0:F3} m'}"
                                                               FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </StackPanel>
                                                
                                                <iconPacks:PackIconMaterial Grid.Column="2" 
                                                                            Kind="{Binding Passed, Converter={StaticResource BoolToIcon}}"
                                                                            Width="20" Height="20"
                                                                            Foreground="{Binding Passed, Converter={StaticResource BoolToColor}}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            
                            <!-- Overall Result - Show Not Processed state when not yet processed -->
                            <Border Margin="0,15,0,0" CornerRadius="8" Padding="15"
                                    Background="{Binding ProcessingStatus, Converter={StaticResource ProcessingStatusColor}}"
                                    Visibility="{Binding IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <iconPacks:PackIconMaterial Kind="{Binding SpinTestPassed, Converter={StaticResource BoolToIcon}}"
                                                                Width="24" Height="24" Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding SpinTestPassed, Converter={StaticResource PassFailToText}}"
                                               FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Not Processed State -->
                            <Border Margin="0,15,0,0" CornerRadius="8" Padding="15"
                                    Background="{DynamicResource SurfaceBrush}"
                                    Visibility="{Binding ShowNotProcessedMessage, Converter={StaticResource BoolToVisibility}}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <iconPacks:PackIconMaterial Kind="InformationOutline"
                                                                Width="24" Height="24" Margin="0,0,10,0"
                                                                Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="Click 'Process Spin Data' to calculate results"
                                               FontSize="14" VerticalAlignment="Center"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
            
            <!-- Step 4: Transit Analysis -->
            <Grid Visibility="{Binding IsStep4, Converter={StaticResource BoolToVisibility}}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="400"/>
                </Grid.ColumnDefinitions>
                
                <!-- Chart Area -->
                <Border Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,10,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="TRANSIT TEST VISUALIZATION" FontWeight="Bold" FontSize="14"
                                   Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,15"/>
                        
                        <oxy:PlotView Grid.Row="1" Model="{Binding TransitPlotModel}" 
                                      Background="Transparent"/>
                    </Grid>
                </Border>
                
                <!-- Results Panel -->
                <Border Grid.Column="1" Style="{StaticResource ModernCard}" Margin="10,0,0,0">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="TRANSIT ANALYSIS RESULTS" FontWeight="Bold" FontSize="14"
                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                            
                            <!-- Process Button -->
                            <Button Command="{Binding ProcessTransitDataCommand}"
                                    Style="{DynamicResource MahApps.Styles.Button.Flat.Accent}"
                                    Padding="15,12" Margin="0,0,0,20">
                                <StackPanel Orientation="Horizontal">
                                    <iconPacks:PackIconMaterial Kind="Calculator" Width="18" Height="18" Margin="0,0,10,0"/>
                                    <TextBlock Text="Process Transit Data" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Button>
                            
                            <!-- Transit Statistics -->
                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="Transit Statistics" FontWeight="SemiBold" Margin="0,0,0,10"
                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <TextBlock Grid.Row="0" Text="Mean Offset:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding TransitMeanOffset, StringFormat='F3 m'}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        
                                        <TextBlock Grid.Row="1" Text="Std Deviation:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding TransitStdDev, StringFormat='F3 m'}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        
                                        <TextBlock Grid.Row="2" Text="Max Offset:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding TransitMaxOffset, StringFormat='F3 m'}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        
                                        <TextBlock Grid.Row="3" Text="Points Tested:" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding TransitPointCount, Mode=OneWay}"
                                                   FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </Grid>
                                </StackPanel>
                            </Border>
                            
                            <!-- Overall Result -->
                            <Border Margin="0,15,0,0" CornerRadius="8" Padding="15"
                                    Background="{Binding TransitTestPassed, Converter={StaticResource BoolToResultBackground}}">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <iconPacks:PackIconMaterial Kind="{Binding TransitTestPassed, Converter={StaticResource BoolToIcon}}"
                                                                Width="24" Height="24" Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding TransitTestPassed, Converter={StaticResource PassFailToText}}"
                                               FontSize="16" FontWeight="Bold" VerticalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </Border>
            </Grid>
            
            <!-- Step 5: Results Summary -->
            <Grid Visibility="{Binding IsStep5, Converter={StaticResource BoolToVisibility}}">
                <Border Style="{StaticResource ModernCard}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Text="VERIFICATION SUMMARY" FontWeight="Bold" FontSize="14"
                                   Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                        
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Spin Results Card -->
                            <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" 
                                    CornerRadius="10" Padding="20" Margin="0,0,10,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                        <iconPacks:PackIconMaterial Kind="RotateRight" Width="24" Height="24" 
                                                                    Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                        <TextBlock Text="Spin Test" FontWeight="Bold" FontSize="16"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    
                                    <Border CornerRadius="6" Padding="15" Margin="0,0,0,15"
                                            Background="{Binding SpinTestPassed, Converter={StaticResource BoolToResultBackground}}">
                                        <TextBlock Text="{Binding SpinTestPassed, Converter={StaticResource PassFailToText}}"
                                                   HorizontalAlignment="Center" FontWeight="Bold" FontSize="18"/>
                                    </Border>
                                    
                                    <TextBlock Text="{Binding SpinMeanOffset, StringFormat='Mean Offset: {0:F3} m'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding SpinStdDev, StringFormat='Std Dev: {0:F3} m'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding SpinPointCount, StringFormat='Points: {0}'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Transit Results Card -->
                            <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                    CornerRadius="10" Padding="20" Margin="5,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                        <iconPacks:PackIconMaterial Kind="SwapHorizontal" Width="24" Height="24" 
                                                                    Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                        <TextBlock Text="Transit Test" FontWeight="Bold" FontSize="16"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    
                                    <Border CornerRadius="6" Padding="15" Margin="0,0,0,15"
                                            Background="{Binding TransitTestPassed, Converter={StaticResource BoolToResultBackground}}">
                                        <TextBlock Text="{Binding TransitTestPassed, Converter={StaticResource PassFailToText}}"
                                                   HorizontalAlignment="Center" FontWeight="Bold" FontSize="18"/>
                                    </Border>
                                    
                                    <TextBlock Text="{Binding TransitMeanOffset, StringFormat='Mean Offset: {0:F3} m'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding TransitStdDev, StringFormat='Std Dev: {0:F3} m'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding TransitPointCount, StringFormat='Points: {0}', Mode=OneWay}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Border>
                            
                            <!-- Overall Results Card -->
                            <Border Grid.Column="2" Background="{DynamicResource SurfaceBrush}" 
                                    CornerRadius="10" Padding="20" Margin="10,0,0,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                        <iconPacks:PackIconMaterial Kind="CheckDecagram" Width="24" Height="24" 
                                                                    Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                        <TextBlock Text="Overall Result" FontWeight="Bold" FontSize="16"
                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                    
                                    <Border CornerRadius="6" Padding="20" Margin="0,0,0,15"
                                            Background="{Binding OverallPassed, Converter={StaticResource BoolToResultBackground}}">
                                        <StackPanel HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="{Binding OverallPassed, Converter={StaticResource BoolToIcon}}"
                                                                        Width="40" Height="40" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                                            <TextBlock Text="{Binding OverallPassed, Converter={StaticResource PassFailToText}}"
                                                       HorizontalAlignment="Center" FontWeight="Bold" FontSize="20"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <TextBlock Text="{Binding ToleranceMeters, StringFormat='Tolerance: {0:F2} m'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <TextBlock Text="{Binding OverallQualityScore, StringFormat='Quality Score: {0:F0}%'}" Margin="0,5"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>
            
            <!-- Step 6: Quality Dashboard & Advanced Charts -->
            <Grid Visibility="{Binding IsStep6, Converter={StaticResource BoolToVisibility}}">
                <mah:MetroTabControl>
                    <!-- Quality Overview Tab -->
                    <TabItem Header="Quality Overview">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="ChartBox" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="QUALITY DASHBOARD" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <!-- Quality Score Gauge -->
                                    <Border Grid.Column="0" Grid.Row="0" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="10" Padding="20" Margin="0,0,10,10">
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <TextBlock Text="Quality Score" FontWeight="SemiBold" FontSize="14" 
                                                       HorizontalAlignment="Center" Margin="0,0,0,15"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <Border Width="120" Height="120" CornerRadius="60"
                                                    BorderThickness="8"
                                                    BorderBrush="{Binding OverallQualityScore, Converter={StaticResource QualityScoreToColor}}">
                                                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding OverallQualityScore, StringFormat='F0'}" 
                                                               FontSize="36" FontWeight="Bold" HorizontalAlignment="Center"
                                                               Foreground="{Binding OverallQualityScore, Converter={StaticResource QualityScoreToColor}}"/>
                                                    <TextBlock Text="{Binding OverallQualityScore, Converter={StaticResource QualityScoreToGrade}}"
                                                               FontSize="14" HorizontalAlignment="Center"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Metrics Chart -->
                                    <Border Grid.Column="1" Grid.Row="0" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="10" Padding="20" Margin="10,0,0,10">
                                        <oxy:PlotView Model="{Binding QualityPlotModel}" Background="Transparent"/>
                                    </Border>
                                    
                                    <!-- Metrics Table -->
                                    <Border Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" 
                                            Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="10" Padding="15" Margin="0,10,0,0">
                                        <DataGrid ItemsSource="{Binding QualityMetrics}"
                                                  AutoGenerateColumns="False"
                                                  IsReadOnly="True"
                                                  CanUserAddRows="False"
                                                  HeadersVisibility="Column"
                                                  GridLinesVisibility="Horizontal"
                                                  HorizontalGridLinesBrush="{DynamicResource BorderBrush}"
                                                  Background="{DynamicResource SurfaceBrush}"
                                                  Foreground="{DynamicResource TextPrimaryBrush}"
                                                  RowBackground="{DynamicResource SurfaceBrush}"
                                                  AlternatingRowBackground="{DynamicResource CardBrush}"
                                                  BorderThickness="0">
                                            <DataGrid.ColumnHeaderStyle>
                                                <Style TargetType="DataGridColumnHeader">
                                                    <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
                                                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                    <Setter Property="Padding" Value="12,10"/>
                                                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                                </Style>
                                            </DataGrid.ColumnHeaderStyle>
                                            <DataGrid.CellStyle>
                                                <Style TargetType="DataGridCell">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                                    <Setter Property="BorderThickness" Value="0"/>
                                                    <Setter Property="Padding" Value="12,8"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="DataGridCell">
                                                                <Border Background="{TemplateBinding Background}" 
                                                                        Padding="{TemplateBinding Padding}">
                                                                    <ContentPresenter VerticalAlignment="Center"/>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsSelected" Value="True">
                                                            <Setter Property="Background" Value="#2000D4FF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.CellStyle>
                                            <DataGrid.RowStyle>
                                                <Style TargetType="DataGridRow">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                                    <Setter Property="BorderThickness" Value="0,0,0,1"/>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background" Value="#1000D4FF"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGrid.RowStyle>
                                            <DataGrid.Columns>
                                                <DataGridTextColumn Header="Metric" Binding="{Binding Name}" Width="*"/>
                                                <DataGridTextColumn Header="Value" Binding="{Binding Value}" Width="120"/>
                                                <DataGridTextColumn Header="Threshold" Binding="{Binding Threshold}" Width="120"/>
                                                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="100">
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Status}" Value="PASS">
                                                                    <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                </DataTrigger>
                                                                <DataTrigger Binding="{Binding Status}" Value="FAIL">
                                                                    <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>
                                            </DataGrid.Columns>
                                        </DataGrid>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Error Ellipse Tab -->
                    <TabItem Header="Error Ellipse">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="ChartScatterPlot" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="ERROR ELLIPSE ANALYSIS" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                    <Button Content="Generate" Command="{Binding RefreshAdvancedChartsCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            Margin="20,0,0,0" Padding="15,5"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding ErrorEllipsePlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Error Ellipse Info" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="The error ellipse shows the statistical distribution of position measurements:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="50% ellipse: Half of points lie within"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="90% ellipse: Most points contained"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="95% ellipse: Standard confidence"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="99% ellipse: Nearly all points"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Major/Minor axes show the primary directions of scatter. A circular ellipse indicates isotropic errors; elongated indicates directional bias."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Heading Radar Tab -->
                    <TabItem Header="Heading Radar">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="Radar" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="HEADING COMPARISON RADAR" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding RadarPlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Radar Chart Info" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="The radar chart compares performance metrics across all vessel headings:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Std Dev (Radial): Position scatter"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Max Offset: Worst-case error"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Symmetrical patterns indicate consistent performance. Asymmetry suggests heading-dependent errors that may indicate alignment issues."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Residual Time Series Tab -->
                    <TabItem Header="Residuals">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="ChartTimeline" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="RESIDUAL TIME SERIES" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding ResidualTimeSeriesPlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Residual Analysis" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="Residual time series shows how position errors vary over time:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Mean Line: Average residual"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="+1Ïƒ/+2Ïƒ: Control limits"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Red Triangles: Outliers (>2Ïƒ)"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Look for: Trends (drift), cycles (periodic error), sudden jumps (equipment issues)."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Control Chart Tab -->
                    <TabItem Header="Control Chart">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="ChartBellCurveCumulative" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="STATISTICAL CONTROL CHART (X-bar)" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding ControlChartPlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Control Chart Info" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="The X-bar control chart monitors process stability:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="CL: Center Line (process mean)"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="UCL: Upper Control Limit"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="LCL: Lower Control Limit"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Points outside control limits (red triangles) indicate the process is out of statistical control and requires investigation."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Depth vs Slant Range Tab -->
                    <TabItem Header="Depth/Range">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="WaveArrowDown" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="DEPTH vs SLANT RANGE" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding DepthSlantRangePlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Depth/Range Analysis" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="This plot shows the relationship between measured depth and slant range:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Gray dashed: Theoretical (vertical)"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Red line: Regression fit"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="RÂ²: Correlation strength"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Deviation from theoretical line indicates horizontal offset. High RÂ² confirms consistent acoustic propagation."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Rose Diagram Tab -->
                    <TabItem Header="Rose Diagram">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="CompassRose" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="DIRECTIONAL ERROR DISTRIBUTION (ROSE DIAGRAM)" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding RoseDiagramPlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Rose Diagram Info" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="The rose diagram shows directional distribution of position errors:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Petal length: Error count"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Petal direction: Error bearing"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Color intensity: Error magnitude"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="A uniform distribution (circular) indicates isotropic errors. Dominant petals suggest systematic directional bias."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                    
                    <!-- Smoothing Comparison Tab -->
                    <TabItem Header="Smoothing Effect">
                        <Border Style="{StaticResource ModernCard}" Margin="10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                                    <iconPacks:PackIconMaterial Kind="ChartBellCurve" Width="24" Height="24" 
                                                                Foreground="{DynamicResource AccentBrush}" Margin="0,0,10,0"/>
                                    <TextBlock Text="BEFORE/AFTER SMOOTHING COMPARISON" FontWeight="Bold" FontSize="16"
                                               Foreground="{DynamicResource AccentBrush}" VerticalAlignment="Center"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="280"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <oxy:PlotView Model="{Binding SmoothingComparisonPlotModel}" Background="Transparent"/>
                                    
                                    <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="15" Margin="15,0,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Smoothing Effect" FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <TextBlock TextWrapping="Wrap" FontSize="12" LineHeight="20"
                                                       Foreground="{DynamicResource TextSecondaryBrush}">
                                                <Run Text="This overlay shows the effect of data smoothing:"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Red circles: Original data"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Green diamonds: Smoothed data"/>
                                                <LineBreak/>
                                                <Run Text="â€¢ " FontWeight="Bold"/><Run Text="Gray lines: Movement vectors"/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="The scatter reduction percentage shows how much the smoothing has reduced position variance."/>
                                                <LineBreak/><LineBreak/>
                                                <Run Text="Tip: Apply smoothing in Step 3 first to see the comparison."/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </Border>
                    </TabItem>
                </mah:MetroTabControl>
            </Grid>
            
            <!-- Step 7: Export -->
            <Grid Visibility="{Binding IsStep7, Converter={StaticResource BoolToVisibility}}">
                <mah:MetroTabControl>
                    <!-- Export Tab -->
                    <mah:MetroTabItem Header="Export Options">
                        <Grid Margin="15">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Export Options -->
                            <Border Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="EXPORT OPTIONS" FontWeight="Bold" FontSize="14"
                                               Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                                    
                                    <!-- Certificate -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="Certificate" Width="32" Height="32" 
                                                                        Foreground="{DynamicResource AccentBrush}" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="Verification Certificate" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Official PDF certificate with digital signature" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding ExportCertificateCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat.Accent}"
                                                    Content="Generate" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- PDF Report -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="FilePdfBox" Width="32" Height="32" 
                                                                        Foreground="#E53935" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="PDF Report" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Detailed report with charts and data tables" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding ExportPdfCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                    Content="Export" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Excel Export -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="MicrosoftExcel" Width="32" Height="32" 
                                                                        Foreground="#4CAF50" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="Excel Workbook" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Full data export with multiple sheets" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding ExportExcelCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                    Content="Export" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- DXF Export -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="VectorPolygon" Width="32" Height="32" 
                                                                        Foreground="#2196F3" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="DXF Drawing" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="CAD-compatible vector drawing" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding ExportDxfCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                    Content="Export" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- DXF Plan View -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="FloorPlan" Width="32" Height="32" 
                                                                        Foreground="#00BCD4" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="DXF Plan View" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Full plan with tolerance circles, statistics, grid" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding ExportDxfPlanViewCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                    Content="Export" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Save to History -->
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="20">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <iconPacks:PackIconMaterial Kind="DatabasePlus" Width="32" Height="32" 
                                                                        Foreground="#9C27B0" Margin="0,0,15,0"/>
                                            <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                <TextBlock Text="Save to History" FontWeight="SemiBold" FontSize="14"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                <TextBlock Text="Store verification for future reference" FontSize="11"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <Button Grid.Column="2" Command="{Binding SaveToHistoryCommand}"
                                                    Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                    Content="Save" Padding="20,10"/>
                                        </Grid>
                                    </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Certificate Preview -->
                            <Border Grid.Column="1" Style="{StaticResource ModernCard}" Margin="10,0,0,0">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Text="CERTIFICATE PREVIEW" FontWeight="Bold" FontSize="14"
                                               Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,20"/>
                                    
                                    <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="8" Padding="30">
                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <iconPacks:PackIconMaterial Kind="Certificate" Width="80" Height="80" 
                                                                        Foreground="{DynamicResource AccentBrush}" 
                                                                        HorizontalAlignment="Center" Margin="0,0,0,20"/>
                                            
                                            <TextBlock Text="USBL VERIFICATION CERTIFICATE" 
                                                       FontSize="18" FontWeight="Bold" HorizontalAlignment="Center"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            
                                            <TextBlock Text="{Binding ProjectName}" FontSize="14" HorizontalAlignment="Center" Margin="0,10"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            
                                            <Border CornerRadius="6" Padding="20,10" Margin="0,15"
                                                    Background="{Binding OverallPassed, Converter={StaticResource BoolToResultBackground}}">
                                                <TextBlock Text="{Binding OverallPassed, Converter={StaticResource PassFailToText}}"
                                                           FontWeight="Bold" FontSize="16" HorizontalAlignment="Center"/>
                                            </Border>
                                            
                                            <TextBlock Text="{Binding SurveyDate, StringFormat='Date: {0:dd MMMM yyyy}'}" 
                                                       FontSize="12" HorizontalAlignment="Center" Margin="0,10"
                                                       Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Border>
                        </Grid>
                    </mah:MetroTabItem>
                    
                    <!-- Advanced Analytics Tab -->
                    <mah:MetroTabItem Header="Advanced Analytics">
                        <Grid Margin="15">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Analytics Toolbar -->
                            <Border Grid.Row="0" Style="{StaticResource ModernCard}" Margin="0,0,0,15">
                                <StackPanel Orientation="Horizontal">
                                    <Button Command="{Binding GenerateAllAnalyticsCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat.Accent}"
                                            Padding="15,10" Margin="0,0,10,0">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="ChartScatterPlot" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Generate All Analytics"/>
                                        </StackPanel>
                                    </Button>
                                    
                                    <Button Command="{Binding RunMonteCarloCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            Padding="15,10" Margin="0,0,10,0">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="Dice5" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Monte Carlo"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Border>
                            
                            <!-- Analytics Charts -->
                            <Grid Grid.Row="1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Time Series Chart -->
                                <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,0,8,8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Position Drift Over Time" FontWeight="SemiBold" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                        <oxy:PlotView Grid.Row="1" Model="{Binding TimeSeriesPlotModel}" Background="Transparent"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Histogram Chart -->
                                <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource ModernCard}" Margin="8,0,0,8">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Error Distribution" FontWeight="SemiBold" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                        <oxy:PlotView Grid.Row="1" Model="{Binding HistogramPlotModel}" Background="Transparent"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Polar Plot -->
                                <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource ModernCard}" Margin="0,8,8,0">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Text="Polar Position Plot" FontWeight="SemiBold" 
                                                   Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,10"/>
                                        <oxy:PlotView Grid.Row="1" Model="{Binding PolarPlotModel}" Background="Transparent"/>
                                    </Grid>
                                </Border>
                                
                                <!-- Statistics Panel -->
                                <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource ModernCard}" Margin="8,8,0,0">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <StackPanel>
                                            <TextBlock Text="Radial Statistics" FontWeight="SemiBold" 
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,15"/>
                                            
                                            <!-- CEP/R95/R99 -->
                                            <Grid Margin="0,0,0,15">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <Border Grid.Column="0" Background="{DynamicResource SurfaceBrush}" 
                                                        CornerRadius="8" Padding="12" Margin="0,0,5,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="CEP" FontSize="11" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding SelectedRadialStats.CEP, StringFormat='F3 m', FallbackValue='-'}" 
                                                                   FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource AccentBrush}"/>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <Border Grid.Column="1" Background="{DynamicResource SurfaceBrush}" 
                                                        CornerRadius="8" Padding="12" Margin="5,0,5,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="R95" FontSize="11" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding SelectedRadialStats.R95, StringFormat='F3 m', FallbackValue='-'}" 
                                                                   FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource AccentBrush}"/>
                                                    </StackPanel>
                                                </Border>
                                                
                                                <Border Grid.Column="2" Background="{DynamicResource SurfaceBrush}" 
                                                        CornerRadius="8" Padding="12" Margin="5,0,0,0">
                                                    <StackPanel HorizontalAlignment="Center">
                                                        <TextBlock Text="2DRMS" FontSize="11" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding SelectedRadialStats.TwoDRMS, StringFormat='F3 m', FallbackValue='-'}" 
                                                                   FontWeight="Bold" FontSize="18" HorizontalAlignment="Center"
                                                                   Foreground="{DynamicResource AccentBrush}"/>
                                                    </StackPanel>
                                                </Border>
                                            </Grid>
                                            
                                            <!-- Monte Carlo Results -->
                                            <TextBlock Text="Monte Carlo Confidence" FontWeight="SemiBold" 
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,10,0,10"/>
                                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    
                                                    <TextBlock Grid.Row="0" Text="CEP 95% CI:" Margin="0,0,10,5"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock Grid.Row="0" Grid.Column="1" 
                                                               Text="{Binding MonteCarloResult.CEPConfidenceDisplay, FallbackValue='Run simulation'}"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                    
                                                    <TextBlock Grid.Row="1" Text="Iterations:" Margin="0,0,10,0"
                                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <TextBlock Grid.Row="1" Grid.Column="1" 
                                                               Text="{Binding MonteCarloResult.Iterations, StringFormat='N0', FallbackValue='-'}"
                                                               Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                </Grid>
                                            </Border>
                                            
                                            <!-- Trend Analysis -->
                                            <TextBlock Text="Drift Analysis" FontWeight="SemiBold" 
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,15,0,10"/>
                                            <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="8" Padding="12">
                                                <StackPanel>
                                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                                        <TextBlock Text="Drift Rate: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding TrendAnalysis.DriftRateDisplay, FallbackValue='-'}"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="SemiBold"/>
                                                    </StackPanel>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="Status: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding TrendAnalysis.Status, FallbackValue='Not analyzed'}"
                                                                   Foreground="{DynamicResource TextPrimaryBrush}"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Border>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </Grid>
                        </Grid>
                    </mah:MetroTabItem>
                    
                    <!-- 3D View Tab -->
                    <mah:MetroTabItem Header="3D View">
                        <Grid Margin="15">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- 3D Controls Toolbar -->
                            <Border Grid.Row="0" Style="{StaticResource ModernCard}" Margin="0,0,0,15">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- View Controls -->
                                    <StackPanel Orientation="Horizontal">
                                        <Button Command="{Binding Generate3DViewCommand}"
                                                Style="{DynamicResource MahApps.Styles.Button.Flat.Accent}"
                                                Padding="15,8" Margin="0,0,10,0">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="Cube" Width="16" Height="16" Margin="0,0,8,0"/>
                                                <TextBlock Text="Generate 3D View"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Command="{Binding Reset3DViewCommand}"
                                                Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                                Padding="10,8" Margin="0,0,10,0">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="Refresh" Width="14" Height="14" Margin="0,0,6,0"/>
                                                <TextBlock Text="Reset View"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                    
                                    <!-- Display Options -->
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center">
                                        <CheckBox Content="Axes" IsChecked="{Binding Show3DAxes}" Margin="10,0"/>
                                        <CheckBox Content="Grid" IsChecked="{Binding Show3DGrid}" Margin="10,0"/>
                                        <CheckBox Content="Tolerance" IsChecked="{Binding Show3DTolerance}" Margin="10,0"/>
                                        <CheckBox Content="Stats" IsChecked="{Binding Show3DStats}" Margin="10,0"/>
                                        <CheckBox Content="Transit" IsChecked="{Binding Show3DTransit}" Margin="10,0"/>
                                    </StackPanel>
                                    
                                    <!-- Point Size Slider -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                                        <TextBlock Text="Point Size:" VerticalAlignment="Center" Margin="0,0,8,0"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <Slider Value="{Binding PointSize3D}" Minimum="0.05" Maximum="0.5" 
                                                Width="100" VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding PointSize3D, StringFormat='{}{0:F2}'}" 
                                                   VerticalAlignment="Center" Margin="8,0,0,0" Width="35"
                                                   Foreground="{DynamicResource AccentBrush}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            
                            <!-- 3D Viewport -->
                            <Border Grid.Row="1" Style="{StaticResource ModernCard}">
                                <Grid Background="#1A1A2E">
                                    <!-- WPF Viewport3D -->
                                    <Viewport3D x:Name="MainViewport3D" ClipToBounds="True"
                                               MouseDown="Viewport3D_MouseDown"
                                               MouseMove="Viewport3D_MouseMove"
                                               MouseUp="Viewport3D_MouseUp"
                                               MouseWheel="Viewport3D_MouseWheel">
                                        <!-- Camera -->
                                        <Viewport3D.Camera>
                                            <PerspectiveCamera x:Name="MainCamera"
                                                               Position="15,15,10"
                                                               LookDirection="-1,-1,-0.5"
                                                               UpDirection="0,0,1"
                                                               FieldOfView="60"/>
                                        </Viewport3D.Camera>
                                        
                                        <!-- 3D Model Container -->
                                        <ModelVisual3D x:Name="MainModelVisual">
                                            <ModelVisual3D.Content>
                                                <Model3DGroup>
                                                    <!-- Scene content updated from code-behind -->
                                                </Model3DGroup>
                                            </ModelVisual3D.Content>
                                        </ModelVisual3D>
                                    </Viewport3D>
                                    
                                    <!-- Overlay Info Panel -->
                                    <Border Background="{DynamicResource CardBrush}" CornerRadius="6"
                                            Padding="12" Margin="15" HorizontalAlignment="Left" 
                                            VerticalAlignment="Top" Opacity="0.9">
                                        <StackPanel>
                                            <TextBlock Text="3D SCATTER PLOT" FontWeight="Bold" FontSize="12"
                                                       Foreground="{DynamicResource AccentBrush}" Margin="0,0,0,8"/>
                                            <TextBlock Text="{Binding Info3DPointCount, StringFormat='Points: {0}'}"
                                                       FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <TextBlock Text="{Binding Info3DDepthRange}"
                                                       FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <TextBlock Text="Mouse: Drag to rotate, Scroll to zoom"
                                                       FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}" 
                                                       Margin="0,8,0,0" FontStyle="Italic"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Legend -->
                                    <Border Background="{DynamicResource CardBrush}" CornerRadius="6"
                                            Padding="12" Margin="15" HorizontalAlignment="Right" 
                                            VerticalAlignment="Top" Opacity="0.9">
                                        <StackPanel>
                                            <TextBlock Text="LEGEND" FontWeight="Bold" FontSize="11"
                                                       Foreground="{DynamicResource TextPrimaryBrush}" Margin="0,0,0,8"/>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <Ellipse Width="10" Height="10" Fill="#FF5050" Margin="0,0,8,0"/>
                                                <TextBlock Text="Heading 0Â°" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <Ellipse Width="10" Height="10" Fill="#50FF50" Margin="0,0,8,0"/>
                                                <TextBlock Text="Heading 90Â°" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <Ellipse Width="10" Height="10" Fill="#5050FF" Margin="0,0,8,0"/>
                                                <TextBlock Text="Heading 180Â°" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,2">
                                                <Ellipse Width="10" Height="10" Fill="#FF50FF" Margin="0,0,8,0"/>
                                                <TextBlock Text="Heading 270Â°" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                            <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                                                <Border Width="10" Height="10" Background="#4000FF00" 
                                                        BorderBrush="#00FF00" BorderThickness="1" Margin="0,0,8,0"/>
                                                <TextBlock Text="Tolerance Sphere" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- No Data Message -->
                                    <TextBlock Text="Click 'Generate 3D View' to visualize data"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               FontSize="16" Foreground="{DynamicResource TextSecondaryBrush}"
                                               Visibility="{Binding Has3DScene, Converter={StaticResource InverseBoolToVisibility}}"/>
                                </Grid>
                            </Border>
                        </Grid>
                    </mah:MetroTabItem>
                    
                    <!-- History Tab -->
                    <mah:MetroTabItem Header="History">
                        <Grid Margin="15">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- History Toolbar -->
                            <Border Grid.Row="0" Style="{StaticResource ModernCard}" Margin="0,0,0,15">
                                <StackPanel Orientation="Horizontal">
                                    <Button Command="{Binding LoadHistoryCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            Padding="15,10" Margin="0,0,10,0">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="Refresh" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Refresh"/>
                                        </StackPanel>
                                    </Button>
                                    
                                    <Button Command="{Binding ExportHistoryCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            Padding="15,10" Margin="0,0,10,0">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="Export" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Export DB"/>
                                        </StackPanel>
                                    </Button>
                                    
                                    <Button Command="{Binding ImportHistoryCommand}"
                                            Style="{DynamicResource MahApps.Styles.Button.Flat}"
                                            Padding="15,10">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial Kind="Import" Width="18" Height="18" Margin="0,0,8,0"/>
                                            <TextBlock Text="Import DB"/>
                                        </StackPanel>
                                    </Button>
                                </StackPanel>
                            </Border>
                            
                            <!-- History List -->
                            <Border Grid.Row="1" Style="{StaticResource ModernCard}">
                                <DataGrid ItemsSource="{Binding HistoryRecords}" 
                                          AutoGenerateColumns="False"
                                          IsReadOnly="True"
                                          SelectionMode="Single"
                                          SelectionUnit="FullRow"
                                          GridLinesVisibility="None"
                                          HeadersVisibility="Column"
                                          Background="Transparent"
                                          RowBackground="{DynamicResource CardBrush}"
                                          AlternatingRowBackground="{DynamicResource SurfaceBrush}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Date" Binding="{Binding DateDisplay}" Width="100"/>
                                        <DataGridTextColumn Header="Project" Binding="{Binding ProjectName}" Width="*"/>
                                        <DataGridTextColumn Header="Vessel" Binding="{Binding VesselName}" Width="150"/>
                                        <DataGridTextColumn Header="Client" Binding="{Binding ClientName}" Width="150"/>
                                        <DataGridTextColumn Header="Result" Binding="{Binding PassFailDisplay}" Width="80">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding OverallPassed}" Value="True">
                                                            <Setter Property="Foreground" Value="#4CAF50"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding OverallPassed}" Value="False">
                                                            <Setter Property="Foreground" Value="#F44336"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </Border>
                        </Grid>
                    </mah:MetroTabItem>
                </mah:MetroTabControl>
            </Grid>
        </Grid>
        
        <!-- Footer / Navigation -->
        <Border Grid.Row="2" Background="{DynamicResource SurfaceBrush}" Padding="20,12" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Status and Progress -->
                <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <iconPacks:PackIconMaterial Kind="{Binding StatusIcon}" Width="16" Height="16" 
                                                    Foreground="{DynamicResource AccentBrush}" Margin="0,0,8,0"
                                                    VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding StatusMessage}" FontSize="12"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <!-- Progress Bar -->
                    <Grid Width="300" Height="6">
                        <Border Background="{DynamicResource CardBrush}" CornerRadius="3"/>
                        <Border CornerRadius="3" HorizontalAlignment="Left"
                                Width="{Binding OverallProgress, Converter={StaticResource PercentToWidth}}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#00D4FF" Offset="0"/>
                                    <GradientStop Color="#7B68EE" Offset="1"/>
                                </LinearGradientBrush>
                            </Border.Background>
                        </Border>
                    </Grid>
                    <TextBlock Text="{Binding OverallProgress, StringFormat='{}{0:F0}% Complete'}" 
                               FontSize="10" Foreground="{DynamicResource TextMutedBrush}" Margin="0,4,0,0"/>
                </StackPanel>
                
                <!-- Project Actions (Step 7) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="0,0,15,0"
                            Visibility="{Binding IsStep7, Converter={StaticResource BoolToVisibility}}">
                    <Button Command="{Binding SaveProjectCommand}" ToolTip="Save Project"
                            Style="{DynamicResource SecondaryButton}" Padding="12,8" Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="ContentSave" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Save" FontSize="12"/>
                        </StackPanel>
                    </Button>
                    <Button Command="{Binding LoadProjectCommand}" ToolTip="Load Project"
                            Style="{DynamicResource SecondaryButton}" Padding="12,8">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="FolderOpen" Width="14" Height="14" Margin="0,0,6,0"/>
                            <TextBlock Text="Load" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
                
                <!-- Navigation Buttons -->
                <Button Grid.Column="2" Command="{Binding PreviousStepCommand}"
                        Style="{DynamicResource SecondaryButton}"
                        Padding="20,10" Margin="0,0,10,0">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="ChevronLeft" Width="14" Height="14" Margin="0,0,6,0"/>
                        <TextBlock Text="Previous" FontSize="12"/>
                    </StackPanel>
                </Button>
                
                <Button Grid.Column="3" Command="{Binding NextStepCommand}"
                        Style="{DynamicResource PrimaryButton}"
                        Padding="24,10">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding NextButtonText}" FontSize="12" FontWeight="SemiBold"/>
                        <iconPacks:PackIconMaterial Kind="{Binding IsStep7, Converter={StaticResource BoolToIcon}, ConverterParameter='Check|ChevronRight'}" 
                                                    Width="14" Height="14" Margin="6,0,0,0"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>
    </Grid>
</mah:MetroWindow>
