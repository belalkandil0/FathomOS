<mah:MetroWindow x:Class="FathomOS.Modules.RovGyroCalibration.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:oxy="http://oxyplot.org/wpf"
        xmlns:local="clr-namespace:FathomOS.Modules.RovGyroCalibration.Views"
        xmlns:steps="clr-namespace:FathomOS.Modules.RovGyroCalibration.Views.Steps"
        xmlns:vm="clr-namespace:FathomOS.Modules.RovGyroCalibration.ViewModels"
        xmlns:vmsteps="clr-namespace:FathomOS.Modules.RovGyroCalibration.ViewModels.Steps"
        xmlns:converters="clr-namespace:FathomOS.Modules.RovGyroCalibration.Converters"
        mc:Ignorable="d"
        Title="ROV Gyro Calibration &amp; Verification - Fathom OS"
        Height="850" Width="1400"
        MinHeight="700" MinWidth="1100"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        BorderBrush="{DynamicResource PrimaryBrush}"
        BorderThickness="1"
        GlowBrush="{DynamicResource PrimaryBrush}"
        ResizeMode="CanResizeWithGrip"
        TitleCharacterCasing="Normal"
        WindowTransitionsEnabled="True"
        ShowTitleBar="True"
        TitleBarHeight="40">

    <Window.Resources>
        <!-- Converters -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:QcStatusToBrushConverter x:Key="QcStatusToBrush"/>
        <converters:QcStatusToIconConverter x:Key="QcStatusToIcon"/>
        <converters:DoubleFormatConverter x:Key="DoubleFormat"/>
        <converters:PercentageConverter x:Key="PercentageFormat"/>
        <converters:StatusToBrushConverter x:Key="StatusToBrushConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
        
        <!-- Step Item Template for the navigation -->
        <DataTemplate x:Key="StepIndicatorTemplate">
            <Button Command="{Binding DataContext.GoToStepCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                    CommandParameter="{Binding StepNumber}"
                    Style="{DynamicResource IconButton}"
                    IsEnabled="{Binding IsCompleted}"
                    ToolTip="{Binding StepTitle}"
                    Margin="0,0,8,0">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Step Circle -->
                    <Border Width="32" Height="32" CornerRadius="16"
                            Background="{DynamicResource SurfaceBrush}"
                            BorderThickness="2">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsActive}" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource SuccessBrush}"/>
                                        <Setter Property="BorderBrush" Value="{DynamicResource SuccessBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                        <TextBlock Text="{Binding StepNumber}" 
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   FontWeight="Bold"
                                   FontSize="14"
                                   Foreground="White"/>
                    </Border>
                    
                    <!-- Step Title (only for active step) -->
                    <TextBlock Text="{Binding StepTitle}" 
                               VerticalAlignment="Center"
                               Margin="8,0,0,0"
                               Foreground="{DynamicResource TextPrimaryBrush}"
                               FontWeight="SemiBold"
                               Visibility="{Binding IsActive, Converter={StaticResource BoolToVisibility}}"/>
                    
                    <!-- Connector Line -->
                    <Border Width="24" Height="2" 
                            Background="{DynamicResource BorderBrush}"
                            VerticalAlignment="Center"
                            Margin="8,0,0,0">
                        <Border.Style>
                            <Style TargetType="Border">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                                        <Setter Property="Background" Value="{DynamicResource SuccessBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Border.Style>
                    </Border>
                </StackPanel>
            </Button>
        </DataTemplate>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>   <!-- Header -->
            <RowDefinition Height="Auto"/>   <!-- Step Indicators -->
            <RowDefinition Height="*"/>      <!-- Content -->
            <RowDefinition Height="Auto"/>   <!-- Navigation Buttons -->
            <RowDefinition Height="Auto"/>   <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- ==================== HEADER ==================== -->
        <Border Grid.Row="0" Background="{DynamicResource HeaderGradientBrush}" Padding="20,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Logo/Icon and Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <iconPacks:PackIconMaterial Kind="Compass" Width="32" Height="32" 
                                                Foreground="White" VerticalAlignment="Center"/>
                    <StackPanel Margin="12,0,0,0">
                        <TextBlock Text="ROV GYRO CALIBRATION" 
                                   FontSize="18" FontWeight="Bold" Foreground="White"/>
                        <TextBlock Text="The Fathom 7 Process" 
                                   FontSize="12" Foreground="#B0BEC5"/>
                    </StackPanel>
                </StackPanel>

                <!-- Center - Mode Indicator -->
                <Border Grid.Column="1" HorizontalAlignment="Center" 
                        Background="#40FFFFFF" CornerRadius="16" 
                        Padding="16,6" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="CheckCircle" Width="16" Height="16" 
                                                    Foreground="{DynamicResource AccentBrush}" 
                                                    VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding Project.PurposeText, FallbackValue='Calibration Mode'}" 
                                   Margin="8,0,0,0" Foreground="White" 
                                   FontWeight="SemiBold" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Right - Project Info and Help -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Project.VesselName, FallbackValue='Vessel Name'}" 
                               Foreground="White" FontSize="14" VerticalAlignment="Center"/>
                    <Border Width="1" Height="20" Background="#40FFFFFF" Margin="12,0"/>
                    <TextBlock Text="{Binding Project.SurveyDate, StringFormat='{}{0:dd MMM yyyy}', FallbackValue='Date'}" 
                               Foreground="#B0BEC5" FontSize="12" VerticalAlignment="Center"/>
                    <Border Width="1" Height="20" Background="#40FFFFFF" Margin="12,0"/>
                    <!-- Help Button -->
                    <Button Command="{Binding ShowHelpCommand}" 
                            ToolTip="User Guide"
                            Style="{DynamicResource IconButton}"
                            Background="Transparent" BorderThickness="0"
                            Padding="8,4">
                        <StackPanel Orientation="Horizontal">
                            <iconPacks:PackIconMaterial Kind="HelpCircle" Width="20" Height="20" 
                                                        Foreground="White" VerticalAlignment="Center"/>
                            <TextBlock Text="Help" Foreground="White" Margin="6,0,0,0" 
                                       VerticalAlignment="Center" FontSize="12"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ==================== STEP INDICATORS ==================== -->
        <Border Grid.Row="1" Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                Padding="20,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Step Progress Indicators -->
                <ItemsControl ItemsSource="{Binding Steps}" 
                              ItemTemplate="{StaticResource StepIndicatorTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>

                <!-- Progress Text -->
                <TextBlock Grid.Column="1" VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}">
                    <Run Text="Step"/>
                    <Run Text="{Binding CurrentStepNumber, Mode=OneWay}" FontWeight="Bold" Foreground="{DynamicResource PrimaryBrush}"/>
                    <Run Text="of"/>
                    <Run Text="{Binding Steps.Count, Mode=OneWay}"/>
                </TextBlock>
            </Grid>
        </Border>

        <!-- ==================== MAIN CONTENT AREA ==================== -->
        <Border Grid.Row="2" Margin="16,8,16,8">
            <Grid>
                <!-- Step Content Container -->
                <ContentControl Content="{Binding CurrentStepViewModel}">
                    <ContentControl.Resources>
                        <!-- Step 1: Select Mode -->
                        <DataTemplate DataType="{x:Type vmsteps:Step1SetupViewModel}">
                            <steps:Step1SelectView/>
                        </DataTemplate>
                        
                        <!-- Step 2: Import Data -->
                        <DataTemplate DataType="{x:Type vmsteps:Step2ImportViewModel}">
                            <steps:Step2ImportView/>
                        </DataTemplate>
                        
                        <!-- Step 3: Configure -->
                        <DataTemplate DataType="{x:Type vmsteps:Step3ConfigureViewModel}">
                            <steps:Step3ConfigureView/>
                        </DataTemplate>
                        
                        <!-- Step 4: Process -->
                        <DataTemplate DataType="{x:Type vmsteps:Step4ProcessViewModel}">
                            <steps:Step4ProcessView/>
                        </DataTemplate>
                        
                        <!-- Step 5: Analyze -->
                        <DataTemplate DataType="{x:Type vmsteps:Step5AnalyzeViewModel}">
                            <steps:Step5AnalyzeView/>
                        </DataTemplate>
                        
                        <!-- Step 6: Validate -->
                        <DataTemplate DataType="{x:Type vmsteps:Step6ValidateViewModel}">
                            <steps:Step6ValidateView/>
                        </DataTemplate>
                        
                        <!-- Step 7: Export -->
                        <DataTemplate DataType="{x:Type vmsteps:Step7ExportViewModel}">
                            <steps:Step7ExportView/>
                        </DataTemplate>
                    </ContentControl.Resources>
                </ContentControl>

                <!-- Loading Overlay -->
                <Border Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                        <mah:ProgressRing IsActive="True" Width="60" Height="60" Foreground="{DynamicResource PrimaryBrush}"/>
                        <TextBlock Text="{Binding StatusMessage}" Foreground="White" 
                                   FontSize="14" Margin="0,16,0,0" HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- ==================== NAVIGATION BUTTONS ==================== -->
        <Border Grid.Row="3" Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0"
                Padding="20,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Validation Message -->
                <TextBlock Grid.Column="0" 
                           Text="{Binding CurrentStepViewModel.ValidationMessage}" 
                           Foreground="{DynamicResource ErrorBrush}"
                           FontSize="13" VerticalAlignment="Center"
                           Visibility="{Binding CurrentStepViewModel.ValidationMessage, Converter={StaticResource NullToVisibility}}"/>

                <!-- Previous Button -->
                <Button Grid.Column="1" 
                        Command="{Binding PreviousCommand}"
                        Style="{DynamicResource SecondaryButton}"
                        Margin="0,0,12,0"
                        Visibility="{Binding CanGoPrevious, Converter={StaticResource BoolToVisibility}}">
                    <StackPanel Orientation="Horizontal">
                        <iconPacks:PackIconMaterial Kind="ChevronLeft" Width="16" Height="16" VerticalAlignment="Center"/>
                        <TextBlock Text="Previous" Margin="8,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </Button>

                <!-- Next/Finish Button -->
                <Button Grid.Column="2" 
                        Command="{Binding NextCommand}"
                        Style="{DynamicResource PrimaryButton}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding NextButtonText}" VerticalAlignment="Center"/>
                        <iconPacks:PackIconMaterial Kind="ChevronRight" Width="16" Height="16" 
                                                    Margin="8,0,0,0" VerticalAlignment="Center"
                                                    Visibility="{Binding IsLastStep, Converter={StaticResource InverseBoolToVisibility}}"/>
                        <iconPacks:PackIconMaterial Kind="Check" Width="16" Height="16" 
                                                    Margin="8,0,0,0" VerticalAlignment="Center"
                                                    Visibility="{Binding IsLastStep, Converter={StaticResource BoolToVisibility}}"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- ==================== STATUS BAR ==================== -->
        <Border Grid.Row="4" Background="{DynamicResource CardBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0"
                Padding="20,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Status Message -->
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}" 
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="12" VerticalAlignment="Center"/>

                <!-- Branding -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="FATHOM OS" FontSize="10" FontWeight="Bold" 
                               Foreground="{DynamicResource PrimaryBrush}"/>
                    <TextBlock Text=" | v1.0.0" FontSize="10" 
                               Foreground="{DynamicResource TextMutedBrush}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</mah:MetroWindow>
