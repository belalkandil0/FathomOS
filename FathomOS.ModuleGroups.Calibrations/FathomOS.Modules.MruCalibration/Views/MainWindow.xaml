<mah:MetroWindow x:Class="FathomOS.Modules.MruCalibration.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
        xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
        xmlns:oxy="http://oxyplot.org/wpf"
        xmlns:vm="clr-namespace:FathomOS.Modules.MruCalibration.ViewModels"
        xmlns:converters="clr-namespace:FathomOS.Modules.MruCalibration.Converters"
        mc:Ignorable="d"
        Title="MRU Calibration - Fathom OS"
        Height="900" Width="1400"
        MinHeight="700" MinWidth="1100"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        BorderBrush="{DynamicResource Subsea7OrangeBrush}"
        BorderThickness="1"
        GlowBrush="{DynamicResource Subsea7OrangeBrush}"
        ResizeMode="CanResizeWithGrip"
        TitleCharacterCasing="Normal"
        SaveWindowPosition="True"
        d:DataContext="{d:DesignInstance vm:MainViewModel, IsDesignTimeCreatable=False}">
    
    <!-- Resources -->
    <Window.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
        <converters:DoubleFormatConverter x:Key="DoubleFormat"/>
        <converters:PercentageConverter x:Key="PercentageFormat"/>
        <converters:DateTimeFormatConverter x:Key="DateTimeFormat"/>
        <converters:PurposeToBoolConverter x:Key="PurposeToBool"/>
        <converters:StepToVisibilityConverter x:Key="StepToVisibility"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- ========================================== -->
        <!-- HEADER - Step Progress Indicator -->
        <!-- ========================================== -->
        <Border Grid.Row="0" 
                Background="{DynamicResource HeaderBrush}" 
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="24,16">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="16"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Title Bar -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="MRU Calibration" 
                                   Style="{DynamicResource HeaderTitle}"
                                   Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                        <TextBlock Text=" │ " FontSize="28" 
                                   Foreground="{DynamicResource TextTertiaryBrush}"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="The Fathom 7 Process" 
                                   FontSize="18" 
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   FontStyle="Italic"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                        <Button Content="New" Command="{Binding NewSessionCommand}"
                                Style="{DynamicResource SecondaryButton}" Padding="16,8" Margin="0,0,8,0"/>
                        <Button Content="Load" Command="{Binding LoadSessionCommand}"
                                Style="{DynamicResource SecondaryButton}" Padding="16,8" Margin="0,0,8,0"/>
                        <Button Content="Save" Command="{Binding SaveSessionCommand}"
                                Style="{DynamicResource SecondaryButton}" Padding="16,8" Margin="0,0,16,0"/>
                        
                        <!-- Separator -->
                        <Border Width="1" Height="24" Background="{DynamicResource BorderBrush}" Margin="0,0,16,0"/>
                        
                        <!-- Help Button - Opens full help dialog -->
                        <Button Command="{Binding ShowHelpDialogCommand}"
                                ToolTip="Open Help (F1)"
                                Style="{DynamicResource IconButton}" Margin="0,0,8,0">
                            <iconPacks:PackIconMaterial Kind="HelpCircleOutline" Width="20" Height="20"/>
                        </Button>
                        
                        <!-- Theme Toggle Button -->
                        <Button Command="{Binding ToggleThemeCommand}"
                                ToolTip="{Binding ThemeButtonTooltip}"
                                Style="{DynamicResource IconButton}">
                            <iconPacks:PackIconMaterial Kind="{Binding ThemeIcon}" Width="20" Height="20"/>
                        </Button>
                    </StackPanel>
                </Grid>
                
                <!-- Step Indicator - Simplified -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                    <!-- Generate 7 step circles -->
                    <ItemsControl ItemsSource="{x:Static vm:MainViewModel.Steps}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <StackPanel Width="70">
                                        <Border Width="36" Height="36" CornerRadius="18" HorizontalAlignment="Center"
                                                Cursor="Hand">
                                            <Border.InputBindings>
                                                <MouseBinding MouseAction="LeftClick" 
                                                              Command="{Binding DataContext.GoToStepCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                              CommandParameter="{Binding Number}"/>
                                            </Border.InputBindings>
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="{DynamicResource StepPendingBrush}"/>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Number}" 
                                                       FontSize="14" FontWeight="Bold" Foreground="White"
                                                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <TextBlock Text="{Binding Name}" FontSize="10" 
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                    </StackPanel>
                                    <!-- Connector (hidden for last item) -->
                                    <Border Width="20" Height="2" 
                                            Background="{DynamicResource StepPendingBrush}"
                                            VerticalAlignment="Top" Margin="0,17,0,0">
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Number}" Value="7">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Border.Style>
                                    </Border>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- ========================================== -->
        <!-- MAIN CONTENT AREA -->
        <!-- ========================================== -->
        <Grid Grid.Row="1">
            <Border Margin="24">
                <Grid>
                    
                    <!-- ============================== -->
                    <!-- STEP 1: SELECT -->
                    <!-- ============================== -->
                    <ScrollViewer Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=1}"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel MaxWidth="800" HorizontalAlignment="Center">
                            <TextBlock Text="Step 1: Select Calibration Type" 
                                       Style="{DynamicResource SectionHeader}" Margin="0,0,0,24"/>
                            
                            <!-- Purpose Selection -->
                            <Border Style="{DynamicResource StepCard}">
                                <StackPanel>
                                    <TextBlock Text="Purpose of Exercise" Style="{DynamicResource SubsectionHeader}"/>
                                    <TextBlock Text="Choose whether you are calibrating a new sensor or verifying an existing calibration."
                                               Foreground="{DynamicResource TextSecondaryBrush}" TextWrapping="Wrap" Margin="0,0,0,16"/>
                                    
                                    <StackPanel Orientation="Horizontal">
                                        <RadioButton Content="Calibration" GroupName="Purpose" FontSize="14" Margin="0,0,32,0"
                                                     IsChecked="{Binding ProjectInfo.Purpose, Converter={StaticResource PurposeToBool}, ConverterParameter=Calibration}"/>
                                        <RadioButton Content="Verification" GroupName="Purpose" FontSize="14"
                                                     IsChecked="{Binding ProjectInfo.Purpose, Converter={StaticResource PurposeToBool}, ConverterParameter=Verification}"/>
                                    </StackPanel>
                                    
                                    <Border Background="{DynamicResource SurfaceBrush}" CornerRadius="6" Padding="16" Margin="0,16,0,0">
                                        <StackPanel>
                                            <TextBlock FontWeight="SemiBold" Foreground="{DynamicResource Subsea7OrangeBrush}" Text="Calibration Mode"/>
                                            <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,8,0,0"
                                                       Text="Reference system has C-O applied. System being calibrated has C-O set to 0. Determines the C-O value."/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Info Card -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="ℹ️ About This Module" Style="{DynamicResource SubsectionHeader}"/>
                                    <TextBlock TextWrapping="Wrap" Foreground="{DynamicResource TextSecondaryBrush}" LineHeight="24">
                                        This module performs MRU calibration and verification by inter-system comparison.
                                        It processes both Pitch and Roll data simultaneously, applying 3-sigma outlier rejection.
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                    
                    <!-- ============================== -->
                    <!-- STEP 2: LOAD DATA -->
                    <!-- ============================== -->
                    <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=2}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Text="Step 2: Load NPD File and Map Columns" 
                                   Style="{DynamicResource SectionHeader}" Margin="0,0,0,16"/>
                        
                        <!-- File Selection -->
                        <Border Grid.Row="1" Style="{DynamicResource StepCard}" Margin="0,0,0,16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Grid.ColumnSpan="2" Text="Source File" 
                                           Style="{DynamicResource SubsectionHeader}"/>
                                
                                <TextBox Grid.Row="1" Grid.Column="0" 
                                         Text="{Binding SelectedFilePath, Mode=OneWay}"
                                         Style="{DynamicResource ModernTextBox}"
                                         IsReadOnly="True" Margin="0,0,12,0"/>
                                
                                <Button Grid.Row="1" Grid.Column="1" Content="Browse..."
                                        Command="{Binding BrowseFileCommand}"
                                        Style="{DynamicResource PrimaryButton}"/>
                            </Grid>
                        </Border>
                        
                        <!-- Column Mapping -->
                        <Border Grid.Row="2" Style="{DynamicResource StepCard}">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <Grid Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <TextBlock Text="Column Mapping" Style="{DynamicResource SubsectionHeader}"/>
                                    <Button Grid.Column="1" Content="Auto-Detect" 
                                            Command="{Binding AutoDetectColumnsCommand}"
                                            Style="{DynamicResource SecondaryButton}" Padding="12,6"/>
                                </Grid>
                                
                                <!-- NaviPac Option -->
                                <CheckBox Grid.Row="1" Content="NaviPac Format (Date/Time split across columns)"
                                          IsChecked="{Binding HasDateTimeSplit}"
                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                          Margin="0,8,0,16"/>
                                
                                <!-- Column Dropdowns -->
                                <Grid Grid.Row="2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="24"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="16"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="16"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <!-- Time Column -->
                                    <StackPanel Grid.Row="0" Grid.ColumnSpan="3">
                                        <TextBlock Text="Time Column" Style="{DynamicResource FieldLabel}"/>
                                        <ComboBox ItemsSource="{Binding AvailableColumns}"
                                                  SelectedItem="{Binding SelectedTimeColumn}"
                                                  Style="{DynamicResource ModernComboBox}"/>
                                    </StackPanel>
                                    
                                    <!-- Pitch Section -->
                                    <TextBlock Grid.Row="2" Grid.ColumnSpan="3" Text="Pitch Columns" 
                                               FontWeight="SemiBold" Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                    
                                    <StackPanel Grid.Row="3" Grid.Column="0">
                                        <TextBlock Text="Reference Pitch" Style="{DynamicResource FieldLabel}"/>
                                        <ComboBox ItemsSource="{Binding AvailableColumns}"
                                                  SelectedItem="{Binding SelectedReferencePitchColumn}"
                                                  Style="{DynamicResource ModernComboBox}"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="3" Grid.Column="2">
                                        <TextBlock Text="Verified Pitch" Style="{DynamicResource FieldLabel}"/>
                                        <ComboBox ItemsSource="{Binding AvailableColumns}"
                                                  SelectedItem="{Binding SelectedVerifiedPitchColumn}"
                                                  Style="{DynamicResource ModernComboBox}"/>
                                    </StackPanel>
                                    
                                    <!-- Roll Section -->
                                    <TextBlock Grid.Row="5" Grid.ColumnSpan="3" Text="Roll Columns" 
                                               FontWeight="SemiBold" Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                    
                                    <StackPanel Grid.Row="6" Grid.Column="0">
                                        <TextBlock Text="Reference Roll" Style="{DynamicResource FieldLabel}"/>
                                        <ComboBox ItemsSource="{Binding AvailableColumns}"
                                                  SelectedItem="{Binding SelectedReferenceRollColumn}"
                                                  Style="{DynamicResource ModernComboBox}"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Row="6" Grid.Column="2">
                                        <TextBlock Text="Verified Roll" Style="{DynamicResource FieldLabel}"/>
                                        <ComboBox ItemsSource="{Binding AvailableColumns}"
                                                  SelectedItem="{Binding SelectedVerifiedRollColumn}"
                                                  Style="{DynamicResource ModernComboBox}"/>
                                    </StackPanel>
                                </Grid>
                            </Grid>
                        </Border>
                        
                        <!-- Import Button -->
                        <Button Grid.Row="3" Content="Import Data" 
                                Command="{Binding ImportDataCommand}"
                                Style="{DynamicResource PrimaryButton}"
                                HorizontalAlignment="Right" Margin="0,16,0,0"
                                IsEnabled="{Binding CanImportData}"/>
                    </Grid>
                    
                    <!-- ============================== -->
                    <!-- STEP 3: CONFIGURE -->
                    <!-- ============================== -->
                    <ScrollViewer Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=3}"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel MaxWidth="900" HorizontalAlignment="Center">
                            <TextBlock Text="Step 3: Project Information" 
                                       Style="{DynamicResource SectionHeader}" Margin="0,0,0,24"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="24"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Left Column - Project Details -->
                                <Border Grid.Column="0" Style="{DynamicResource StepCard}">
                                    <StackPanel>
                                        <TextBlock Text="Project Details" Style="{DynamicResource SubsectionHeader}"/>
                                        
                                        <TextBlock Text="Project Title" Style="{DynamicResource FieldLabel}" Margin="0,8,0,0"/>
                                        <TextBox Text="{Binding ProjectInfo.ProjectTitle, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"/>
                                        
                                        <TextBlock Text="Project Number" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                        <TextBox Text="{Binding ProjectInfo.ProjectNumber, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"/>
                                        
                                        <TextBlock Text="Vessel Name" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                        <TextBox Text="{Binding ProjectInfo.VesselName, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"/>
                                        
                                        <TextBlock Text="Location" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                        <TextBox Text="{Binding ProjectInfo.Location, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"/>
                                        
                                        <TextBlock Text="Latitude" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                        <TextBox Text="{Binding ProjectInfo.Latitude, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Right Column - Personnel & Systems -->
                                <StackPanel Grid.Column="2">
                                    <!-- Personnel -->
                                    <Border Style="{DynamicResource StepCard}">
                                        <StackPanel>
                                            <TextBlock Text="Personnel" Style="{DynamicResource SubsectionHeader}"/>
                                            
                                            <TextBlock Text="Observed By" Style="{DynamicResource FieldLabel}" Margin="0,8,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.ObservedBy, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                            
                                            <TextBlock Text="Checked By" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.CheckedBy, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Reference MRU -->
                                    <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Reference MRU System" Style="{DynamicResource SubsectionHeader}"/>
                                            
                                            <TextBlock Text="Model" Style="{DynamicResource FieldLabel}" Margin="0,8,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.ReferenceSystem.Model, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                            
                                            <TextBlock Text="Serial Number" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.ReferenceSystem.SerialNumber, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Verified MRU -->
                                    <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                        <StackPanel>
                                            <TextBlock Text="Verified MRU System" Style="{DynamicResource SubsectionHeader}"/>
                                            
                                            <TextBlock Text="Model" Style="{DynamicResource FieldLabel}" Margin="0,8,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.VerifiedSystem.Model, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                            
                                            <TextBlock Text="Serial Number" Style="{DynamicResource FieldLabel}" Margin="0,12,0,0"/>
                                            <TextBox Text="{Binding ProjectInfo.VerifiedSystem.SerialNumber, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Data Summary -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Pitch Data" Style="{DynamicResource SubsectionHeader}"/>
                                        <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                            <Run Text="Points loaded: "/>
                                            <Run Text="{Binding PitchData.PointCount, Mode=OneWay}" 
                                                 Foreground="{DynamicResource Subsea7OrangeBrush}" FontWeight="Bold"/>
                                        </TextBlock>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1">
                                        <TextBlock Text="Roll Data" Style="{DynamicResource SubsectionHeader}"/>
                                        <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                            <Run Text="Points loaded: "/>
                                            <Run Text="{Binding RollData.PointCount, Mode=OneWay}" 
                                                 Foreground="{DynamicResource Subsea7OrangeBrush}" FontWeight="Bold"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            
                            <!-- Time Range Filter -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                <StackPanel>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Grid.Column="0" Text="Time Range Filter" Style="{DynamicResource SubsectionHeader}"/>
                                        
                                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                                            <CheckBox Content="Enable Filter" 
                                                      IsChecked="{Binding UseTimeFilter}" 
                                                      VerticalAlignment="Center"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            <Button Content="Clear" 
                                                    Command="{Binding ClearTimeFilterCommand}"
                                                    Style="{DynamicResource SecondaryButton}" 
                                                    Padding="12,4" Margin="12,0,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                    
                                    <Grid Margin="0,12,0,0" IsEnabled="{Binding UseTimeFilter}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="24"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="24"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Start Time" Style="{DynamicResource FieldLabel}"/>
                                            <mah:DateTimePicker SelectedDateTime="{Binding FilterStartTime}"
                                                                 IsEnabled="{Binding UseTimeFilter}"
                                                                 Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="End Time" Style="{DynamicResource FieldLabel}"/>
                                            <mah:DateTimePicker SelectedDateTime="{Binding FilterEndTime}"
                                                                 IsEnabled="{Binding UseTimeFilter}"
                                                                 Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        </StackPanel>
                                        
                                        <Button Grid.Column="4" Content="Apply" 
                                                Command="{Binding ApplyTimeFilterCommand}"
                                                Style="{DynamicResource AccentButton}" 
                                                Padding="16,8" VerticalAlignment="Bottom"/>
                                    </Grid>
                                    
                                    <TextBlock Margin="0,8,0,0" Foreground="{DynamicResource TextSecondaryBrush}">
                                        <Run Text="Data range: "/>
                                        <Run Text="{Binding DataStartTime, StringFormat='yyyy-MM-dd HH:mm:ss', FallbackValue='-'}" 
                                             Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <Run Text=" to "/>
                                        <Run Text="{Binding DataEndTime, StringFormat='yyyy-MM-dd HH:mm:ss', FallbackValue='-'}" 
                                             Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <Run Text=" | Selected: "/>
                                        <Run Text="{Binding FilteredDataPoints, Mode=OneWay}" 
                                             Foreground="{DynamicResource Subsea7OrangeBrush}" FontWeight="Bold"/>
                                        <Run Text=" of "/>
                                        <Run Text="{Binding TotalDataPoints, Mode=OneWay}"/>
                                        <Run Text=" points"/>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                            
                            <!-- Data Preview Grid -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                <StackPanel>
                                    <TextBlock Text="Data Preview" Style="{DynamicResource SubsectionHeader}" Margin="0,0,0,12"/>
                                    
                                    <DataGrid ItemsSource="{Binding LoadedDataPreview}" 
                                              MaxHeight="300"
                                              AutoGenerateColumns="False"
                                              IsReadOnly="True"
                                              CanUserSortColumns="True"
                                              GridLinesVisibility="Horizontal"
                                              HeadersVisibility="Column"
                                              Background="{DynamicResource CardBrush}"
                                              Foreground="{DynamicResource TextPrimaryBrush}"
                                              BorderBrush="{DynamicResource BorderBrush}"
                                              HorizontalGridLinesBrush="{DynamicResource BorderBrush}">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="#" Binding="{Binding Index}" Width="50"/>
                                            <DataGridTextColumn Header="Timestamp" Binding="{Binding TimestampDisplay}" Width="160"/>
                                            <DataGridTextColumn Header="Ref Pitch" Binding="{Binding ReferencePitchDisplay}" Width="90"/>
                                            <DataGridTextColumn Header="Ver Pitch" Binding="{Binding VerifiedPitchDisplay}" Width="90"/>
                                            <DataGridTextColumn Header="Pitch Δ" Binding="{Binding PitchDiffDisplay}" Width="80"/>
                                            <DataGridTextColumn Header="Ref Roll" Binding="{Binding ReferenceRollDisplay}" Width="90"/>
                                            <DataGridTextColumn Header="Ver Roll" Binding="{Binding VerifiedRollDisplay}" Width="90"/>
                                            <DataGridTextColumn Header="Roll Δ" Binding="{Binding RollDiffDisplay}" Width="80"/>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                    
                                    <TextBlock Text="Showing first 100 rows of loaded data" 
                                               Style="{DynamicResource FieldLabel}" 
                                               Margin="0,8,0,0"
                                               Visibility="{Binding LoadedDataPreview.Count, Converter={StaticResource NullToVisibilityConverter}}"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                    
                    <!-- ============================== -->
                    <!-- STEP 4: PROCESS -->
                    <!-- ============================== -->
                    <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=4}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Text="Step 4: Process Calibration Data" 
                                   Style="{DynamicResource SectionHeader}" Margin="0,0,0,16"/>
                        
                        <!-- Processing Controls -->
                        <Border Grid.Row="1" Style="{DynamicResource StepCard}" Margin="0,0,0,16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Rejection Threshold:" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="0,0,12,0"/>
                                    <TextBox Text="{Binding RejectionThreshold, StringFormat=F1}"
                                             Style="{DynamicResource ModernTextBox}"
                                             Width="60" TextAlignment="Center"/>
                                    <TextBlock Text="σ (sigma)" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="8,0,0,0"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="2" Orientation="Horizontal">
                                    <Button Content="Process Data" 
                                            Command="{Binding ProcessDataCommand}"
                                            Style="{DynamicResource PrimaryButton}"
                                            Margin="0,0,12,0"/>
                                    <Button Content="Reprocess" 
                                            Command="{Binding ReprocessCommand}"
                                            Style="{DynamicResource SecondaryButton}"
                                            IsEnabled="{Binding IsProcessed}"/>
                                </StackPanel>
                            </Grid>
                        </Border>
                        
                        <!-- Results and Log -->
                        <Grid Grid.Row="2">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="16"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <!-- Results Summary -->
                            <Border Grid.Column="0" Style="{DynamicResource StepCard}">
                                <StackPanel>
                                    <TextBlock Text="Results Summary" Style="{DynamicResource SubsectionHeader}"/>
                                    
                                    <!-- Pitch Results -->
                                    <Border Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="6" Padding="12" Margin="0,8,0,0"
                                            Visibility="{Binding PitchData.IsLoaded, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel>
                                            <TextBlock Text="PITCH" FontWeight="Bold" 
                                                       Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                            <TextBlock Text="{Binding PitchStatsSummary}" 
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       Margin="0,4,0,0"/>
                                            
                                            <!-- Detailed stats when processed -->
                                            <Grid Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}"
                                                  Margin="0,8,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Mean C-O" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Text="{Binding PitchData.Statistics.MeanCO_Accepted, StringFormat=F4}" 
                                                               Style="{DynamicResource StatValue}" FontSize="18"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Std Dev" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Text="{Binding PitchData.Statistics.StdDevCO_Accepted, StringFormat=F4}" 
                                                               Style="{DynamicResource StatValue}" FontSize="18"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="Rejected" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Style="{DynamicResource StatValue}" FontSize="18">
                                                        <Run Text="{Binding PitchData.Statistics.RejectedCount, Mode=OneWay}"/>
                                                        <Run Text=" (" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                        <Run Text="{Binding PitchData.Statistics.RejectionPercentage, StringFormat=F1, Mode=OneWay}" 
                                                             Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                        <Run Text="%)" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                    
                                    <!-- Roll Results -->
                                    <Border Background="{DynamicResource SurfaceBrush}" 
                                            CornerRadius="6" Padding="12" Margin="0,12,0,0"
                                            Visibility="{Binding RollData.IsLoaded, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel>
                                            <TextBlock Text="ROLL" FontWeight="Bold" 
                                                       Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                            <TextBlock Text="{Binding RollStatsSummary}" 
                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                       Margin="0,4,0,0"/>
                                            
                                            <!-- Detailed stats when processed -->
                                            <Grid Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}"
                                                  Margin="0,8,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Mean C-O" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Text="{Binding RollData.Statistics.MeanCO_Accepted, StringFormat=F4}" 
                                                               Style="{DynamicResource StatValue}" FontSize="18"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Std Dev" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Text="{Binding RollData.Statistics.StdDevCO_Accepted, StringFormat=F4}" 
                                                               Style="{DynamicResource StatValue}" FontSize="18"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="Rejected" Style="{DynamicResource StatLabel}"/>
                                                    <TextBlock Style="{DynamicResource StatValue}" FontSize="18">
                                                        <Run Text="{Binding RollData.Statistics.RejectedCount, Mode=OneWay}"/>
                                                        <Run Text=" (" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                        <Run Text="{Binding RollData.Statistics.RejectionPercentage, StringFormat=F1, Mode=OneWay}" 
                                                             Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                        <Run Text="%)" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Processing Log -->
                            <Border Grid.Column="2" Style="{DynamicResource StepCard}">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <TextBlock Grid.Row="0" Text="Processing Log" Style="{DynamicResource SubsectionHeader}"/>
                                    
                                    <ListBox Grid.Row="1" 
                                             ItemsSource="{Binding ProcessingLog}"
                                             Background="{DynamicResource SurfaceBrush}"
                                             BorderThickness="0"
                                             Foreground="{DynamicResource TextSecondaryBrush}"
                                             FontFamily="Consolas"
                                             FontSize="11"
                                             Margin="0,8,0,0"/>
                                </Grid>
                            </Border>
                        </Grid>
                        
                        <!-- Progress Bar -->
                        <StackPanel Grid.Row="3" Margin="0,16,0,0"
                                    Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}">
                            <ProgressBar Value="{Binding ProcessingProgress}" 
                                         Maximum="100" Height="8"
                                         Style="{DynamicResource ModernProgressBar}"/>
                            <TextBlock Text="{Binding BusyMessage}" 
                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                       HorizontalAlignment="Center" Margin="0,8,0,0"/>
                        </StackPanel>
                    </Grid>
                    
                    <!-- ============================== -->
                    <!-- STEP 5: ANALYZE -->
                    <!-- ============================== -->
                    <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=5}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Header -->
                        <TextBlock Grid.Row="0" Text="Step 5: Analysis &amp; Charts" 
                                   Style="{DynamicResource SectionHeader}" Margin="0,0,0,12"/>
                        
                        <!-- Toolbar -->
                        <Border Grid.Row="1" Style="{DynamicResource StepCard}" Padding="12" Margin="0,0,0,16">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Color Scheme -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="Color Scheme:" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <ComboBox Width="160" 
                                              ItemsSource="{Binding AvailableColorSchemes}"
                                              SelectedItem="{Binding SelectedColorScheme}"/>
                                    <Button Content="Reset" Command="{Binding ResetColorsCommand}"
                                            Style="{DynamicResource SecondaryButton}" 
                                            Padding="12,6" Margin="8,0,0,0"/>
                                </StackPanel>
                                
                                <!-- Spacer -->
                                <Border Grid.Column="2"/>
                                
                                <!-- Export Buttons -->
                                <Button Grid.Column="3" Command="{Binding ExportChartsPngCommand}"
                                        Style="{DynamicResource SecondaryButton}" 
                                        Padding="12,6" Margin="0,0,8,0">
                                    <StackPanel Orientation="Horizontal">
                                        <iconPacks:PackIconMaterial Kind="ImageOutline" Width="16" Height="16" 
                                                                    VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="Export PNG" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                
                                <Button Grid.Column="4" Command="{Binding ExportChartsPdfCommand}"
                                        Style="{DynamicResource SecondaryButton}" 
                                        Padding="12,6" Margin="0,0,8,0">
                                    <StackPanel Orientation="Horizontal">
                                        <iconPacks:PackIconMaterial Kind="FilePdfBox" Width="16" Height="16" 
                                                                    VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <TextBlock Text="Export PDF" VerticalAlignment="Center"/>
                                    </StackPanel>
                                </Button>
                                
                                <Button Grid.Column="5" Content="Refresh Charts" 
                                        Command="{Binding RefreshChartsCommand}"
                                        Style="{DynamicResource PrimaryButton}" Padding="16,6"/>
                            </Grid>
                        </Border>
                        
                        <!-- Chart Tabs -->
                        <TabControl Grid.Row="2" 
                                    SelectedIndex="{Binding SelectedChartTab}"
                                    Background="Transparent"
                                    BorderThickness="0">
                            <TabControl.Resources>
                                <Style TargetType="TabItem">
                                    <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                                    <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
                                    <Setter Property="Padding" Value="12,8"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Foreground" Value="{DynamicResource Subsea7OrangeBrush}"/>
                                            <Setter Property="FontWeight" Value="SemiBold"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </TabControl.Resources>
                            
                            <!-- Pitch Calibration Tab -->
                            <TabItem Header="📊 Pitch Cal" 
                                     IsEnabled="{Binding PitchData.IsProcessed}">
                                <Grid Margin="0,16,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <Border Grid.Row="0" Style="{DynamicResource StepCard}" Padding="0">
                                        <oxy:PlotView Model="{Binding PitchCalibrationChart}"
                                                      Background="Transparent"/>
                                    </Border>
                                    
                                    <!-- Enhanced Stats Summary -->
                                    <Border Grid.Row="1" Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                                <TextBlock Text="Mean C-O" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.MeanCO_Accepted, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                                <TextBlock Text="Std Dev" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.StdDevCO_Accepted, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                                <TextBlock Text="RMSE" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.RMSE, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                                <TextBlock Text="95% CI" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.ConfidenceInterval95Display}" 
                                                           Style="{DynamicResource StatValue}" FontSize="11"/>
                                                <TextBlock Text="range" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                                                <TextBlock Text="Normality" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.NormalityDisplay}" 
                                                           Style="{DynamicResource StatValue}" FontSize="11"/>
                                                <TextBlock Text="Shapiro-Wilk" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Median" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.Median, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="6" HorizontalAlignment="Center">
                                                <TextBlock Text="Accepted" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Style="{DynamicResource StatValue}">
                                                    <Run Text="{Binding PitchData.Statistics.AcceptedCount, Mode=OneWay}"/>
                                                    <Run Text="/" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <Run Text="{Binding PitchData.Statistics.TotalObservations, Mode=OneWay}" 
                                                         FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </TextBlock>
                                                <TextBlock Text="points" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="7" HorizontalAlignment="Center">
                                                <TextBlock Text="Rejected" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding PitchData.Statistics.RejectedCount}" 
                                                           Style="{DynamicResource StatValue}"
                                                           Foreground="{DynamicResource ErrorBrush}"/>
                                                <TextBlock Style="{DynamicResource StatUnit}">
                                                    <Run Text="("/>
                                                    <Run Text="{Binding PitchData.Statistics.RejectionPercentage, StringFormat=F1, Mode=OneWay}"/>
                                                    <Run Text="%)"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Roll Calibration Tab -->
                            <TabItem Header="📊 Roll Cal"
                                     IsEnabled="{Binding RollData.IsProcessed}">
                                <Grid Margin="0,16,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    
                                    <Border Grid.Row="0" Style="{DynamicResource StepCard}" Padding="0">
                                        <oxy:PlotView Model="{Binding RollCalibrationChart}"
                                                      Background="Transparent"/>
                                    </Border>
                                    
                                    <!-- Enhanced Stats Summary -->
                                    <Border Grid.Row="1" Style="{DynamicResource StepCard}" Margin="0,16,0,0">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                                <TextBlock Text="Mean C-O" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.MeanCO_Accepted, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                                <TextBlock Text="Std Dev" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.StdDevCO_Accepted, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                                <TextBlock Text="RMSE" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.RMSE, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="3" HorizontalAlignment="Center">
                                                <TextBlock Text="95% CI" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.ConfidenceInterval95Display}" 
                                                           Style="{DynamicResource StatValue}" FontSize="11"/>
                                                <TextBlock Text="range" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="4" HorizontalAlignment="Center">
                                                <TextBlock Text="Normality" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.NormalityDisplay}" 
                                                           Style="{DynamicResource StatValue}" FontSize="11"/>
                                                <TextBlock Text="Shapiro-Wilk" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="5" HorizontalAlignment="Center">
                                                <TextBlock Text="Median" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.Median, StringFormat=F4}" 
                                                           Style="{DynamicResource StatValue}"/>
                                                <TextBlock Text="degrees" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="6" HorizontalAlignment="Center">
                                                <TextBlock Text="Accepted" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Style="{DynamicResource StatValue}">
                                                    <Run Text="{Binding RollData.Statistics.AcceptedCount, Mode=OneWay}"/>
                                                    <Run Text="/" FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                    <Run Text="{Binding RollData.Statistics.TotalObservations, Mode=OneWay}" 
                                                         FontSize="12" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                                </TextBlock>
                                                <TextBlock Text="points" Style="{DynamicResource StatUnit}"/>
                                            </StackPanel>
                                            
                                            <StackPanel Grid.Column="7" HorizontalAlignment="Center">
                                                <TextBlock Text="Rejected" Style="{DynamicResource StatLabel}"/>
                                                <TextBlock Text="{Binding RollData.Statistics.RejectedCount}" 
                                                           Style="{DynamicResource StatValue}"
                                                           Foreground="{DynamicResource ErrorBrush}"/>
                                                <TextBlock Style="{DynamicResource StatUnit}">
                                                    <Run Text="("/>
                                                    <Run Text="{Binding RollData.Statistics.RejectionPercentage, StringFormat=F1, Mode=OneWay}"/>
                                                    <Run Text="%)"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- C-O Analysis Tab -->
                            <TabItem Header="📈 C-O Analysis">
                                <Grid Margin="0,16,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Pitch C-O -->
                                    <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Pitch C-O" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding PitchCOChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Roll C-O -->
                                    <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Roll C-O" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding RollCOChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Distribution Tab -->
                            <TabItem Header="📊 Distribution">
                                <Grid Margin="0,16,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Pitch Histogram -->
                                    <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Pitch C-O Distribution" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding PitchHistogram}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                    
                                    <!-- Roll Histogram -->
                                    <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Roll C-O Distribution" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding RollHistogram}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Q-Q Plot Tab (NEW) -->
                            <TabItem Header="📉 Q-Q Plot">
                                <Grid Margin="0,16,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Pitch Q-Q Plot (Normality Check)" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding PitchQQChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                    
                                    <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Roll Q-Q Plot (Normality Check)" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding RollQQChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Autocorrelation Tab (NEW) -->
                            <TabItem Header="🔄 Autocorr">
                                <Grid Margin="0,16,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Pitch Autocorrelation (Pattern Detection)" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding PitchAutocorrelationChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                    
                                    <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Roll Autocorrelation (Pattern Detection)" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding RollAutocorrelationChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Before/After Tab (NEW) -->
                            <TabItem Header="⚖️ Before/After">
                                <Grid Margin="0,16,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="16"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Pitch Before/After Rejection" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding PitchBeforeAfterChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                    
                                    <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                            Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                            </Grid.RowDefinitions>
                                            
                                            <TextBlock Grid.Row="0" Text="Roll Before/After Rejection" 
                                                       Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                            <oxy:PlotView Grid.Row="1" Model="{Binding RollBeforeAfterChart}"
                                                          Background="Transparent"/>
                                        </Grid>
                                    </Border>
                                </Grid>
                            </TabItem>
                            
                            <!-- Combined Charts Tab -->
                            <TabItem Header="📋 Combined">
                                <Grid Margin="0,16,0,0">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="*"/>
                                        <RowDefinition Height="16"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <Grid Grid.Row="0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="16"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                
                                                <TextBlock Grid.Row="0" Text="Box Plot Comparison" 
                                                           Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                                <oxy:PlotView Grid.Row="1" Model="{Binding BoxPlotChart}"
                                                              Background="Transparent"/>
                                            </Grid>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                
                                                <TextBlock Grid.Row="0" Text="Pitch vs Roll Correlation" 
                                                           Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                                <oxy:PlotView Grid.Row="1" Model="{Binding PitchRollCorrelationChart}"
                                                              Background="Transparent"/>
                                            </Grid>
                                        </Border>
                                    </Grid>
                                    
                                    <Grid Grid.Row="2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="16"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{DynamicResource StepCard}" Padding="0"
                                                Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                
                                                <TextBlock Grid.Row="0" Text="Pitch Trend Analysis" 
                                                           Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                                <oxy:PlotView Grid.Row="1" Model="{Binding PitchTrendChart}"
                                                              Background="Transparent"/>
                                            </Grid>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{DynamicResource StepCard}" Padding="0"
                                                Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                </Grid.RowDefinitions>
                                                
                                                <TextBlock Grid.Row="0" Text="Roll Trend Analysis" 
                                                           Style="{DynamicResource SubsectionHeader}" Margin="12,8,0,0"/>
                                                <oxy:PlotView Grid.Row="1" Model="{Binding RollTrendChart}"
                                                              Background="Transparent"/>
                                            </Grid>
                                        </Border>
                                    </Grid>
                                </Grid>
                            </TabItem>
                        </TabControl>
                    </Grid>
                    
                    <!-- ============================== -->
                    <!-- STEP 6: VERIFY & SIGN-OFF -->
                    <!-- ============================== -->
                    <ScrollViewer Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=6}"
                                  VerticalScrollBarVisibility="Auto">
                        <StackPanel>
                            <TextBlock Text="Step 6: Verify &amp; Sign-off" 
                                       Style="{DynamicResource SectionHeader}" Margin="0,0,0,16"/>
                            
                            <!-- QC Checklist -->
                            <Border Style="{DynamicResource StepCard}">
                                <StackPanel>
                                    <TextBlock Text="QC Checklist" Style="{DynamicResource SubsectionHeader}"/>
                                    <TextBlock Text="Complete all checks before signing off:" 
                                               Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,0,12"/>
                                    
                                    <CheckBox IsChecked="{Binding QcStatsWithinRange}" Margin="0,8,0,0">
                                        <TextBlock>
                                            <Run Text="Statistics within acceptable range" FontWeight="SemiBold"/>
                                            <LineBreak/>
                                            <Run Text="Mean C-O and Standard Deviation are reasonable for sensor type" 
                                                 Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        </TextBlock>
                                    </CheckBox>
                                    
                                    <CheckBox IsChecked="{Binding QcRejectionReasonable}" Margin="0,12,0,0">
                                        <TextBlock>
                                            <Run Text="Rejection percentage is reasonable" FontWeight="SemiBold"/>
                                            <LineBreak/>
                                            <Run Text="Typically less than 5% rejection rate expected" 
                                                 Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        </TextBlock>
                                    </CheckBox>
                                    
                                    <CheckBox IsChecked="{Binding QcNoDrift}" Margin="0,12,0,0">
                                        <TextBlock>
                                            <Run Text="No systematic drift observed" FontWeight="SemiBold"/>
                                            <LineBreak/>
                                            <Run Text="C-O values stable over time, no trending" 
                                                 Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        </TextBlock>
                                    </CheckBox>
                                    
                                    <CheckBox IsChecked="{Binding QcDataQuality}" Margin="0,12,0,0">
                                        <TextBlock>
                                            <Run Text="Data quality verified" FontWeight="SemiBold"/>
                                            <LineBreak/>
                                            <Run Text="Sufficient observations, clean data, proper column mapping" 
                                                 Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        </TextBlock>
                                    </CheckBox>
                                    
                                    <!-- QC Status -->
                                    <Border Margin="0,16,0,0" CornerRadius="6" Padding="12"
                                            Background="{Binding AllQcPassed, Converter={StaticResource BoolToColorConverter}}">
                                        <TextBlock HorizontalAlignment="Center" FontWeight="SemiBold"
                                                   Foreground="White">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Text" Value="Complete all QC checks to enable sign-off"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding AllQcPassed}" Value="True">
                                                            <Setter Property="Text" Value="✓ All QC checks passed - Ready to sign off"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Border>
                                </StackPanel>
                            </Border>
                            
                            <!-- Pitch Sign-off -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0"
                                    Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="PITCH CALIBRATION" Style="{DynamicResource SubsectionHeader}"/>
                                        <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                            <Run Text="C-O Value: "/>
                                            <Run Text="{Binding PitchData.Statistics.MeanCO_Accepted, StringFormat=F4, Mode=OneWay}" 
                                                 FontWeight="Bold" Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                            <Run Text="°"/>
                                        </TextBlock>
                                        
                                        <Grid Margin="0,12,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="150"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="150"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <TextBlock Grid.Column="0" Text="Surveyor:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBox Grid.Column="1" Text="{Binding PitchData.SurveyorInitials, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                            <TextBlock Grid.Column="2" Text="Witness:" VerticalAlignment="Center" Margin="16,0,8,0"/>
                                            <TextBox Grid.Column="3" Text="{Binding PitchData.WitnessInitials, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                        </Grid>
                                        
                                        <TextBox Margin="0,8,0,0" 
                                                 Text="{Binding PitchData.Comments, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"
                                                 mah:TextBoxHelper.Watermark="Comments (optional)"
                                                 Height="60" AcceptsReturn="True" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="24,0,0,0">
                                        <Button Content="ACCEPT" Width="120"
                                                Command="{Binding AcceptPitchCommand}"
                                                Style="{DynamicResource SuccessButton}"
                                                Margin="0,0,0,8"/>
                                        <Button Content="REJECT" Width="120"
                                                Command="{Binding RejectPitchCommand}"
                                                Style="{DynamicResource DangerButton}"/>
                                        
                                        <!-- Decision Display -->
                                        <TextBlock Margin="0,12,0,0" HorizontalAlignment="Center" FontWeight="Bold" FontSize="14">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding PitchData.Decision}" Value="Accepted">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Text" Value="✓ ACCEPTED"/>
                                                            <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding PitchData.Decision}" Value="Rejected">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Text" Value="✗ REJECTED"/>
                                                            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </Border>
                            
                            <!-- Roll Sign-off -->
                            <Border Style="{DynamicResource StepCard}" Margin="0,16,0,0"
                                    Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="ROLL CALIBRATION" Style="{DynamicResource SubsectionHeader}"/>
                                        <TextBlock Foreground="{DynamicResource TextSecondaryBrush}">
                                            <Run Text="C-O Value: "/>
                                            <Run Text="{Binding RollData.Statistics.MeanCO_Accepted, StringFormat=F4, Mode=OneWay}" 
                                                 FontWeight="Bold" Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                            <Run Text="°"/>
                                        </TextBlock>
                                        
                                        <Grid Margin="0,12,0,0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="150"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="150"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <TextBlock Grid.Column="0" Text="Surveyor:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBox Grid.Column="1" Text="{Binding RollData.SurveyorInitials, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                            <TextBlock Grid.Column="2" Text="Witness:" VerticalAlignment="Center" Margin="16,0,8,0"/>
                                            <TextBox Grid.Column="3" Text="{Binding RollData.WitnessInitials, UpdateSourceTrigger=PropertyChanged}"
                                                     Style="{DynamicResource ModernTextBox}"/>
                                        </Grid>
                                        
                                        <TextBox Margin="0,8,0,0" 
                                                 Text="{Binding RollData.Comments, UpdateSourceTrigger=PropertyChanged}"
                                                 Style="{DynamicResource ModernTextBox}"
                                                 mah:TextBoxHelper.Watermark="Comments (optional)"
                                                 Height="60" AcceptsReturn="True" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="24,0,0,0">
                                        <Button Content="ACCEPT" Width="120"
                                                Command="{Binding AcceptRollCommand}"
                                                Style="{DynamicResource SuccessButton}"
                                                Margin="0,0,0,8"/>
                                        <Button Content="REJECT" Width="120"
                                                Command="{Binding RejectRollCommand}"
                                                Style="{DynamicResource DangerButton}"/>
                                        
                                        <!-- Decision Display -->
                                        <TextBlock Margin="0,12,0,0" HorizontalAlignment="Center" FontWeight="Bold" FontSize="14">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding RollData.Decision}" Value="Accepted">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Text" Value="✓ ACCEPTED"/>
                                                            <Setter Property="Foreground" Value="{DynamicResource SuccessBrush}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding RollData.Decision}" Value="Rejected">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="Text" Value="✗ REJECTED"/>
                                                            <Setter Property="Foreground" Value="{DynamicResource ErrorBrush}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                    
                    <!-- ============================== -->
                    <!-- STEP 7: EXPORT -->
                    <!-- ============================== -->
                    <Grid Visibility="{Binding CurrentStep, Converter={StaticResource StepToVisibility}, ConverterParameter=7}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <TextBlock Grid.Row="0" Text="Step 7: Export Reports" 
                                   Style="{DynamicResource SectionHeader}" Margin="0,0,0,16"/>
                        
                        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center">
                            <!-- Export Status -->
                            <Border Background="{DynamicResource SurfaceBrush}" 
                                    CornerRadius="12" Padding="40,30" MinWidth="500">
                                <StackPanel HorizontalAlignment="Center">
                                    <iconPacks:PackIconMaterial Kind="FileExport" 
                                                                Width="64" Height="64"
                                                                Foreground="{DynamicResource Subsea7OrangeBrush}"
                                                                HorizontalAlignment="Center"/>
                                    
                                    <TextBlock Text="Calibration Complete" 
                                               FontSize="20" FontWeight="SemiBold"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               HorizontalAlignment="Center" Margin="0,16,0,8"/>
                                    
                                    <TextBlock Text="Generate your reports and data exports" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               HorizontalAlignment="Center" Margin="0,0,0,24"/>
                                    
                                    <!-- Export Buttons -->
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Command="{Binding ExportPdfCommand}" Margin="8,0"
                                                Style="{DynamicResource PrimaryButton}" Width="150">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="FilePdfBox" Margin="0,0,8,0"/>
                                                <TextBlock Text="PDF Report"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Command="{Binding ExportExcelCommand}" Margin="8,0"
                                                Style="{DynamicResource SecondaryButton}" Width="150">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="MicrosoftExcel" Margin="0,0,8,0"/>
                                                <TextBlock Text="Excel Data"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Command="{Binding ExportAllCommand}" Margin="8,0"
                                                Style="{DynamicResource AccentButton}" Width="150">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="FolderDownload" Margin="0,0,8,0"/>
                                                <TextBlock Text="Export All"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Command="{Binding GenerateCertificateCommand}" Margin="8,0"
                                                Style="{DynamicResource AccentButton}" Width="150"
                                                ToolTip="Generate verification certificate (Fathom OS)">
                                            <StackPanel Orientation="Horizontal">
                                                <iconPacks:PackIconMaterial Kind="Certificate" Margin="0,0,8,0"/>
                                                <TextBlock Text="Certificate"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                    
                                    <!-- Not Ready Warning -->
                                    <TextBlock Margin="0,24,0,0" 
                                               Foreground="{DynamicResource WarningBrush}"
                                               HorizontalAlignment="Center"
                                               Visibility="{Binding CanExport, Converter={StaticResource InverseBoolToVisibility}}">
                                        <iconPacks:PackIconMaterial Kind="AlertCircle" Width="14" Height="14" 
                                                                    VerticalAlignment="Center" Margin="0,0,6,0"/>
                                        <Run Text="Complete sign-off in Step 6 before exporting"/>
                                    </TextBlock>
                                    
                                    <!-- Last Export Path -->
                                    <TextBlock Margin="0,16,0,0" 
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               HorizontalAlignment="Center" FontSize="11"
                                               Visibility="{Binding LastExportPath, Converter={StaticResource NullToVisibilityConverter}}">
                                        <Run Text="Last export: "/>
                                        <Run Text="{Binding LastExportPath, Mode=OneWay}"/>
                                    </TextBlock>
                                </StackPanel>
                            </Border>
                            
                            <!-- Summary Cards -->
                            <Grid Margin="0,24,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="16"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Pitch Summary -->
                                <Border Grid.Column="0" Style="{DynamicResource StepCard}"
                                        Visibility="{Binding PitchData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                    <StackPanel>
                                        <TextBlock Text="PITCH" FontWeight="Bold" 
                                                   Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                        <TextBlock Margin="0,8,0,0">
                                            <Run Text="C-O: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Run Text="{Binding PitchData.Statistics.MeanCO_Accepted, StringFormat=F4, Mode=OneWay}" FontWeight="Bold"/>
                                            <Run Text="°"/>
                                        </TextBlock>
                                        <TextBlock>
                                            <Run Text="Decision: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Run Text="{Binding PitchData.Decision, Mode=OneWay}" FontWeight="Bold"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Roll Summary -->
                                <Border Grid.Column="2" Style="{DynamicResource StepCard}"
                                        Visibility="{Binding RollData.IsProcessed, Converter={StaticResource BoolToVisibility}}">
                                    <StackPanel>
                                        <TextBlock Text="ROLL" FontWeight="Bold" 
                                                   Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                                        <TextBlock Margin="0,8,0,0">
                                            <Run Text="C-O: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Run Text="{Binding RollData.Statistics.MeanCO_Accepted, StringFormat=F4, Mode=OneWay}" FontWeight="Bold"/>
                                            <Run Text="°"/>
                                        </TextBlock>
                                        <TextBlock>
                                            <Run Text="Decision: " Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            <Run Text="{Binding RollData.Decision, Mode=OneWay}" FontWeight="Bold"/>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
            
            <!-- Busy Overlay -->
            <Border Background="#80000000" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibility}}">
                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <mah:ProgressRing IsActive="{Binding IsBusy}" Width="60" Height="60"
                                      Foreground="{DynamicResource Subsea7OrangeBrush}"/>
                    <TextBlock Text="{Binding BusyMessage}" Foreground="White" FontSize="16"
                               Margin="0,16,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- ========================================== -->
        <!-- FOOTER - Navigation & Status -->
        <!-- ========================================== -->
        <Border Grid.Row="2" 
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0" Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" Text="{Binding StatusMessage}"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           VerticalAlignment="Center" TextTrimming="CharacterEllipsis"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="← Previous" Command="{Binding PreviousStepCommand}"
                            Style="{DynamicResource SecondaryButton}" Margin="0,0,16,0"/>
                    <Button Command="{Binding NextStepCommand}" Style="{DynamicResource PrimaryButton}">
                        <TextBlock>
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Text" Value="Next →"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding CurrentStep}" Value="7">
                                            <Setter Property="Text" Value="Finish ✓"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Button>
                </StackPanel>
                
                <TextBlock Grid.Column="2" HorizontalAlignment="Right" VerticalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}">
                    <Run Text="Step"/>
                    <Run Text="{Binding CurrentStep, Mode=OneWay}" 
                         Foreground="{DynamicResource Subsea7OrangeBrush}" FontWeight="Bold"/>
                    <Run Text="of 7"/>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</mah:MetroWindow>
